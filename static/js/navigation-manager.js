/**
 * ÂØºËà™ÁÆ°ÁêÜÂô®
 * Â§ÑÁêÜÊµèËßàÂô®ÂØºËà™„ÄÅÂéÜÂè≤ËÆ∞ÂΩïÂíåÈ°µÈù¢Áä∂ÊÄÅÁÆ°ÁêÜ
 */

class NavigationManager {
    constructor() {
        this.navigationState = {
            isNavigating: false,
            currentUrl: window.location.href,
            previousUrl: null,
            navigationStartTime: null
        };
        
        this.init();
    }

    init() {
        console.log('üß≠ ÂØºËà™ÁÆ°ÁêÜÂô®ÂàùÂßãÂåñ‰∏≠...');

        // ÂÆåÂÖ®Á¶ÅÁî®ÊâÄÊúâÂèØËÉΩÂπ≤Êâ∞ÊµèËßàÂô®ÂØºËà™ÁöÑÂäüËÉΩ
        // Âè™‰øùÁïôÂü∫Êú¨ÁöÑÈ°µÈù¢Áä∂ÊÄÅ‰øùÂ≠òÂäüËÉΩÔºå‰∏çÂπ≤Êâ∞ÂØºËà™

        // ‰ªÖÂú®È°µÈù¢Âç∏ËΩΩÊó∂‰øùÂ≠òÁä∂ÊÄÅÔºå‰∏çÂπ≤Êâ∞ÂØºËà™ËøáÁ®ã
        window.addEventListener('beforeunload', () => {
            this.savePageState();
        });

        console.log('‚úÖ ÂØºËà™ÁÆ°ÁêÜÂô®ÂàùÂßãÂåñÂÆåÊàêÔºàÈùûÂπ≤Êâ∞Ê®°ÂºèÔºâ');
    }

    // ÂéÜÂè≤ËÆ∞ÂΩïÁÆ°ÁêÜ
    setupHistoryManagement() {
        // ‰øùÂ≠òÂàùÂßãÁä∂ÊÄÅ
        this.savePageState();
        
        // ÁõëÂê¨ÊµèËßàÂô®ÂõûÈÄÄ/ÂâçËøõ
        window.addEventListener('popstate', (e) => {
            console.log('üîô ÊµèËßàÂô®ÂéÜÂè≤ËÆ∞ÂΩïÂØºËà™:', e.state);
            
            this.navigationState.previousUrl = this.navigationState.currentUrl;
            this.navigationState.currentUrl = window.location.href;
            
            // ÊÅ¢Â§çÈ°µÈù¢Áä∂ÊÄÅ
            if (e.state) {
                this.restorePageState(e.state);
            }
            
            // Ëß¶ÂèëÂØºËà™‰∫ã‰ª∂
            this.dispatchNavigationEvent('historychange', {
                direction: this.getNavigationDirection(),
                state: e.state,
                url: window.location.href
            });
        });

        // ÁõëÂê¨È°µÈù¢Âä†ËΩΩ
        window.addEventListener('load', () => {
            this.navigationState.isNavigating = false;
            this.savePageState();
        });
    }

    // È°µÈù¢Áä∂ÊÄÅÁÆ°ÁêÜ
    setupPageStateManagement() {
        // ‰øùÂ≠òÊªöÂä®‰ΩçÁΩÆ
        let scrollTimeout;
        window.addEventListener('scroll', () => {
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(() => {
                this.saveScrollPosition();
            }, 100);
        });

        // ‰øùÂ≠òË°®ÂçïÊï∞ÊçÆ
        document.addEventListener('input', (e) => {
            if (e.target.matches('input, textarea, select')) {
                this.saveFormData();
            }
        });

        // È°µÈù¢Âç∏ËΩΩÂâç‰øùÂ≠òÁä∂ÊÄÅ
        window.addEventListener('beforeunload', () => {
            this.savePageState();
        });
    }

    // ÂØºËà™Êã¶Êà™
    setupNavigationInterception() {
        // Êã¶Êà™ÈìæÊé•ÁÇπÂáª
        document.addEventListener('click', (e) => {
            const link = e.target.closest('a[href]');
            
            if (link && this.shouldInterceptNavigation(link)) {
                // ‰∏çÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫ÔºåËÆ©ÊµèËßàÂô®Ê≠£Â∏∏Â§ÑÁêÜ
                // Âè™ÊòØÊ†áËÆ∞ÂØºËà™Áä∂ÊÄÅÂíå‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅ
                this.navigationState.isNavigating = true;
                this.navigationState.navigationStartTime = Date.now();
                
                // ‰øùÂ≠òÂΩìÂâçÈ°µÈù¢Áä∂ÊÄÅ
                this.savePageState();
                
                // Ëß¶ÂèëÂØºËà™ÂºÄÂßã‰∫ã‰ª∂
                this.dispatchNavigationEvent('navigationstart', {
                    url: link.href,
                    target: link
                });
            }
        });

        // Êã¶Êà™Ë°®ÂçïÊèê‰∫§
        document.addEventListener('submit', (e) => {
            const form = e.target;
            if (form.method.toLowerCase() === 'get') {
                this.navigationState.isNavigating = true;
                this.savePageState();
            }
        });
    }

    // Âà§Êñ≠ÊòØÂê¶Â∫îËØ•Êã¶Êà™ÂØºËà™
    shouldInterceptNavigation(link) {
        // Ë∑≥ËøáÂ§ñÈÉ®ÈìæÊé•
        if (!link.href.startsWith(window.location.origin)) {
            return false;
        }
        
        // Ë∑≥ËøáÊñ∞Á™óÂè£ÈìæÊé•
        if (link.target === '_blank') {
            return false;
        }
        
        // Ë∑≥Ëøá‰∏ãËΩΩÈìæÊé•
        if (link.hasAttribute('download')) {
            return false;
        }
        
        // Ë∑≥ËøáÈîöÁÇπÈìæÊé•ÔºàÂêåÈ°µÈù¢ÂÜÖÔºâ
        const url = new URL(link.href);
        if (url.pathname === window.location.pathname && url.hash) {
            return false;
        }
        
        return true;
    }

    // ‰øùÂ≠òÈ°µÈù¢Áä∂ÊÄÅ
    savePageState() {
        const state = {
            url: window.location.href,
            title: document.title,
            scrollPosition: {
                x: window.pageXOffset,
                y: window.pageYOffset
            },
            timestamp: Date.now(),
            formData: this.getFormData(),
            pageData: this.getPageSpecificData()
        };

        try {
            // ‰ΩøÁî® replaceState Êõ¥Êñ∞ÂΩìÂâçÂéÜÂè≤ËÆ∞ÂΩïÈ°π
            history.replaceState(state, document.title, window.location.href);
            
            // ÂêåÊó∂‰øùÂ≠òÂà∞ sessionStorage ‰Ωú‰∏∫Â§á‰ªΩ
            sessionStorage.setItem(`pageState_${window.location.pathname}`, JSON.stringify(state));
        } catch (error) {
            console.warn('‰øùÂ≠òÈ°µÈù¢Áä∂ÊÄÅÂ§±Ë¥•:', error);
        }
    }

    // ÊÅ¢Â§çÈ°µÈù¢Áä∂ÊÄÅ
    restorePageState(state) {
        if (!state) {
            // Â∞ùËØï‰ªé sessionStorage ÊÅ¢Â§ç
            try {
                const savedState = sessionStorage.getItem(`pageState_${window.location.pathname}`);
                if (savedState) {
                    state = JSON.parse(savedState);
                }
            } catch (error) {
                console.warn('‰ªé sessionStorage ÊÅ¢Â§çÁä∂ÊÄÅÂ§±Ë¥•:', error);
                return;
            }
        }

        if (state) {
            // ÊÅ¢Â§çÊªöÂä®‰ΩçÁΩÆ
            if (state.scrollPosition) {
                // Âª∂ËøüÊÅ¢Â§çÔºåÁ°Æ‰øùÈ°µÈù¢Â∑≤Ê∏≤Êüì
                setTimeout(() => {
                    window.scrollTo(state.scrollPosition.x, state.scrollPosition.y);
                }, 100);
            }

            // ÊÅ¢Â§çË°®ÂçïÊï∞ÊçÆ
            if (state.formData) {
                this.restoreFormData(state.formData);
            }

            // ÊÅ¢Â§çÈ°µÈù¢ÁâπÂÆöÊï∞ÊçÆ
            if (state.pageData) {
                this.restorePageSpecificData(state.pageData);
            }
        }
    }

    // ‰øùÂ≠òÊªöÂä®‰ΩçÁΩÆ
    saveScrollPosition() {
        const state = history.state || {};
        state.scrollPosition = {
            x: window.pageXOffset,
            y: window.pageYOffset
        };
        
        try {
            history.replaceState(state, document.title, window.location.href);
        } catch (error) {
            console.warn('‰øùÂ≠òÊªöÂä®‰ΩçÁΩÆÂ§±Ë¥•:', error);
        }
    }

    // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
    getFormData() {
        const formData = {};
        const forms = document.querySelectorAll('form');
        
        forms.forEach((form, formIndex) => {
            const formElements = form.querySelectorAll('input, textarea, select');
            formElements.forEach((element, elementIndex) => {
                if (element.name || element.id) {
                    const key = element.name || element.id || `form_${formIndex}_element_${elementIndex}`;
                    
                    if (element.type === 'checkbox' || element.type === 'radio') {
                        formData[key] = element.checked;
                    } else {
                        formData[key] = element.value;
                    }
                }
            });
        });
        
        return formData;
    }

    // ÊÅ¢Â§çË°®ÂçïÊï∞ÊçÆ
    restoreFormData(formData) {
        Object.entries(formData).forEach(([key, value]) => {
            const element = document.querySelector(`[name="${key}"], #${key}`);
            if (element) {
                if (element.type === 'checkbox' || element.type === 'radio') {
                    element.checked = value;
                } else {
                    element.value = value;
                }
            }
        });
    }

    // Ëé∑ÂèñÈ°µÈù¢ÁâπÂÆöÊï∞ÊçÆ
    getPageSpecificData() {
        const pageData = {};
        
        // ‰øùÂ≠òÂ±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅ
        const collapsibles = document.querySelectorAll('[data-bs-toggle="collapse"]');
        collapsibles.forEach((element, index) => {
            const target = document.querySelector(element.getAttribute('data-bs-target'));
            if (target) {
                pageData[`collapse_${index}`] = target.classList.contains('show');
            }
        });
        
        // ‰øùÂ≠òÈÄâÈ°πÂç°Áä∂ÊÄÅ
        const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
        tabs.forEach((tab, index) => {
            if (tab.classList.contains('active')) {
                pageData.activeTab = index;
            }
        });
        
        // ‰øùÂ≠òÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
        const modals = document.querySelectorAll('.modal.show');
        pageData.openModals = Array.from(modals).map(modal => modal.id);
        
        return pageData;
    }

    // ÊÅ¢Â§çÈ°µÈù¢ÁâπÂÆöÊï∞ÊçÆ
    restorePageSpecificData(pageData) {
        // ÊÅ¢Â§çÂ±ïÂºÄ/ÊäòÂè†Áä∂ÊÄÅ
        Object.entries(pageData).forEach(([key, value]) => {
            if (key.startsWith('collapse_')) {
                const index = parseInt(key.split('_')[1]);
                const collapsible = document.querySelectorAll('[data-bs-toggle="collapse"]')[index];
                if (collapsible) {
                    const target = document.querySelector(collapsible.getAttribute('data-bs-target'));
                    if (target && value) {
                        target.classList.add('show');
                    }
                }
            }
        });
        
        // ÊÅ¢Â§çÈÄâÈ°πÂç°Áä∂ÊÄÅ
        if (pageData.activeTab !== undefined) {
            const tabs = document.querySelectorAll('[data-bs-toggle="tab"]');
            if (tabs[pageData.activeTab]) {
                tabs[pageData.activeTab].click();
            }
        }
    }

    // Ëé∑ÂèñÂØºËà™ÊñπÂêë
    getNavigationDirection() {
        // ÁÆÄÂçïÁöÑÊñπÂêëÊ£ÄÊµãÈÄªËæë
        if (this.navigationState.previousUrl && this.navigationState.currentUrl) {
            // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞Êõ¥Â§çÊùÇÁöÑÈÄªËæëÊù•Ê£ÄÊµãÂâçËøõ/ÂêéÈÄÄ
            return 'unknown';
        }
        return 'initial';
    }

    // Ëß¶ÂèëÂØºËà™‰∫ã‰ª∂
    dispatchNavigationEvent(type, detail) {
        const event = new CustomEvent(`navigation:${type}`, {
            detail,
            bubbles: true,
            cancelable: true
        });
        
        document.dispatchEvent(event);
    }

    // Á®ãÂ∫èÂåñÂØºËà™
    navigateTo(url, options = {}) {
        const {
            replace = false,
            state = null,
            preserveScroll = false
        } = options;

        // ‰øùÂ≠òÂΩìÂâçÁä∂ÊÄÅ
        if (!replace) {
            this.savePageState();
        }

        // ÊâßË°åÂØºËà™
        if (replace) {
            history.replaceState(state, '', url);
        } else {
            history.pushState(state, '', url);
        }

        // Ëß¶Âèë popstate ‰∫ã‰ª∂Êù•Â§ÑÁêÜÂØºËà™
        window.dispatchEvent(new PopStateEvent('popstate', { state }));
    }

    // Ëé∑ÂèñÂØºËà™ÂéÜÂè≤
    getNavigationHistory() {
        const history = [];
        let currentState = window.history.state;
        
        // ËøôÈáåÂèØ‰ª•ÂÆûÁé∞Êõ¥Â§çÊùÇÁöÑÂéÜÂè≤ËÆ∞ÂΩïË∑üË∏™
        // ÁõÆÂâçÂè™ËøîÂõûÂΩìÂâçÁä∂ÊÄÅ
        if (currentState) {
            history.push(currentState);
        }
        
        return history;
    }

    // Ê∏ÖÁêÜËµÑÊ∫ê
    destroy() {
        // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
        // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Ê∏ÖÁêÜÈÄªËæë
        console.log('üß≠ ÂØºËà™ÁÆ°ÁêÜÂô®Â∑≤ÈîÄÊØÅ');
    }
}

// ÂàõÂª∫ÂÖ®Â±ÄÂÆû‰æã
window.navigationManager = new NavigationManager();

// ‰æøÊç∑ÊñπÊ≥ï
window.navigateTo = (url, options) => window.navigationManager.navigateTo(url, options);

// ÂØºÂá∫‰æõÂÖ∂‰ªñÊ®°Âùó‰ΩøÁî®
if (typeof module !== 'undefined' && module.exports) {
    module.exports = NavigationManager;
}
