{% extends 'knowledge_app/base.html' %}
{% load quiz_extras %}

{% block title %}æ¯æ—¥åè¯ - è®¡ç®—æœºç§‘å­¦å­¦ä¹ å¹³å°{% endblock %}

{% block extra_css %}
<style>* {box-sizing:border-box}body {font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;line-height:1.6;color:var(--text-primary);background:linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);min-height:100vh;margin:0;padding:0}.page-layout {min-height:100vh;display:flex;flex-direction:column}.main-content {flex:1;width:100%}.daily-term-container {max-width:1400px;margin:0 auto;padding:24px;min-height:100vh;position:relative;z-index:1;display:flex;flex-direction:column;gap:32px}.page-header {background:rgba(255, 255, 255, 0.1);backdrop-filter:blur(15px);border-radius:24px;padding:40px;margin-bottom:0;color:var(--text-inverse);text-align:center;position:relative;z-index:2;box-shadow:var(--shadow-md)}.breadcrumb {position:absolute;top:24px;left:32px;display:flex;align-items:center;gap:10px;font-size:0.9rem;opacity:0.95;z-index:3}.breadcrumb-item {color:rgba(255, 255, 255, 0.9);text-decoration:none;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);padding:6px 12px;border-radius:16px;background:rgba(255, 255, 255, 0.12);backdrop-filter:blur(8px);border:1px solid rgba(255, 255, 255, 0.1)}.breadcrumb-item:hover {color:var(--text-inverse);background:rgba(255, 255, 255, 0.25);transform:translateY(-2px);box-shadow:var(--shadow-md)}.breadcrumb-separator {color:rgba(255, 255, 255, 0.7);font-weight:500;font-size:1.1rem}.breadcrumb-current {color:var(--text-inverse);font-weight:600;background:rgba(255, 255, 255, 0.2);padding:6px 12px;border-radius:16px}.quick-nav {margin-top:25px;display:flex;justify-content:center;gap:15px;flex-wrap:wrap}.nav-btn {background:rgba(255, 255, 255, 0.15);color:var(--text-inverse);text-decoration:none;padding:10px 20px;border-radius:25px;border:1px solid rgba(255, 255, 255, 0.3);transition:all 0.3s ease;font-size:0.9rem;font-weight:500;cursor:pointer;display:inline-flex;align-items:center;gap:8px}.nav-btn:hover {background:rgba(255, 255, 255, 0.25);border-color:rgba(255, 255, 255, 0.5);transform:translateY(-2px);box-shadow:var(--shadow-md)}.page-title {font-size:2.8rem;font-weight:800;margin-bottom:16px;display:flex;align-items:center;justify-content:center;gap:16px;letter-spacing:-0.02em;text-shadow:0 2px 8px rgba(0, 0, 0, 0.1)}.page-subtitle {font-size:1.2rem;opacity:0.92;margin-bottom:24px;font-weight:400;line-height:1.5}.current-date {background:rgba(255, 255, 255, 0.25);padding:10px 20px;border-radius:24px;font-size:0.95rem;display:inline-block;font-weight:500;backdrop-filter:blur(8px);border:1px solid rgba(255, 255, 255, 0.2);box-shadow:var(--shadow-md)}.today-term-card {background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:24px;padding:3rem;box-shadow:0 12px 40px rgba(0,0,0,0.08);margin:0;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,0.8);transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);backdrop-filter:blur(20px)}.today-term-card::before {content:'';position:absolute;top:0;left:0;right:0;height:6px;background:linear-gradient(90deg, #667eea 0%, #764ba2 25%, #4ecdc4 50%, #44a08d 75%, #667eea 100%);background-size:300% 100%;animation:gradientShift 4s ease-in-out infinite}@keyframes gradientShift {0%, 100% {background-position:0% 0%}50% {background-position:100% 0%}}.today-term-card:hover {transform:translateY(-12px) scale(1.01);box-shadow:0 25px 60px rgba(0,0,0,0.15);border-color:rgba(102, 126, 234, 0.3)}.term-header {display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:32px;gap:24px}.term-title {font-size:2.8rem;font-weight:900;background:linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin:0;letter-spacing:-0.03em;line-height:1.1;flex:1;text-shadow:0 2px 4px rgba(0,0,0,0.1)}.term-meta {display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;flex-shrink:0}.meta-badge {padding:8px 16px;border-radius:20px;font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.8px;transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);box-shadow:0 2px 8px rgba(0,0,0,0.1);backdrop-filter:blur(10px)}.category-badge {background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);color:white;border:1px solid rgba(255,255,255,0.2)}.category-badge:hover {transform:translateY(-2px);box-shadow:0 4px 12px rgba(102, 126, 234, 0.4)}.difficulty-badge {background:linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);color:white;border:1px solid rgba(255,255,255,0.2)}.difficulty-badge:hover {transform:translateY(-2px);box-shadow:0 4px 12px rgba(78, 205, 196, 0.4)}.difficulty-beginner {background:#e8f5e8;color:#2e7d32}.difficulty-intermediate {background:#fff3e0;color:#f57c00}.difficulty-advanced {background:#ffebee;color:#d32f2f}.term-explanation {margin-bottom:40px}.explanation-section {background:linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);border-radius:16px;padding:2rem;margin-bottom:1.5rem;border-left:4px solid #667eea;box-shadow:0 4px 16px rgba(0,0,0,0.05);transition:all 0.3s ease}.explanation-section:hover {transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,0,0,0.1)}.explanation-section:nth-child(1) {border-left-color:#667eea}.explanation-section:nth-child(2) {border-left-color:#4ecdc4}.explanation-section:nth-child(3) {border-left-color:#45b7d1}.explanation-section:nth-child(4) {border-left-color:#96ceb4}.explanation-section:nth-child(5) {border-left-color:#feca57}.section-title {display:flex;align-items:center;gap:0.8rem;font-size:1.3rem;font-weight:700;color:#2d3748;margin:0 0 1.5rem 0;padding-bottom:0.8rem;border-bottom:2px solid rgba(0,0,0,0.05)}.section-icon {font-size:1.5rem;display:flex;align-items:center;justify-content:center;width:2.5rem;height:2.5rem;background:linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}.section-content {font-size:1.1rem;line-height:1.7;color:#4a5568;white-space:pre-line;font-weight:400;letter-spacing:0.01em}.term-actions {display:flex;gap:15px;align-items:center;justify-content:space-between;padding-top:20px;border-top:1px solid #eee}.action-buttons {display:flex;gap:10px}.btn {padding:14px 28px;border-radius:16px;border:none;font-weight:600;cursor:pointer;transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);text-decoration:none;display:inline-flex;align-items:center;gap:10px;font-size:0.95rem;position:relative;overflow:hidden;white-space:nowrap}.btn::before {content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);transition:left 0.5s}.btn:hover::before {left:100%}.btn-primary {background:linear-gradient(135deg, var(--accent-color), #44a08d);color:var(--text-inverse);box-shadow:0 4px 16px rgba(78, 205, 196, 0.3)}.btn-primary:hover {background:linear-gradient(135deg, #44a08d, #3a8b7a);transform:translateY(-3px);box-shadow:0 8px 24px rgba(78, 205, 196, 0.4)}.btn-secondary {background:#f8f9fa;color:#6c757d;border:1px solid #dee2e6;box-shadow:var(--shadow-md)}.btn-secondary:hover {background:#e9ecef;color:#495057;transform:translateY(-2px);box-shadow:var(--shadow-md)}.btn-ai {background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));color:var(--text-inverse);position:relative;overflow:hidden;border:none;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(102, 126, 234, 0.3)}.btn-ai:hover {background:linear-gradient(135deg, #5a6fd8, #6a4190);transform:translateY(-2px);box-shadow:0 8px 25px rgba(102, 126, 234, 0.3)}.btn-ai.active {background:linear-gradient(135deg, #28a745, #20c997)}.btn-ai.active:hover {background:linear-gradient(135deg, #218838, #1ea080)}.btn-ai::before {content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);transition:left 0.5s}.btn-ai:hover::before {left:100%}.btn-pdf {background:linear-gradient(135deg, #e74c3c, #c0392b);color:var(--text-inverse);text-decoration:none;box-shadow:0 4px 15px rgba(231, 76, 60, 0.3)}.btn-pdf:hover {background:linear-gradient(135deg, #c0392b, #a93226);transform:translateY(-2px);box-shadow:0 8px 25px rgba(231, 76, 60, 0.4);color:var(--text-inverse);text-decoration:none}.term-stats {display:flex;gap:20px;color:#666;font-size:0.9rem}.stat-item {display:flex;align-items:center;gap:5px}.history-section {margin-top:0;padding:0}.section-title {font-size:2rem;font-weight:700;color:#2c3e50;margin-bottom:32px;display:flex;align-items:center;gap:12px;letter-spacing:-0.01em}.history-grid {display:grid;grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));gap:28px;padding:0;width:100%}.history-card {background:var(--bg-card);border-radius:16px;padding:24px;box-shadow:var(--shadow-md);transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);text-decoration:none;color:inherit;border:1px solid rgba(0,0,0,0.05);cursor:pointer;position:relative;overflow:hidden}.history-card::before {content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(135deg, var(--accent-color), var(--primary-color));transform:scaleX(0);transition:transform 0.3s ease}.history-card:hover {transform:translateY(-6px);box-shadow:var(--shadow-md);text-decoration:none;color:inherit;border-color:rgba(78, 205, 196, 0.2)}.history-card:hover::before {transform:scaleX(1)}.history-term {font-size:1.3rem;font-weight:600;color:var(--text-primary);margin-bottom:10px}.history-date {color:#666;font-size:0.9rem;margin-bottom:15px}.history-preview {color:#666;font-size:0.95rem;line-height:1.5;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}.no-term-message {text-align:center;padding:60px 20px;color:#666}.no-term-icon {font-size:4rem;margin-bottom:20px;opacity:0.6}@media (max-width:768px) {.daily-term-container {padding:20px 16px;gap:24px}.page-header {padding:32px 24px;border-radius:var(--border-radius-lg)}.breadcrumb {position:static;justify-content:center;margin-bottom:20px;flex-wrap:wrap}.page-title {font-size:2.2rem;margin-top:0}.today-term-container {grid-template-columns:1fr;gap:24px}.today-term-container.with-sidebar {grid-template-columns:1fr}.today-term-card {padding:28px}.term-header {flex-direction:column;gap:16px;align-items:flex-start}.term-title {font-size:2rem}.term-meta {align-self:flex-start}.term-actions {flex-direction:column;gap:16px;align-items:stretch}.action-buttons {justify-content:center;flex-wrap:wrap}.chatbot-sidebar {position:relative;top:0;width:100%;min-width:100%;max-width:100%;height:600px}.history-grid {grid-template-columns:1fr;gap:20px}}.modal-overlay {position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0, 0, 0, 0.6);backdrop-filter:blur(8px);display:none;justify-content:center;align-items:center;z-index:10000;animation:fadeIn 0.3s ease}.modal-overlay.show {display:flex}.modal-card {background:var(--bg-card);border-radius:25px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:var(--shadow-md);transform:scale(0.9);transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);position:relative}.modal-overlay.show .modal-card {transform:scale(1)}.modal-header {padding:30px 30px 20px;border-bottom:1px solid #f0f0f0;display:flex;align-items:flex-start;gap:20px;position:relative}.modal-icon {font-size:3rem;background:linear-gradient(135deg, var(--accent-color), #44a08d);border-radius:var(--border-radius);width:70px;height:70px;display:flex;align-items:center;justify-content:center;flex-shrink:0}.modal-title-section {flex:1}.modal-title {font-size:1.8rem;font-weight:700;color:var(--text-primary);margin:0 0 10px 0;line-height:1.3}.modal-meta {display:flex;gap:10px;flex-wrap:wrap}.modal-category, .modal-difficulty {padding:4px 12px;border-radius:12px;font-size:0.8rem;font-weight:600;text-transform:uppercase}.modal-category {background:#e3f2fd;color:#1976d2}.modal-difficulty {background:#f3e5f5;color:#7b1fa2}.modal-difficulty.beginner {background:#e8f5e8;color:#2e7d32}.modal-difficulty.intermediate {background:#fff3e0;color:#f57c00}.modal-difficulty.advanced {background:#ffebee;color:#d32f2f}.modal-close {position:absolute;top:15px;right:15px;background:#f5f5f5;border:none;border-radius:50%;width:35px;height:35px;font-size:1.5rem;color:#666;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;justify-content:center}.modal-close:hover {background:#e0e0e0;color:var(--text-primary);transform:rotate(90deg)}.modal-content {padding:20px 30px 30px}.modal-description {font-size:1.1rem;line-height:1.7;color:#555;margin-bottom:25px;white-space:pre-line}.modal-actions {display:flex;gap:15px;justify-content:center;padding-top:20px;border-top:1px solid #f0f0f0}.modal-btn {padding:12px 24px;border-radius:25px;border:none;font-weight:600;cursor:pointer;transition:all 0.3s ease;font-size:1rem;display:flex;align-items:center;gap:8px}.modal-btn.primary {background:linear-gradient(135deg, var(--accent-color), #44a08d);color:var(--text-inverse);box-shadow:0 4px 15px rgba(78, 205, 196, 0.3)}.modal-btn.primary:hover {transform:translateY(-2px);box-shadow:0 8px 25px rgba(78, 205, 196, 0.4)}.modal-btn.secondary {background:#f8f9fa;color:#6c757d;border:1px solid #dee2e6}.modal-btn.secondary:hover {background:#e9ecef;color:#495057}.today-term-container {display:grid;grid-template-columns:1fr;gap:32px;margin-bottom:0;position:relative;align-items:start;width:100%}.today-term-container.with-sidebar {grid-template-columns:1fr 420px;gap:40px}.today-term-card {transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);margin:0;width:100%;min-width:0}.chatbot-sidebar {width:420px;min-width:420px;max-width:420px;height:700px;background:linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);border:2px solid var(--primary-color);border-radius:24px;box-shadow:0 20px 80px rgba(102, 126, 234, 0.15);display:none;flex-direction:column;overflow:hidden;transition:all 0.6s cubic-bezier(0.4, 0, 0.2, 1);opacity:0;transform:translateX(40px) scale(0.95);position:sticky;top:32px;z-index:100;backdrop-filter:blur(20px)}.chatbot-sidebar.show {display:flex !important;opacity:1;transform:translateX(0) scale(1);visibility:visible}.chatbot-sidebar::before {content:'';position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg, var(--primary-color), var(--secondary-color), var(--accent-color));border-radius:24px 24px 0 0}.sidebar-header {padding:20px;border-bottom:1px solid #e9ecef;background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));color:var(--text-inverse);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;border-radius:20px 20px 0 0}.chatbot-header {display:flex;align-items:center;gap:15px;flex:1}.sidebar-close {background:rgba(255, 255, 255, 0.2);border:none;color:var(--text-inverse);width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1.2rem;transition:all 0.3s ease}.sidebar-close:hover {background:rgba(255, 255, 255, 0.3);transform:scale(1.1)}.header-controls {display:flex;align-items:center;gap:10px}.theme-btn {background:rgba(255, 255, 255, 0.2);border:none;color:var(--text-inverse);width:32px;height:32px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:1rem;transition:all 0.3s ease}.theme-btn:hover {background:rgba(255, 255, 255, 0.3);transform:scale(1.1)}.theme-selector {background:#f8f9fa;border-bottom:1px solid #e9ecef;padding:15px 20px;display:none}.theme-selector.show {display:block}.theme-selector-header h4 {margin:0 0 15px 0;color:var(--text-primary);font-size:0.9rem;font-weight:600}.theme-options {display:flex;flex-direction:column;gap:8px}.theme-option {display:flex;align-items:center;gap:12px;padding:10px 12px;border-radius:var(--border-radius-sm);cursor:pointer;transition:all 0.3s ease;border:1px solid transparent}.theme-option:hover {background:#e9ecef;border-color:var(--primary-color)}.theme-option.active {background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));color:var(--text-inverse);border-color:var(--primary-color)}.theme-option.active .theme-avatar {background:rgba(255, 255, 255, 0.2)}.theme-avatar {width:32px;height:32px;border-radius:50%;background:#e9ecef;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}.theme-info {flex:1}.theme-name {font-weight:600;font-size:0.9rem;margin-bottom:2px}.theme-description {font-size:0.8rem;opacity:0.8;line-height:1.3}.loading-themes {text-align:center;color:#666;font-style:italic;padding:10px}.theme-change-message {border-left:3px solid var(--primary-color);background:linear-gradient(135deg, #f8f9ff, #f0f2ff);transition:opacity 0.5s ease}.theme-change-message .message-content {background:transparent}.theme-blue .sidebar-header {background:linear-gradient(135deg, var(--primary-color), var(--secondary-color))}.theme-green .sidebar-header {background:linear-gradient(135deg, #56ab2f, #a8e6cf)}.theme-purple .sidebar-header {background:linear-gradient(135deg, var(--primary-color), var(--secondary-color))}.theme-orange .sidebar-header {background:linear-gradient(135deg, #f093fb, #f5576c)}.theme-teal .sidebar-header {background:linear-gradient(135deg, var(--accent-color), #44a08d)}.sidebar-content {flex:1;display:flex;flex-direction:column;overflow-y:auto;overflow-x:hidden;padding:0}.suggested-questions {padding:20px;border-bottom:1px solid #eee}.suggested-questions h4 {margin:0 0 15px 0;color:var(--text-primary);font-size:1rem}.questions-list {display:flex;flex-direction:column;gap:8px}.question-item {padding:10px 15px;background:#f8f9fa;border-radius:var(--border-radius-sm);cursor:pointer;transition:all 0.2s ease;font-size:0.9rem;color:#555}.question-item:hover {background:#e9ecef;color:var(--text-primary)}.chat-area {flex:1;display:flex;flex-direction:column;overflow:hidden;padding:20px;min-height:0}.chat-area.hidden {display:none !important}.chat-messages {flex:1;overflow-y:auto;padding:24px;display:flex;flex-direction:column;gap:16px;background:linear-gradient(to bottom, #f8fafc 0%, #ffffff 100%);scrollbar-width:thin;scrollbar-color:rgba(102, 126, 234, 0.3) transparent}.chat-messages::-webkit-scrollbar {width:6px}.chat-messages::-webkit-scrollbar-track {background:transparent}.chat-messages::-webkit-scrollbar-thumb {background:rgba(102, 126, 234, 0.3);border-radius:3px}.chat-messages::-webkit-scrollbar-thumb:hover {background:rgba(102, 126, 234, 0.5)}.user-message, .ai-message {display:flex;gap:10px;align-items:flex-start}.user-message {flex-direction:row-reverse}.message-avatar {width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}.message-content {max-width:70%;padding:12px 16px;border-radius:12px;line-height:1.4}.user-message .message-content {background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));color:var(--text-inverse);border-bottom-right-radius:4px}.ai-message .message-content {background:#f8f9fa;color:var(--text-primary);border-bottom-left-radius:4px}.chat-input-area {padding:20px;border-top:1px solid #eee;background:#fafafa}.input-container {display:flex;gap:10px;align-items:center}#chatInput {flex:1;padding:12px 16px;border:1px solid #ddd;border-radius:25px;outline:none;font-size:0.9rem}#chatInput:focus {border-color:var(--primary-color);box-shadow:0 0 0 2px rgba(102, 126, 234, 0.1)}#sendButton {width:40px;height:40px;border:none;background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));color:var(--text-inverse);border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease}#sendButton:hover {transform:scale(1.05)}.input-hint {font-size:0.8rem;color:#999;margin-top:8px;text-align:center}.chat-start-area {padding:40px 20px;text-align:center}.start-chat-btn {background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));color:var(--text-inverse);border:none;padding:15px 30px;border-radius:25px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease}.start-chat-btn:hover {transform:translateY(-2px);box-shadow:0 8px 25px rgba(102, 126, 234, 0.3)}.start-hint {margin-top:15px;color:#666;font-size:0.9rem}.typing-indicator .typing-dots {display:flex;gap:4px;align-items:center}.typing-dot {width:8px;height:8px;background:#999;border-radius:50%;animation:typing 1.4s infinite ease-in-out}.typing-dot:nth-child(1) {animation-delay:-0.32s}.typing-dot:nth-child(2) {animation-delay:-0.16s}@keyframes typing {0%, 80%, 100% {transform:scale(0.8);opacity:0.5}40% {transform:scale(1);opacity:1}}.api-status-message {padding:10px 15px;margin:10px 0;border-radius:var(--border-radius-sm);font-size:0.9rem;text-align:center;font-weight:500}.api-status-message.success {background:#e8f5e8;color:#2e7d32;border:1px solid #4caf50}.api-status-message.warning {background:#fff3e0;color:#f57c00;border:1px solid #ff9800}.api-status-message.error {background:#ffebee;color:#d32f2f;border:1px solid #f44336}.chatbot-avatar {width:50px;height:50px;background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem}.chatbot-info h3 {margin:0;color:var(--text-inverse);font-size:1.2rem}.chatbot-info p {margin:5px 0 0 0;color:rgba(255, 255, 255, 0.9);font-size:0.9rem}.suggested-questions {padding:20px;border-bottom:1px solid #eee;background:#f8f9fa}.suggested-questions h4 {margin:0 0 15px 0;color:var(--text-primary);font-size:1rem}.questions-list {display:flex;flex-direction:column;gap:8px}.question-item {background:#f8f9fa;border:1px solid #e9ecef;border-radius:12px;padding:10px 15px;cursor:pointer;transition:all 0.3s ease;font-size:0.9rem;color:#495057}.question-item:hover {background:#e9ecef;border-color:var(--primary-color);color:var(--text-primary)}.loading-questions {text-align:center;color:#666;font-style:italic;padding:20px}.chat-messages {flex:1;overflow-y:auto;padding:0;margin-bottom:20px}.ai-message, .user-message {display:flex;gap:10px;margin-bottom:15px}.user-message {flex-direction:row-reverse}.message-avatar {width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}.ai-message .message-avatar {background:linear-gradient(135deg, var(--primary-color), var(--secondary-color))}.user-message .message-avatar {background:linear-gradient(135deg, var(--accent-color), #44a08d)}.message-content {background:#f8f9fa;border-radius:12px;padding:10px 15px;max-width:80%;word-wrap:break-word}.user-message .message-content {background:linear-gradient(135deg, var(--accent-color), #44a08d);color:var(--text-inverse)}.message-content p {margin:0;line-height:1.5}.chat-input-area {border-top:1px solid #eee;padding-top:15px;margin-top:0;flex-shrink:0}.chat-start-area {padding:30px 20px;text-align:center;border-top:1px solid #eee}.start-chat-btn {background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));color:var(--text-inverse);border:none;padding:15px 30px;border-radius:25px;font-size:1rem;font-weight:600;cursor:pointer;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(102, 126, 234, 0.3)}.start-chat-btn:hover {transform:translateY(-2px);box-shadow:0 8px 25px rgba(102, 126, 234, 0.4)}.start-hint {margin-top:10px;color:#666;font-size:0.9rem}.input-container {display:flex;gap:10px;align-items:center}#chatInput {flex:1;padding:12px 15px;border:1px solid #ddd;border-radius:25px;font-size:0.9rem;outline:none;transition:border-color 0.3s ease}#chatInput:focus {border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(102, 126, 234, 0.1)}#sendButton {width:40px;height:40px;border:none;border-radius:50%;background:linear-gradient(135deg, var(--primary-color), var(--secondary-color));color:var(--text-inverse);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.3s ease}#sendButton:hover {transform:scale(1.1);box-shadow:0 4px 12px rgba(102, 126, 234, 0.3)}.input-hint {font-size:0.8rem;color:#999;margin-top:8px;text-align:center}.typing-indicator {display:flex;align-items:center;gap:10px;padding:10px 0;color:#666;font-style:italic}.typing-dots {display:flex;gap:3px}.typing-dot {width:6px;height:6px;border-radius:50%;background:var(--primary-color);animation:typing 1.4s infinite}.typing-dot:nth-child(2) {animation-delay:0.2s}.typing-dot:nth-child(3) {animation-delay:0.4s}@keyframes typing {0%, 60%, 100% {transform:translateY(0);opacity:0.4}30% {transform:translateY(-10px);opacity:1}}@media (max-width:1024px) and (min-width:769px) {.daily-term-container {padding:24px 20px}.today-term-container.with-sidebar {grid-template-columns:1fr;gap:32px}.chatbot-sidebar {position:relative;top:0;width:100%;min-width:100%;max-width:100%;height:600px}}@media (min-width:1200px) {.daily-term-container {max-width:1600px;padding:32px}.today-term-container.with-sidebar {grid-template-columns:1fr 480px;gap:48px}.chatbot-sidebar {width:480px;min-width:480px;max-width:480px;height:750px}.page-header {padding:48px}.page-title {font-size:3.2rem}.today-term-card {padding:48px}.term-title {font-size:2.6rem}}@media (min-width:1600px) {.daily-term-container {max-width:1800px}.today-term-container.with-sidebar {grid-template-columns:1fr 520px;gap:56px}.chatbot-sidebar {width:520px;min-width:520px;max-width:520px}}@keyframes fadeInUp {from {opacity:0;transform:translateY(30px)}to {opacity:1;transform:translateY(0)}}@keyframes slideInRight {from {opacity:0;transform:translateX(30px)}to {opacity:1;transform:translateX(0)}}@keyframes pulse {0%, 100% {transform:scale(1)}50% {transform:scale(1.05)}}.daily-term-container {animation:fadeInUp 0.8s ease-out}.today-term-card {animation:fadeInUp 0.8s ease-out 0.2s both}.chatbot-sidebar.show {animation:slideInRight 0.5s ease-out}.history-card {animation:fadeInUp 0.6s ease-out both}.history-card:nth-child(1) {animation-delay:0.1s}.history-card:nth-child(2) {animation-delay:0.2s}.history-card:nth-child(3) {animation-delay:0.3s}.history-card:nth-child(4) {animation-delay:0.4s}.history-card:nth-child(5) {animation-delay:0.5s}.history-card:nth-child(6) {animation-delay:0.6s}.btn:focus, .nav-btn:focus, .breadcrumb-item:focus {outline:3px solid rgba(78, 205, 196, 0.5);outline-offset:2px}::-webkit-scrollbar {width:8px}::-webkit-scrollbar-track {background:rgba(255, 255, 255, 0.1);border-radius:4px}::-webkit-scrollbar-thumb {background:rgba(78, 205, 196, 0.6);border-radius:4px}::-webkit-scrollbar-thumb:hover {background:rgba(78, 205, 196, 0.8)}.today-term-card, .history-card, .chatbot-sidebar {will-change:transform}@media (prefers-reduced-motion:reduce) {*, *::before, *::after {animation-duration:0.01ms !important;animation-iteration-count:1 !important;transition-duration:0.01ms !important}}</style>
{% endblock %}

{% block content %}
<main class="page-layout" role="main"><!-- ä¸»å†…å®¹åŒºåŸŸ --><div class="main-content"><div class="daily-term-container"><!-- é¡µé¢å¤´éƒ¨ --><header class="page-header"><!-- é¢åŒ…å±‘å¯¼èˆª --><nav class="breadcrumb" aria-label="é¢åŒ…å±‘å¯¼èˆª"><a href="{% url 'knowledge_app:index' %}" class="breadcrumb-item" aria-label="è¿”å›é¦–é¡µ">
                        ğŸ  é¦–é¡µ
                    </a><span class="breadcrumb-separator" aria-hidden="true">â€º</span><span class="breadcrumb-current" aria-current="page">ğŸ“š æ¯æ—¥åè¯</span></nav><h1 class="page-title">
                    ğŸ“š æ¯æ—¥åè¯
                </h1><p class="page-subtitle">æ¯å¤©å­¦ä¹ ä¸€ä¸ªè®¡ç®—æœºä¸“ä¸šåè¯ï¼Œç§¯ç´¯ä¸“ä¸šçŸ¥è¯†</p><time class="current-date" datetime="{{ current_date|date:'Y-m-d' }}">
                    ğŸ“… {{ current_date|date:"Yå¹´mæœˆdæ—¥" }}
                </time><!-- å¿«é€Ÿå¯¼èˆª --><nav class="quick-nav" aria-label="å¿«é€Ÿå¯¼èˆª"><a href="{% url 'knowledge_app:index' %}" class="nav-btn" aria-label="è¿”å›é¦–é¡µ">
                        ğŸ  è¿”å›é¦–é¡µ
                    </a><a href="{% url 'knowledge_app:cs_universe' %}" class="nav-btn" aria-label="è¿›å…¥CSå®‡å®™">
                        ğŸŒŒ CSå®‡å®™
                    </a><button class="nav-btn" onclick="scrollToHistory()" aria-label="è·³è½¬åˆ°å†å²è®°å½•">
                        ğŸ“œ å†å²è®°å½•
                    </button></nav></header><!-- ä»Šæ—¥åè¯ -->
            {% if today_term %}
            <section class="today-term-container" aria-labelledby="today-term-title"><article class="today-term-card"><header class="term-header"><h2 id="today-term-title" class="term-title">{{ today_term.term }}</h2><div class="term-meta" role="group" aria-label="åè¯æ ‡ç­¾">
                            {% if today_term.category %}
                            <span class="meta-badge category-badge" aria-label="åˆ†ç±»">{{ today_term.category }}</span>
                            {% endif %}
                            <span class="meta-badge difficulty-badge difficulty-{{ today_term.difficulty_level }}" aria-label="éš¾åº¦çº§åˆ«">
                                {{ today_term.get_difficulty_level_display }}
                            </span></div></header><div class="term-explanation" role="definition">
                        {% with parsed_explanation=today_term.explanation|parse_explanation %}
                            {% if parsed_explanation.core_concept %}
                            <div class="explanation-section"><h3 class="section-title"><span class="section-icon">ğŸ’¡</span><span>æ ¸å¿ƒæ¦‚å¿µ</span></h3><div class="section-content">{{ parsed_explanation.core_concept|clean_text }}</div></div>
                            {% endif %}

                            {% if parsed_explanation.term_info %}
                            <div class="explanation-section"><h3 class="section-title"><span class="section-icon">ğŸ“–</span><span>æœ¯è¯­ä¿¡æ¯</span></h3><div class="section-content">{{ parsed_explanation.term_info|clean_text }}</div></div>
                            {% endif %}

                            {% if parsed_explanation.working_principle %}
                            <div class="explanation-section"><h3 class="section-title"><span class="section-icon">âš™ï¸</span><span>å·¥ä½œåŸç†</span></h3><div class="section-content">{{ parsed_explanation.working_principle|clean_text }}</div></div>
                            {% endif %}

                            {% if parsed_explanation.practical_application %}
                            <div class="explanation-section"><h3 class="section-title"><span class="section-icon">ğŸš€</span><span>å®é™…åº”ç”¨</span></h3><div class="section-content">{{ parsed_explanation.practical_application|clean_text }}</div></div>
                            {% endif %}

                            {% if parsed_explanation.learning_points %}
                            <div class="explanation-section"><h3 class="section-title"><span class="section-icon">ğŸ“</span><span>å­¦ä¹ è¦ç‚¹</span></h3><div class="section-content">{{ parsed_explanation.learning_points|clean_text }}</div></div>
                            {% endif %}

                            {% if not parsed_explanation.core_concept and not parsed_explanation.term_info and not parsed_explanation.working_principle and not parsed_explanation.practical_application and not parsed_explanation.learning_points %}
                            <div class="explanation-section"><div class="section-content">{{ today_term.explanation|clean_text }}</div></div>
                            {% endif %}
                        {% endwith %}
                    </div><footer class="term-actions"><div class="action-buttons" role="group" aria-label="æ“ä½œæŒ‰é’®"><button class="btn btn-primary" onclick="likeTerm({{ today_term.id }})" aria-label="ä¸ºè¿™ä¸ªåè¯ç‚¹èµ">
                                ğŸ‘ ç‚¹èµ (<span id="like-count" aria-live="polite">{{ today_term.like_count }}</span>)
                            </button><button class="btn btn-secondary" onclick="showTermDetail({{ today_term.id }}, '{{ today_term.term }}', '{{ today_term.explanation|escapejs }}', '{{ today_term.category }}', '{{ today_term.difficulty_level }}')" aria-label="æŸ¥çœ‹åè¯è¯¦ç»†ä¿¡æ¯">
                                ğŸ“– æŸ¥çœ‹è¯¦æƒ…
                            </button><a href="{% url 'knowledge_app:export_daily_term_pdf' today_term.id %}"
                               class="btn btn-pdf"
                               target="_blank"
                               onclick="return handlePdfExport(this)"
                               aria-label="å¯¼å‡ºPDFåè¯å¡ç‰‡">
                                ğŸ“„ å¯¼å‡ºPDF
                            </a><button class="btn btn-ai" onclick="toggleChatbot()" id="aiToggleBtn" aria-label="æ‰“å¼€AIåŠ©æ‰‹" aria-expanded="false">
                                ğŸ¤– AIåŠ©æ‰‹
                            </button></div><div class="term-stats" role="group" aria-label="ç»Ÿè®¡ä¿¡æ¯"><div class="stat-item"><span aria-hidden="true">ğŸ‘€</span><span>{{ today_term.view_count }} æ¬¡æµè§ˆ</span></div><div class="stat-item"><span aria-hidden="true">ğŸ“…</span><time datetime="{{ today_term.display_date|date:'Y-m-d' }}">{{ today_term.display_date|date:"mæœˆdæ—¥" }}</time></div></div></footer></article><!-- AIåŠ©æ‰‹ä¾§è¾¹æ  --><div class="chatbot-sidebar" id="chatbotSidebar"><div class="sidebar-header"><div class="chatbot-header"><div class="chatbot-avatar" id="chatbotAvatar">ğŸ¤–</div><div class="chatbot-info"><h3 id="chatbotName">AIå­¦ä¹ åŠ©æ‰‹</h3><p>ä¸“é—¨è§£ç­”å…³äº"{{ today_term.term }}"çš„é—®é¢˜</p></div></div><button class="sidebar-close" onclick="toggleChatbot()">Ã—</button></div><div class="sidebar-content"><!-- æ¨èé—®é¢˜åŒºåŸŸ --><div id="suggestedQuestions" class="suggested-questions"><h4>ğŸ’¡ æ¨èé—®é¢˜</h4><div id="questionsList" class="questions-list"><div class="loading-questions">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ä½¿ç”¨AIåŠ©æ‰‹</div></div></div><!-- èŠå¤©åŒºåŸŸ --><div id="chatArea" class="chat-area hidden"><div id="chatMessages" class="chat-messages"><div class="welcome-message"><div class="ai-message"><div class="message-avatar">ğŸ¤–</div><div class="message-content"><p>ä½ å¥½ï¼æˆ‘æ˜¯AIå­¦ä¹ åŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©ä½ ç†è§£è®¡ç®—æœºä¸“ä¸šåè¯ã€‚</p><p>ä½ å¯ä»¥é—®æˆ‘ä»»ä½•å…³äº"{{ today_term.term }}"çš„é—®é¢˜ï¼Œæˆ‘ä¼šå°½åŠ›ä¸ºä½ è§£ç­”ï¼</p></div></div></div></div><!-- è¾“å…¥åŒºåŸŸ --><div class="chat-input-area"><div class="input-container"><input type="text" id="chatInput" placeholder="è¯·è¾“å…¥ä½ çš„é—®é¢˜..." maxlength="200"><button id="sendButton" onclick="sendMessage()"><span class="send-icon">ğŸ“¤</span></button></div><div class="input-hint">
                            æŒ‰ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
                        </div></div></div><!-- å¯åŠ¨æŒ‰é’® --><div class="chat-start-area" id="chatStartArea"><button class="start-chat-btn" onclick="startChatbot()">
                        ğŸš€ å¯åŠ¨AIåŠ©æ‰‹
                    </button><p class="start-hint">ç‚¹å‡»å¯åŠ¨åå¼€å§‹æ™ºèƒ½é—®ç­”</p></div></div></div></section>
            {% else %}
            <section class="no-term-message" role="status" aria-live="polite"><div class="no-term-icon" aria-hidden="true">ğŸ¤”</div><h2>ä»Šæ—¥åè¯æ­£åœ¨å‡†å¤‡ä¸­...</h2><p>æˆ‘ä»¬æ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä»Šå¤©çš„ä¸“ä¸šåè¯ï¼Œè¯·ç¨ååˆ·æ–°é¡µé¢ã€‚</p><button class="btn btn-primary" onclick="location.reload()" aria-label="åˆ·æ–°é¡µé¢ä»¥è·å–æœ€æ–°å†…å®¹">ğŸ”„ åˆ·æ–°é¡µé¢</button></section>
            {% endif %}

            <!-- å†å²åè¯ -->
            {% if history_terms %}
            <section class="history-section" aria-labelledby="history-title"><h2 id="history-title" class="section-title">
                    ğŸ“– æœ€è¿‘åè¯
                </h2><div class="history-grid" role="grid" aria-label="å†å²åè¯åˆ—è¡¨">
                    {% for term in history_terms %}
                    <article class="history-card"
                             role="gridcell"
                             tabindex="0"
                             onclick="showTermDetail({{ term.id }}, '{{ term.term }}', '{{ term.explanation|escapejs }}', '{{ term.category }}', '{{ term.difficulty_level }}')"><h3 class="history-term">{{ term.term }}</h3><time class="history-date" datetime="{{ term.display_date|date:'Y-m-d' }}">{{ term.display_date|date:"Yå¹´mæœˆdæ—¥" }}</time><p class="history-preview">{{ term.explanation|truncatewords:20 }}</p></article>
                    {% endfor %}
                </div><div style="text-align: center; margin-top: 40px;"><a href="{% url 'knowledge_app:daily_term_history' %}" class="btn btn-primary" aria-label="æŸ¥çœ‹æ›´å¤šå†å²åè¯">
                        ğŸ“š æŸ¥çœ‹æ›´å¤šå†å²åè¯
                    </a></div></section>
            {% endif %}
        </div></div></main><!-- åè¯è¯¦æƒ…æ¨¡æ€æ¡† --><div id="termModal" class="modal-overlay" onclick="closeTermModal()"><div class="modal-card" onclick="event.stopPropagation()"><div class="modal-header"><div class="modal-icon">ğŸ“š</div><div class="modal-title-section"><h2 class="modal-title" id="termModalTitle">åè¯æ ‡é¢˜</h2><div class="modal-meta"><span class="modal-category" id="termModalCategory">åˆ†ç±»</span><span class="modal-difficulty" id="termModalDifficulty">éš¾åº¦</span></div></div><button class="modal-close" onclick="closeTermModal()">Ã—</button></div><div class="modal-content"><div class="modal-description" id="termModalDescription">
                åè¯è¯¦ç»†è§£é‡Š...
            </div><div class="modal-actions"><button class="modal-btn primary" onclick="likeTermFromModal()">
                    ğŸ‘ ç‚¹èµ
                </button><button class="modal-btn secondary" onclick="closeTermModal()">
                    ğŸ“š å…³é—­
                </button></div></div></div></div></div>
{% endblock %}

{% block extra_js %}
<script>async function likeTerm(termId) { try { const response = await fetch(`/api/daily-term/like/${termId}/`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') } }); const data = await response.json(); if (data.success) { document.getElementById('like-count').textContent = data.like_count; showMessage('ç‚¹èµæˆåŠŸï¼', 'success'); } else { showMessage(data.message || 'ç‚¹èµå¤±è´¥', 'error'); } } catch (error) { console.error('Like error:', error); showMessage('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'error'); } } let currentTermId = null; function showTermDetail(termId, title, explanation, category, difficulty) { currentTermId = termId; document.getElementById('termModalTitle').textContent = title; document.getElementById('termModalDescription').textContent = explanation; document.getElementById('termModalCategory').textContent = getCategoryDisplayName(category); const difficultyElement = document.getElementById('termModalDifficulty'); difficultyElement.textContent = getDifficultyDisplayName(difficulty); difficultyElement.className = `modal-difficulty ${difficulty}`; const modal = document.getElementById('termModal'); modal.classList.add('show'); document.body.style.overflow = 'hidden'; } function closeTermModal() { const modal = document.getElementById('termModal'); modal.classList.remove('show'); document.body.style.overflow = ''; currentTermId = null; } function likeTermFromModal() { if (currentTermId) { likeTerm(currentTermId); } } function getCategoryDisplayName(category) { const categoryMap = { 'ç®—æ³•è®¾è®¡': 'ç®—æ³•è®¾è®¡', 'æ•°æ®ç»“æ„': 'æ•°æ®ç»“æ„', 'è®¡ç®—æœºç½‘ç»œ': 'è®¡ç®—æœºç½‘ç»œ', 'æ“ä½œç³»ç»Ÿ': 'æ“ä½œç³»ç»Ÿ', 'æ•°æ®åº“ç³»ç»Ÿ': 'æ•°æ®åº“ç³»ç»Ÿ', 'ä¿¡æ¯å®‰å…¨': 'ä¿¡æ¯å®‰å…¨', 'è½¯ä»¶å·¥ç¨‹': 'è½¯ä»¶å·¥ç¨‹', 'äººå·¥æ™ºèƒ½': 'äººå·¥æ™ºèƒ½', 'ç¼–ç¨‹åŸºç¡€': 'ç¼–ç¨‹åŸºç¡€', 'è®¡ç®—æœºåŸºç¡€': 'è®¡ç®—æœºåŸºç¡€' }; return categoryMap[category] || category || 'è®¡ç®—æœºåŸºç¡€'; } function getDifficultyDisplayName(difficulty) { const difficultyMap = { 'beginner': 'åˆçº§', 'intermediate': 'ä¸­çº§', 'advanced': 'é«˜çº§' }; return difficultyMap[difficulty] || difficulty || 'ä¸­çº§'; } function getCookie(name) { let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue; } function showMessage(message, type) { const messageDiv = document.createElement('div'); messageDiv.style.cssText = ` position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: var(--border-radius-sm); color: var(--text-inverse); font-weight: 600; z-index: 10000; animation: slideIn 0.3s ease; background: ${type === 'success' ? 'var(--accent-color)' : '#e74c3c'}; `; messageDiv.textContent = message; document.body.appendChild(messageDiv); setTimeout(() => { messageDiv.remove(); }, 3000); } function scrollToHistory() { const historySection = document.querySelector('.history-section'); if (historySection) { historySection.scrollIntoView({ behavior: 'smooth', block: 'start' }); } } function testChatbot() { console.log('ğŸ§ª å¼€å§‹æµ‹è¯•AIåŠ©æ‰‹åŠŸèƒ½'); const elements = { sidebar: document.getElementById('chatbotSidebar'), toggleBtn: document.getElementById('aiToggleBtn'), container: document.querySelector('.today-term-container'), startArea: document.getElementById('chatStartArea'), chatArea: document.getElementById('chatArea'), chatInput: document.getElementById('chatInput'), sendButton: document.getElementById('sendButton') }; console.log('ğŸ” å…ƒç´ æ£€æŸ¥ç»“æœ:', elements); const allElementsExist = Object.values(elements).every(el => el !== null); if (allElementsExist) { console.log('âœ… æ‰€æœ‰å…³é”®å…ƒç´ æ£€æŸ¥é€šè¿‡ï¼'); return true; } else { console.error('âŒ ç¼ºå°‘å…³é”®å…ƒç´ ï¼ŒAIåŠ©æ‰‹å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ'); return false; } } document.addEventListener('DOMContentLoaded', function() { console.log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–'); initializeChatInput(); setTimeout(() => { testChatbot(); }, 1000); preloadResources(); document.addEventListener('keydown', function(e) { if (e.key === 'Escape') { closeTermModal(); if (chatbotVisible) { toggleChatbot(); } } }); document.querySelectorAll('.history-card').forEach(card => { card.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.click(); } }); }); const aiToggleBtn = document.getElementById('aiToggleBtn'); if (aiToggleBtn) { console.log('âœ… AIåˆ‡æ¢æŒ‰é’®æ‰¾åˆ°'); aiToggleBtn.addEventListener('click', function() { console.log('ğŸ–±ï¸ AIæŒ‰é’®è¢«ç‚¹å‡»'); const expanded = this.getAttribute('aria-expanded') === 'true'; this.setAttribute('aria-expanded', !expanded); }); } else { console.error('âŒ æ‰¾ä¸åˆ°AIåˆ‡æ¢æŒ‰é’®'); } console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ'); }); let currentTerm = ''; let currentExplanation = ''; let chatbotVisible = false; let chatbotInitialized = false; let availableThemes = {}; let currentTheme = 'friendly'; function generateConversationId() { if (!window.conversationId) { window.conversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); } return window.conversationId; } function initializeChatInput() { const chatInput = document.getElementById('chatInput'); const sendButton = document.getElementById('sendButton'); if (!chatInput || !sendButton) return; chatInput.addEventListener('input', function() { const text = this.value.trim(); sendButton.disabled = text.length === 0; this.style.height = 'auto'; this.style.height = Math.min(this.scrollHeight, 100) + 'px'; }); chatInput.addEventListener('keydown', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); if (!sendButton.disabled) { sendMessage(); } } }); sendButton.disabled = true; } function prepareSendMessage() { const chatInput = document.getElementById('chatInput'); const sendButton = document.getElementById('sendButton'); if (!chatInput || !sendButton) return false; const message = chatInput.value.trim(); if (!message) return false; chatInput.style.height = 'auto'; return true; } function addUserMessage(message) { const chatMessages = document.getElementById('chatMessages'); if (!chatMessages) return; const messageDiv = document.createElement('div'); messageDiv.className = 'user-message'; messageDiv.innerHTML = ` <div class="message-avatar">ğŸ‘¤</div><div class="message-content">${escapeHtml(message)}</div> `; chatMessages.appendChild(messageDiv); chatMessages.scrollTop = chatMessages.scrollHeight; } function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; } function openChatbot(term, explanation) { toggleChatbot(); } function toggleChatbot() { console.log('ğŸ¤– toggleChatbot è¢«è°ƒç”¨ï¼Œå½“å‰çŠ¶æ€:', chatbotVisible); const sidebar = document.getElementById('chatbotSidebar'); const container = document.querySelector('.today-term-container'); const toggleBtn = document.getElementById('aiToggleBtn'); console.log('ğŸ” å…ƒç´ æ£€æŸ¥:', { sidebar: !!sidebar, container: !!container, toggleBtn: !!toggleBtn }); if (!sidebar) { console.error('âŒ æ‰¾ä¸åˆ°AIåŠ©æ‰‹ä¾§è¾¹æ å…ƒç´ ï¼'); alert('æ‰¾ä¸åˆ°AIåŠ©æ‰‹ä¾§è¾¹æ ï¼è¯·æ£€æŸ¥é¡µé¢æ˜¯å¦æ­£ç¡®åŠ è½½ã€‚'); return; } if (!chatbotVisible) { console.log('ğŸ“– æ˜¾ç¤ºAIåŠ©æ‰‹ä¾§è¾¹æ '); sidebar.classList.add('show'); sidebar.style.display = 'flex'; sidebar.style.visibility = 'visible'; if (container) { container.classList.add('with-sidebar'); console.log('âœ… å®¹å™¨æ·»åŠ äº† with-sidebar ç±»'); } if (toggleBtn) { toggleBtn.innerHTML = 'ğŸ¤– å…³é—­åŠ©æ‰‹'; toggleBtn.classList.add('active'); toggleBtn.setAttribute('aria-expanded', 'true'); } chatbotVisible = true; if (!chatbotInitialized) { console.log('ğŸš€ åˆå§‹åŒ–èŠå¤©æœºå™¨äºº'); startChatbot(); } console.log('âœ… AIåŠ©æ‰‹å·²æ˜¾ç¤º'); } else { console.log('ğŸ“– éšè—AIåŠ©æ‰‹ä¾§è¾¹æ '); sidebar.classList.remove('show'); sidebar.style.display = 'none'; if (container) { container.classList.remove('with-sidebar'); } if (toggleBtn) { toggleBtn.innerHTML = 'ğŸ¤– AIåŠ©æ‰‹'; toggleBtn.classList.remove('active'); toggleBtn.setAttribute('aria-expanded', 'false'); } chatbotVisible = false; console.log('âœ… AIåŠ©æ‰‹å·²éšè—'); } } function startChatbot() { console.log('ğŸš€ startChatbot è¢«è°ƒç”¨ï¼Œå·²åˆå§‹åŒ–:', chatbotInitialized); if (chatbotInitialized) { console.log('âš ï¸ èŠå¤©æœºå™¨äººå·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡'); return; } const term = '{{ today_term.term|default:"" }}'; const explanation = '{{ today_term.explanation|escapejs|default:"" }}'; console.log('ğŸ“š å½“å‰åè¯:', term); currentTerm = term; currentExplanation = explanation; const startArea = document.getElementById('chatStartArea'); const chatArea = document.getElementById('chatArea'); console.log('ğŸ” UIå…ƒç´ æ£€æŸ¥:', { startArea: !!startArea, chatArea: !!chatArea }); if (startArea) { startArea.style.display = 'none'; console.log('âœ… éšè—å¯åŠ¨æŒ‰é’®'); } if (chatArea) { chatArea.classList.remove('hidden'); chatArea.style.display = 'flex'; console.log('âœ… æ˜¾ç¤ºèŠå¤©åŒºåŸŸ'); } loadSuggestedQuestions(term, explanation); setTimeout(() => { const chatInput = document.getElementById('chatInput'); if (chatInput) { chatInput.focus(); console.log('âœ… è¾“å…¥æ¡†å·²èšç„¦'); chatInput.addEventListener('keypress', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }); } }, 300); chatbotInitialized = true; console.log('âœ… èŠå¤©æœºå™¨äººåˆå§‹åŒ–å®Œæˆ'); } async function loadChatbotThemes() { availableThemes = { 'friendly': { name: 'å‹å¥½åŠ©æ‰‹', avatar: 'ğŸ¤–', description: 'å‹å¥½è€å¿ƒçš„å­¦ä¹ ä¼™ä¼´' } }; currentTheme = 'friendly'; console.log('AIåŠ©æ‰‹ä¸»é¢˜å·²åŠ è½½'); } async function checkAPIStatus() { try { const response = await fetch('/api/chatbot/status/'); const data = await response.json(); if (data.success && data.status.available) { console.log('âœ… GLM APIæœåŠ¡å¯ç”¨'); const statusMessage = document.createElement('div'); statusMessage.className = 'api-status-message success'; statusMessage.innerHTML = 'âœ… GLM AIæœåŠ¡å·²è¿æ¥'; document.getElementById('chatMessages').appendChild(statusMessage); } else { console.warn('âš ï¸ GLM APIæœåŠ¡ä¸å¯ç”¨ï¼Œå°†ä½¿ç”¨æœ¬åœ°å›å¤'); const statusMessage = document.createElement('div'); statusMessage.className = 'api-status-message warning'; statusMessage.innerHTML = 'âš ï¸ AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œå°†æä¾›æœ¬åœ°æ™ºèƒ½å›å¤'; document.getElementById('chatMessages').appendChild(statusMessage); } } catch (error) { console.error('âŒ æ— æ³•æ£€æŸ¥APIçŠ¶æ€:', error); const statusMessage = document.createElement('div'); statusMessage.className = 'api-status-message error'; statusMessage.innerHTML = 'âŒ æ— æ³•è¿æ¥AIæœåŠ¡ï¼Œå°†ä½¿ç”¨æœ¬åœ°å›å¤æ¨¡å¼'; document.getElementById('chatMessages').appendChild(statusMessage); } } function updateThemeUI(themeInfo) { const avatar = document.getElementById('chatbotAvatar'); const name = document.getElementById('chatbotName'); if (avatar && themeInfo) { avatar.textContent = themeInfo.avatar; } if (name && themeInfo) { name.textContent = themeInfo.name; } } function renderThemeOptions() { const optionsContainer = document.getElementById('themeOptions'); if (!optionsContainer || !availableThemes) return; optionsContainer.innerHTML = ''; Object.keys(availableThemes).forEach(themeKey => { const theme = availableThemes[themeKey]; const option = document.createElement('div'); option.className = `theme-option ${themeKey === currentTheme ? 'active' : ''}`; option.onclick = () => selectTheme(themeKey); option.innerHTML = ` <div class="theme-avatar">${theme.avatar}</div><div class="theme-info"><div class="theme-name">${theme.name}</div><div class="theme-description">${theme.personality}</div></div> `; optionsContainer.appendChild(option); }); } async function selectTheme(themeKey) { try { const response = await fetch('/api/themes/chatbot/set/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken') }, body: JSON.stringify({ theme: themeKey }) }); const data = await response.json(); if (data.success) { currentTheme = themeKey; updateThemeUI(data.theme_info); renderThemeOptions(); showThemeChangeMessage(data.theme_info); toggleThemeSelector(); } else { console.error('åˆ‡æ¢ä¸»é¢˜å¤±è´¥:', data.error); } } catch (error) { console.error('åˆ‡æ¢ä¸»é¢˜å‡ºé”™:', error); } } function toggleThemeSelector() { const selector = document.getElementById('themeSelector'); if (selector) { selector.classList.toggle('show'); } } function showThemeChangeMessage(themeInfo) { const chatMessages = document.getElementById('chatMessages'); if (chatMessages && themeInfo) { const messageElement = document.createElement('div'); messageElement.className = 'ai-message theme-change-message'; messageElement.innerHTML = ` <div class="message-avatar">${themeInfo.avatar}</div><div class="message-content"><p>ğŸ¨ å·²åˆ‡æ¢åˆ°"${themeInfo.name}"æ¨¡å¼</p><p>${themeInfo.greeting}</p></div> `; chatMessages.appendChild(messageElement); scrollToBottom(); setTimeout(() => { messageElement.style.opacity = '0.6'; }, 3000); } } function closeChatbot() { toggleChatbot(); } function loadSuggestedQuestions(term, explanation) { const questionsList = document.getElementById('questionsList'); if (!questionsList) return; const questions = [ `${term}çš„ä¸»è¦ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ`, `${term}åœ¨å®é™…é¡¹ç›®ä¸­å¦‚ä½•åº”ç”¨ï¼Ÿ`, `å­¦ä¹ ${term}éœ€è¦ä»€ä¹ˆåŸºç¡€çŸ¥è¯†ï¼Ÿ`, `${term}æœ‰å“ªäº›å¸¸è§çš„è¯¯åŒºï¼Ÿ`, `å¦‚ä½•æ›´å¥½åœ°ç†è§£${term}è¿™ä¸ªæ¦‚å¿µï¼Ÿ` ]; questionsList.innerHTML = ''; questions.forEach(question => { const questionElement = document.createElement('div'); questionElement.className = 'question-item'; questionElement.textContent = question; questionElement.onclick = () => askQuestion(question); questionsList.appendChild(questionElement); }); } function askQuestion(question) { document.getElementById('chatInput').value = question; sendMessage(); } async function sendMessage() { const input = document.getElementById('chatInput'); const sendButton = document.getElementById('sendButton'); if (!input) return; const message = input.value.trim(); if (!message) return; input.disabled = true; if (sendButton) sendButton.disabled = true; input.value = ''; input.style.height = 'auto'; addUserMessage(message); showTypingIndicator(); try { console.log('ğŸ¤– æ­£åœ¨è°ƒç”¨GLM API...'); const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 30000); const response = await fetch('/api/chatbot/ask/', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCookie('csrftoken'), 'Accept': 'application/json' }, body: JSON.stringify({ term: currentTerm, explanation: currentExplanation, question: message, theme: currentTheme || 'friendly' }), signal: controller.signal }); clearTimeout(timeoutId); hideTypingIndicator(); if (!response.ok) { throw new Error(`HTTP ${response.status}: ${response.statusText}`); } const data = await response.json(); console.log('âœ… GLM APIå“åº”:', data); if (data.success && data.answer) { addAIMessage(data.answer); } else if (data.error) { console.warn('âš ï¸ APIè¿”å›é”™è¯¯:', data.error); const fallbackResponse = generateSmartResponse(message, currentTerm, currentExplanation); addAIMessage(`AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œä¸ºæ‚¨æä¾›æ™ºèƒ½å›å¤ï¼š\n\n${fallbackResponse}`); } else { throw new Error('APIå“åº”æ ¼å¼ä¸æ­£ç¡®'); } } catch (error) { hideTypingIndicator(); console.error('âŒ GLM APIè°ƒç”¨å¤±è´¥:', error); let errorMessage = ''; if (error.name === 'AbortError') { errorMessage = 'è¯·æ±‚è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•'; } else if (error.message.includes('HTTP')) { errorMessage = 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨'; } else { errorMessage = 'ç½‘ç»œè¿æ¥é—®é¢˜'; } const fallbackResponse = generateSmartResponse(message, currentTerm, currentExplanation); addAIMessage(`${errorMessage}ï¼Œä¸ºæ‚¨æä¾›æ™ºèƒ½å›å¤ï¼š\n\n${fallbackResponse}`); } } function generateSmartResponse(question, term, explanation) { const questionLower = question.toLowerCase(); const isWhatQuestion = questionLower.includes('ä»€ä¹ˆ') || questionLower.includes('æ˜¯ä»€ä¹ˆ') || questionLower.includes('what'); const isHowQuestion = questionLower.includes('æ€ä¹ˆ') || questionLower.includes('å¦‚ä½•') || questionLower.includes('how'); const isWhyQuestion = questionLower.includes('ä¸ºä»€ä¹ˆ') || questionLower.includes('why'); const isExampleQuestion = questionLower.includes('ä¾‹å­') || questionLower.includes('ä¸¾ä¾‹') || questionLower.includes('example'); let response = ''; if (isWhatQuestion) { response = `å…³äº"${term}"çš„å®šä¹‰ï¼š\n\n${explanation}\n\nè¿™ä¸ªæ¦‚å¿µåœ¨è®¡ç®—æœºç§‘å­¦ä¸­æ‰®æ¼”ç€é‡è¦è§’è‰²ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬ç†è§£å’Œè§£å†³ç›¸å…³çš„æŠ€æœ¯é—®é¢˜ã€‚`; } else if (isHowQuestion) { response = `å…³äºå¦‚ä½•ç†è§£"${term}"ï¼š\n\né¦–å…ˆï¼Œ${explanation}\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æ¥æŒæ¡è¿™ä¸ªæ¦‚å¿µï¼š\n1. ç†è§£åŸºæœ¬å®šä¹‰\n2. å­¦ä¹ ç›¸å…³ç¤ºä¾‹\n3. å®è·µåº”ç”¨åœºæ™¯`; } else if (isWhyQuestion) { response = `"${term}"ä¹‹æ‰€ä»¥é‡è¦ï¼Œæ˜¯å› ä¸ºï¼š\n\n${explanation}\n\nå®ƒåœ¨è®¡ç®—æœºç§‘å­¦é¢†åŸŸä¸­è§£å†³äº†ç‰¹å®šçš„é—®é¢˜ï¼Œä¸ºæˆ‘ä»¬æä¾›äº†æœ‰æ•ˆçš„è§£å†³æ–¹æ¡ˆå’Œæ€ç»´æ¡†æ¶ã€‚`; } else if (isExampleQuestion) { response = `å…³äº"${term}"çš„ä¾‹å­ï¼š\n\nåŸºæœ¬æ¦‚å¿µï¼š${explanation}\n\nåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™ä¸ªæ¦‚å¿µç»å¸¸å‡ºç°åœ¨å„ç§è®¡ç®—æœºç³»ç»Ÿå’Œè½¯ä»¶å¼€å‘åœºæ™¯ä¸­ï¼Œå¸®åŠ©å¼€å‘è€…æ›´å¥½åœ°è®¾è®¡å’Œå®ç°è§£å†³æ–¹æ¡ˆã€‚`; } else { const responses = [ `å…³äº"${term}"ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼\n\n${explanation}\n\nå¦‚æœä½ æƒ³äº†è§£æ›´å¤šç»†èŠ‚ï¼Œå»ºè®®æ·±å…¥å­¦ä¹ ç›¸å…³çš„ç†è®ºåŸºç¡€å’Œå®è·µåº”ç”¨ã€‚`, `è®©æˆ‘æ¥å¸®ä½ ç†è§£"${term}"ï¼š\n\n${explanation}\n\nè¿™ä¸ªæ¦‚å¿µåœ¨è®¡ç®—æœºç§‘å­¦ä¸­æœ‰ç€å¹¿æ³›çš„åº”ç”¨ï¼ŒæŒæ¡å®ƒå¯¹äºç†è§£ç›¸å…³æŠ€æœ¯éå¸¸é‡è¦ã€‚`, `ä½ é—®çš„å…³äº"${term}"çš„é—®é¢˜å¾ˆæœ‰æ„æ€ï¼\n\n${explanation}\n\nå»ºè®®ä½ å¯ä»¥é€šè¿‡å®é™…æ¡ˆä¾‹å’Œç»ƒä¹ æ¥åŠ æ·±å¯¹è¿™ä¸ªæ¦‚å¿µçš„ç†è§£ã€‚` ]; response = responses[Math.floor(Math.random() * responses.length)]; } return response; } function addUserMessage(message) { const chatMessages = document.getElementById('chatMessages'); const messageElement = document.createElement('div'); messageElement.className = 'user-message'; messageElement.innerHTML = ` <div class="message-avatar">ğŸ‘¤</div><div class="message-content"><p>${escapeHtml(message)}</p></div> `; chatMessages.appendChild(messageElement); scrollToBottom(); } function addAIMessage(message) { const chatMessages = document.getElementById('chatMessages'); const messageElement = document.createElement('div'); messageElement.className = 'ai-message'; messageElement.innerHTML = ` <div class="message-avatar">ğŸ¤–</div><div class="message-content"><p>${escapeHtml(message).replace(/\n/g, '</p><p>')}</p></div> `; chatMessages.appendChild(messageElement); scrollToBottom(); enableChatInput(); } function enableChatInput() { const chatInput = document.getElementById('chatInput'); const sendButton = document.getElementById('sendButton'); if (chatInput) { chatInput.disabled = false; chatInput.focus(); } if (sendButton) { const hasText = chatInput && chatInput.value.trim().length > 0; sendButton.disabled = !hasText; } } function showTypingIndicator() { const chatMessages = document.getElementById('chatMessages'); const typingElement = document.createElement('div'); typingElement.id = 'typingIndicator'; typingElement.className = 'ai-message typing-indicator'; typingElement.innerHTML = ` <div class="message-avatar">ğŸ¤–</div><div class="message-content"><div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div></div> `; chatMessages.appendChild(typingElement); scrollToBottom(); } function hideTypingIndicator() { const typingIndicator = document.getElementById('typingIndicator'); if (typingIndicator) { typingIndicator.remove(); } } function scrollToBottom() { const chatMessages = document.getElementById('chatMessages'); chatMessages.scrollTop = chatMessages.scrollHeight; } function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; } document.addEventListener('DOMContentLoaded', function() { const chatInput = document.getElementById('chatInput'); if (chatInput) { chatInput.addEventListener('keypress', function(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }); } document.addEventListener('keydown', function(e) { if (e.key === 'Escape') { const sidebar = document.getElementById('chatbotSidebar'); if (sidebar && chatbotVisible) { toggleChatbot(); } } }); }); function scrollToHistory() { const historySection = document.querySelector('.history-section'); if (historySection) { historySection.scrollIntoView({ behavior: 'smooth', block: 'start' }); } else { showMessage('å†å²è®°å½•åŒºåŸŸä¸å­˜åœ¨', 'info'); } } document.addEventListener('DOMContentLoaded', function() { addBackToTopButton(); optimizeScrolling(); preloadResources(); }); function addBackToTopButton() { const backToTop = document.createElement('button'); backToTop.innerHTML = 'â†‘'; backToTop.className = 'back-to-top'; backToTop.onclick = () => { window.scrollTo({ top: 0, behavior: 'smooth' }); }; const style = document.createElement('style'); style.textContent = ` .back-to-top { position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: var(--text-inverse); border: none; font-size: 1.2rem; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; opacity: 0; visibility: hidden; z-index: 1000; } .back-to-top.show { opacity: 1; visibility: visible; } .back-to-top:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4); } `; document.head.appendChild(style); document.body.appendChild(backToTop); window.addEventListener('scroll', () => { if (window.pageYOffset > 300) { backToTop.classList.add('show'); } else { backToTop.classList.remove('show'); } }); } function optimizeScrolling() { document.querySelectorAll('a[href^="#"]').forEach(anchor => { anchor.addEventListener('click', function (e) { e.preventDefault(); const target = document.querySelector(this.getAttribute('href')); if (target) { target.scrollIntoView({ behavior: 'smooth', block: 'start' }); } }); }); } function preloadResources() { const criticalPages = [ '{% url "knowledge_app:index" %}', '{% url "knowledge_app:cs_universe" %}' ]; criticalPages.forEach(url => { const link = document.createElement('link'); link.rel = 'prefetch'; link.href = url; document.head.appendChild(link); }); const fontLink = document.createElement('link'); fontLink.rel = 'preload'; fontLink.as = 'font'; fontLink.type = 'font/woff2'; fontLink.crossOrigin = 'anonymous'; document.head.appendChild(fontLink); } function trackPerformance() { if ('performance' in window) { window.addEventListener('load', function() { setTimeout(function() { const perfData = performance.getEntriesByType('navigation')[0]; console.log('é¡µé¢åŠ è½½æ—¶é—´:', perfData.loadEventEnd - perfData.fetchStart, 'ms'); }, 0); }); } } trackPerformance(); function navigateWithTransition(url) { document.body.style.opacity = '0.8'; document.body.style.transform = 'scale(0.98)'; document.body.style.transition = 'all 0.3s ease'; setTimeout(() => { window.location.href = url; }, 150); } function handlePdfExport(element) { console.log('PDFå¯¼å‡ºæŒ‰é’®è¢«ç‚¹å‡»'); console.log('å¯¼å‡ºURL:', element.href); const originalText = element.innerHTML; element.innerHTML = '<span>â³</span><span>å¯¼å‡ºä¸­...</span>'; element.style.pointerEvents = 'none'; setTimeout(() => { element.innerHTML = originalText; element.style.pointerEvents = 'auto'; }, 3000); return true; } document.addEventListener('DOMContentLoaded', function() { document.querySelectorAll('.breadcrumb-item, .nav-btn').forEach(link => { if (link.href && !link.href.startsWith('#')) { link.addEventListener('click', function(e) { e.preventDefault(); navigateWithTransition(this.href); }); } }); });</script>
{% endblock %}
