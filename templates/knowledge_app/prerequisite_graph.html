{% extends 'knowledge_app/base.html' %}

{% block title %}前置关系图谱 - 计算机科学学习平台{% endblock %}

{% block extra_css %}
<style>.graph-container {max-width:1400px;margin:0 auto;padding:20px}.graph-header {background:linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);backdrop-filter:blur(20px);border-radius:var(--border-radius-lg);padding:40px;margin-bottom:30px;text-align:center;color:var(--text-inverse)}.controls-panel {background:var(--bg-card);border-radius:var(--border-radius);padding:20px;margin-bottom:30px;box-shadow:var(--shadow-md);display:flex;gap:20px;align-items:center;flex-wrap:wrap}.control-group {display:flex;align-items:center;gap:10px}.control-label {font-weight:600;color:var(--text-primary)}.control-select {padding:8px 12px;border:2px solid #e2e8f0;border-radius:var(--border-radius-sm);background:var(--bg-card);color:var(--text-primary);font-size:0.9rem}.control-select:focus {outline:none;border-color:var(--primary-color)}.graph-canvas {background:var(--bg-card);border-radius:var(--border-radius-lg);padding:20px;box-shadow:var(--shadow-md);min-height:600px;position:relative}#prerequisite-graph {width:100%;height:600px;border:1px solid var(--border-color);border-radius:var(--border-radius)}.legend {position:absolute;top:30px;right:30px;background:var(--bg-card);border-radius:var(--border-radius);padding:15px;box-shadow:var(--shadow-md);font-size:0.8rem}.legend-item {display:flex;align-items:center;gap:8px;margin-bottom:8px}.legend-color {width:16px;height:16px;border-radius:50%}.info-panel {background:var(--bg-card);border-radius:var(--border-radius);padding:20px;margin-top:30px;box-shadow:var(--shadow-md)}.concept-details {display:none;background:#f8fafc;border-radius:var(--border-radius);padding:20px;margin-top:15px;border-left:4px solid var(--primary-color)}.concept-name {font-size:1.3rem;font-weight:700;color:var(--text-primary);margin-bottom:10px}.concept-description {color:var(--text-secondary);margin-bottom:15px;line-height:1.6}.concept-meta {display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:15px;margin-bottom:15px}.meta-item {display:flex;align-items:center;gap:8px;font-size:0.9rem;color:var(--text-muted)}.prerequisites-list, .dependents-list {margin-top:15px}.list-title {font-weight:600;color:var(--text-primary);margin-bottom:8px}.concept-tag {display:inline-block;background:#edf2f7;color:var(--text-secondary);padding:4px 8px;border-radius:12px;font-size:0.8rem;margin:2px}.loading-spinner {display:flex;justify-content:center;align-items:center;height:200px;color:var(--primary-color)}@keyframes spin {0% {transform:rotate(0deg)}100% {transform:rotate(360deg)}}.spinner {border:4px solid #f3f3f3;border-top:4px solid var(--primary-color);border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin-right:10px}@media (max-width:768px) {.graph-container {padding:10px}.controls-panel {flex-direction:column;align-items:stretch}.control-group {justify-content:space-between}#prerequisite-graph {height:400px}.legend {position:static;margin-top:15px}}</style>
{% endblock %}

{% block content %}
<div class="graph-container"><!-- 页面头部 --><div class="graph-header"><h1>🕸️ 前置关系图谱</h1><p>可视化展示知识点之间的前置依赖关系，帮助理解学习顺序</p></div><!-- 控制面板 --><div class="controls-panel"><div class="control-group"><label class="control-label">分类:</label><select id="category-select" class="control-select"><option value="all">全部</option><option value="data_structure">数据结构</option><option value="algorithm">算法</option><option value="programming">编程</option><option value="system">系统</option></select></div><div class="control-group"><label class="control-label">布局:</label><select id="layout-select" class="control-select"><option value="hierarchical">层次布局</option><option value="force">力导向布局</option><option value="circular">环形布局</option></select></div><div class="control-group"><label class="control-label">显示:</label><select id="display-select" class="control-select"><option value="all">所有关系</option><option value="prerequisite">仅前置关系</option><option value="related">仅相关关系</option></select></div><button id="reset-view" class="control-select" style="background: var(--primary-color); color: var(--text-inverse); border: none; cursor: pointer;">
            重置视图
        </button></div><!-- 图谱画布 --><div class="graph-canvas"><div id="loading" class="loading-spinner"><div class="spinner"></div><span>正在加载知识图谱...</span></div><div id="prerequisite-graph" style="display: none;"></div><!-- 图例 --><div class="legend"><div class="legend-item"><div class="legend-color" style="background: var(--accent-color);"></div><span>入门级</span></div><div class="legend-item"><div class="legend-color" style="background: #45b7d1;"></div><span>中级</span></div><div class="legend-item"><div class="legend-color" style="background: #9b59b6;"></div><span>高级</span></div><div class="legend-item"><div class="legend-color" style="background: #e74c3c;"></div><span>专家级</span></div><hr style="margin: 10px 0; border: none; border-top: 1px solid #e2e8f0;"><div class="legend-item"><div style="width: 20px; height: 2px; background: var(--primary-color);"></div><span>前置关系</span></div><div class="legend-item"><div style="width: 20px; height: 2px; background: #95a5a6; border-style: dashed;"></div><span>相关关系</span></div></div></div><!-- 信息面板 --><div class="info-panel"><h3>📋 概念详情</h3><p id="no-selection" style="color: var(--text-muted);">点击图中的节点查看详细信息</p><div id="concept-details" class="concept-details"><div class="concept-name" id="concept-name"></div><div class="concept-description" id="concept-description"></div><div class="concept-meta"><div class="meta-item"><span>📊</span><span id="concept-difficulty"></span></div><div class="meta-item"><span>⏱️</span><span id="concept-time"></span></div><div class="meta-item"><span>⭐</span><span id="concept-importance"></span></div><div class="meta-item"><span>📚</span><span id="concept-category"></span></div></div><div class="prerequisites-list"><div class="list-title">🔗 前置知识:</div><div id="prerequisites-tags"></div></div><div class="dependents-list"><div class="list-title">📈 后续概念:</div><div id="dependents-tags"></div></div></div></div></div><script></script><script>let network = null; let nodes = null; let edges = null; let graphData = null; const difficultyColors = { 'beginner': 'var(--accent-color)', 'intermediate': '#45b7d1', 'advanced': '#9b59b6', 'expert': '#e74c3c' }; async function initGraph() { try { const response = await fetch('/api/graph/data/'); graphData = await response.json(); if (graphData.success) { renderGraph(graphData.data); } else { showError('加载数据失败: ' + graphData.message); } } catch (error) { showError('网络错误: ' + error.message); } } function renderGraph(data) { const nodeArray = data.nodes.map(node => ({ id: node.id, label: node.name, color: { background: difficultyColors[node.difficulty_level] || '#95a5a6', border: '#2c3e50', highlight: { background: '#f39c12', border: '#e67e22' } }, font: { color: '#2c3e50', size: 12, face: 'Arial' }, shape: 'dot', size: Math.max(15, node.importance_weight * 3), title: `${node.name}\n难度: ${node.difficulty_level}\n预计学时: ${node.estimated_learning_time}小时`, ...node })); const edgeArray = data.edges.map(edge => ({ id: edge.id, from: edge.source, to: edge.target, color: { color: edge.relation_type === 'prerequisite' ? 'var(--primary-color)' : '#95a5a6', highlight: '#e74c3c' }, width: edge.strength * 3, arrows: { to: { enabled: true, scaleFactor: 0.8 } }, dashes: edge.relation_type === 'related', title: `${edge.relation_type}: ${edge.description || ''}`, ...edge })); nodes = new vis.DataSet(nodeArray); edges = new vis.DataSet(edgeArray); const container = document.getElementById('prerequisite-graph'); const graphData = { nodes: nodes, edges: edges }; const options = { layout: { hierarchical: { enabled: true, direction: 'UD', sortMethod: 'directed', levelSeparation: 150, nodeSpacing: 200 } }, physics: { enabled: false }, interaction: { hover: true, selectConnectedEdges: true }, nodes: { borderWidth: 2, shadow: true }, edges: { shadow: true, smooth: { type: 'cubicBezier', forceDirection: 'vertical', roundness: 0.4 } } }; network = new vis.Network(container, graphData, options); network.on('click', function(params) { if (params.nodes.length > 0) { const nodeId = params.nodes[0]; showConceptDetails(nodeId); } else { hideConceptDetails(); } }); document.getElementById('loading').style.display = 'none'; document.getElementById('prerequisite-graph').style.display = 'block'; } function showConceptDetails(nodeId) { const node = nodes.get(nodeId); if (!node) return; document.getElementById('no-selection').style.display = 'none'; document.getElementById('concept-details').style.display = 'block'; document.getElementById('concept-name').textContent = node.name; document.getElementById('concept-description').textContent = node.description || '暂无描述'; document.getElementById('concept-difficulty').textContent = `难度: ${node.difficulty_level}`; document.getElementById('concept-time').textContent = `预计学时: ${node.estimated_learning_time}小时`; document.getElementById('concept-importance').textContent = `重要度: ${node.importance_weight}`; document.getElementById('concept-category').textContent = `分类: ${node.category}`; const connectedEdges = edges.get({ filter: edge => edge.from === nodeId || edge.to === nodeId }); const prerequisites = []; const dependents = []; connectedEdges.forEach(edge => { if (edge.to === nodeId && edge.relation_type === 'prerequisite') { const prereqNode = nodes.get(edge.from); if (prereqNode) prerequisites.push(prereqNode.name); } else if (edge.from === nodeId && edge.relation_type === 'prerequisite') { const depNode = nodes.get(edge.to); if (depNode) dependents.push(depNode.name); } }); const prereqContainer = document.getElementById('prerequisites-tags'); prereqContainer.innerHTML = prerequisites.length > 0 ? prerequisites.map(name => `<span class="concept-tag">${name}</span>`).join('') : '<span style="color: #a0aec0;">无前置要求</span>'; const depContainer = document.getElementById('dependents-tags'); depContainer.innerHTML = dependents.length > 0 ? dependents.map(name => `<span class="concept-tag">${name}</span>`).join('') : '<span style="color: #a0aec0;">无后续概念</span>'; } function hideConceptDetails() { document.getElementById('no-selection').style.display = 'block'; document.getElementById('concept-details').style.display = 'none'; } function showError(message) { document.getElementById('loading').innerHTML = ` <div style="color: #e74c3c;"><span>❌ ${message}</span></div> `; } document.getElementById('category-select').addEventListener('change', function() { console.log('分类切换:', this.value); }); document.getElementById('layout-select').addEventListener('change', function() { if (!network) return; const layout = this.value; let options = {}; switch(layout) { case 'hierarchical': options = { layout: { hierarchical: { enabled: true, direction: 'UD', sortMethod: 'directed' } }, physics: { enabled: false } }; break; case 'force': options = { layout: { hierarchical: { enabled: false } }, physics: { enabled: true } }; break; case 'circular': options = { layout: { hierarchical: { enabled: false } }, physics: { enabled: false } }; break; } network.setOptions(options); }); document.getElementById('reset-view').addEventListener('click', function() { if (network) { network.fit(); } }); document.addEventListener('DOMContentLoaded', function() { initGraph(); });</script>
{% endblock %}
