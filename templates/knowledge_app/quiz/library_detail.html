{% extends 'knowledge_app/quiz/base_quiz.html' %}
{% load quiz_extras %}

{% block title %}{{ library.name }} - {{ block.super }}{% endblock %}

{% block quiz_breadcrumb %}
<div class="quiz-breadcrumb"><a href="{% url 'knowledge_app:quiz_dashboard' %}">ğŸ  ä¸ªäººé¢˜åº“</a><span class="quiz-breadcrumb-separator">></span><a href="{% url 'knowledge_app:quiz_library_list' %}">ğŸ“š é¢˜åº“åˆ—è¡¨</a><span class="quiz-breadcrumb-separator">></span><span>{{ library.name }}</span></div>
{% endblock %}

{% block quiz_content %}
<!-- é¢˜åº“ä¿¡æ¯ --><div class="quiz-card"><div class="quiz-card-header"><h1 class="quiz-card-title">ğŸ“š {{ library.name }}</h1><p class="quiz-card-subtitle">{{ library.description|default:"æš‚æ— æè¿°" }}</p></div><div class="quiz-card-body"><!-- ç»Ÿè®¡ä¿¡æ¯ --><div class="quiz-grid quiz-grid-4"><div class="quiz-stat-card"><span class="quiz-stat-icon">ğŸ“</span><div class="quiz-stat-value">{{ stats.total_questions }}</div><div class="quiz-stat-label">æ€»é¢˜ç›®æ•°</div></div><div class="quiz-stat-card"><span class="quiz-stat-icon">ğŸ“…</span><div class="quiz-stat-value">{{ library.created_at|date:"m-d" }}</div><div class="quiz-stat-label">åˆ›å»ºæ—¶é—´</div></div><div class="quiz-stat-card"><span class="quiz-stat-icon">ğŸ”„</span><div class="quiz-stat-value">{{ library.updated_at|date:"m-d" }}</div><div class="quiz-stat-label">æ›´æ–°æ—¶é—´</div></div><div class="quiz-stat-card"><span class="quiz-stat-icon">âœ…</span><div class="quiz-stat-value">{{ stats.avg_accuracy|floatformat:1 }}%</div><div class="quiz-stat-label">å¹³å‡æ­£ç¡®ç‡</div></div></div><!-- å¿«é€Ÿæ“ä½œ --><div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;"><a href="{% url 'knowledge_app:quiz_start' library.id %}" class="quiz-btn quiz-btn-success" style="color: white;"><span>ğŸ¯</span><span>å¼€å§‹ç»ƒä¹ </span></a><a href="{% url 'knowledge_app:quiz_create_question' library.id %}" class="quiz-btn quiz-btn-primary" style="color: white;"><span>â•</span><span>æ·»åŠ é¢˜ç›®</span></a><a href="{% url 'knowledge_app:quiz_export_library_pdf' library.id %}"
               class="quiz-btn quiz-btn-warning"
               style="color: white;"
               target="_blank"
               onclick="return handlePdfExport(this)"><span>ğŸ“„</span><span>å¯¼å‡ºPDF</span></a><a href="{% url 'knowledge_app:share_library' library.id %}" class="quiz-btn quiz-btn-success" style="color: white;"><span>ğŸ“¤</span><span>åˆ†äº«é¢˜åº“</span></a><button class="quiz-btn quiz-btn-outline" onclick="showEditModal()" style="color: var(--quiz-primary);"><span>âœï¸</span><span>ç¼–è¾‘é¢˜åº“</span></button></div></div></div><!-- é¢˜ç›®ç­›é€‰ --><div class="quiz-card"><div class="quiz-card-body"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;"><h2 style="margin: 0; color: var(--quiz-gray-800);">ğŸ“‹ é¢˜ç›®åˆ—è¡¨</h2><form method="get" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;"><select name="type" class="quiz-form-control" style="width: auto;"><option value="">æ‰€æœ‰ç±»å‹</option><option value="single_choice" {% if current_filters.type == 'single_choice' %}selected{% endif %}>å•é€‰é¢˜</option><option value="multiple_choice" {% if current_filters.type == 'multiple_choice' %}selected{% endif %}>å¤šé€‰é¢˜</option><option value="fill_blank" {% if current_filters.type == 'fill_blank' %}selected{% endif %}>å¡«ç©ºé¢˜</option><option value="short_answer" {% if current_filters.type == 'short_answer' %}selected{% endif %}>ç®€ç­”é¢˜</option></select><select name="difficulty" class="quiz-form-control" style="width: auto;"><option value="">æ‰€æœ‰éš¾åº¦</option><option value="1" {% if current_filters.difficulty == '1' %}selected{% endif %}>ç®€å•</option><option value="2" {% if current_filters.difficulty == '2' %}selected{% endif %}>ä¸­ç­‰</option><option value="3" {% if current_filters.difficulty == '3' %}selected{% endif %}>å›°éš¾</option></select><select name="tag" class="quiz-form-control" style="width: auto;"><option value="">æ‰€æœ‰æ ‡ç­¾</option>
                    {% for tag in tags %}
                    <option value="{{ tag.id }}" {% if current_filters.tag == tag.id|stringformat:"s" %}selected{% endif %}>{{ tag.name }}</option>
                    {% endfor %}
                </select><button type="submit" class="quiz-btn quiz-btn-primary">ç­›é€‰</button>
                {% if current_filters.type or current_filters.difficulty or current_filters.tag %}
                <a href="{% url 'knowledge_app:quiz_library_detail' library.id %}" class="quiz-btn quiz-btn-outline">æ¸…é™¤</a>
                {% endif %}
            </form></div><!-- é¢˜ç›®åˆ—è¡¨ -->
        {% if page_obj %}
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            {% for question in page_obj %}
            <div style="border: 1px solid var(--quiz-gray-200); border-radius: var(--quiz-radius-lg); padding: 1.5rem; background: var(--quiz-gray-50);"><div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;"><div style="flex: 1;"><h3 style="margin: 0 0 0.5rem 0; color: var(--quiz-gray-800);">{{ question.title }}</h3><p style="color: var(--quiz-gray-600); margin: 0 0 1rem 0; line-height: 1.5;">
                            {{ question.content|truncatechars:150 }}
                        </p><!-- é¢˜ç›®å›¾ç‰‡é¢„è§ˆ -->
                        {% if question.question_image %}
                        <div style="margin: 0.5rem 0;"><img src="{{ question.question_image.url }}"
                                 style="max-width: 150px; max-height: 100px; border-radius: var(--quiz-radius); box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                 alt="é¢˜ç›®å›¾ç‰‡"></div>
                        {% endif %}
                    </div><div style="display: flex; gap: 0.5rem; flex-wrap: wrap;"><span class="quiz-tag quiz-tag-primary">{{ question.get_question_type_display }}</span><span class="quiz-tag {% if question.difficulty == 1 %}quiz-tag-success{% elif question.difficulty == 2 %}quiz-tag-warning{% else %}quiz-tag-danger{% endif %}">
                            {{ question.get_difficulty_display }}
                        </span></div></div><div style="display: flex; justify-content: space-between; align-items: center;"><div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        {% for tag in question.tags.all %}
                        <span class="quiz-tag">{{ tag.name }}</span>
                        {% endfor %}
                        {% if not question.tags.all %}
                        <span style="color: var(--quiz-gray-400); font-size: 0.9rem;">æ— æ ‡ç­¾</span>
                        {% endif %}
                    </div><div style="display: flex; gap: 0.5rem; align-items: center;"><span style="color: var(--quiz-gray-500); font-size: 0.9rem;">
                            æ­£ç¡®ç‡: {{ question.accuracy_rate }}%
                        </span><button class="quiz-btn quiz-btn-outline" style="font-size: 0.8rem; padding: 0.4rem 0.8rem;" onclick="editQuestion({{ question.id }})">
                            ç¼–è¾‘
                        </button></div></div></div>
            {% endfor %}
        </div><!-- åˆ†é¡µ -->
        {% if page_obj.has_other_pages %}
        <div style="display: flex; justify-content: center; margin-top: 2rem;"><div style="display: flex; gap: 0.5rem; align-items: center;">
                {% if page_obj.has_previous %}
                <a href="?page=1{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="quiz-btn quiz-btn-outline">é¦–é¡µ</a><a href="?page={{ page_obj.previous_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="quiz-btn quiz-btn-outline">ä¸Šä¸€é¡µ</a>
                {% endif %}
                
                <span style="padding: 0.75rem 1rem; color: var(--quiz-gray-600);">
                    ç¬¬ {{ page_obj.number }} é¡µï¼Œå…± {{ page_obj.paginator.num_pages }} é¡µ
                </span>
                
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="quiz-btn quiz-btn-outline">ä¸‹ä¸€é¡µ</a><a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="quiz-btn quiz-btn-outline">æœ«é¡µ</a>
                {% endif %}
            </div></div>
        {% endif %}

        {% else %}
        <!-- ç©ºçŠ¶æ€ --><div style="text-align: center; padding: 4rem 2rem;"><div style="font-size: 4rem; margin-bottom: 2rem; opacity: 0.5;">ğŸ“</div><h2 style="color: var(--quiz-gray-600); margin-bottom: 1rem;">è¿˜æ²¡æœ‰é¢˜ç›®</h2><p style="color: var(--quiz-gray-500); margin-bottom: 2rem;">æ·»åŠ ç¬¬ä¸€é“é¢˜ç›®ï¼Œå¼€å§‹æ„å»ºä½ çš„é¢˜åº“å§ï¼</p><a href="{% url 'knowledge_app:quiz_create_question' library.id %}" class="quiz-btn quiz-btn-primary"><span>â•</span><span>æ·»åŠ ç¬¬ä¸€é“é¢˜ç›®</span></a></div>
        {% endif %}
    </div></div><!-- é¢˜å‹ç»Ÿè®¡ -->
{% if stats.by_type %}
<div class="quiz-card"><div class="quiz-card-body"><h2 style="margin-bottom: 1.5rem; color: var(--quiz-gray-800);">ğŸ“Š é¢˜å‹åˆ†å¸ƒ</h2><div class="quiz-grid quiz-grid-4">
            {% for type_stat in stats.by_type %}
            <div class="quiz-stat-card"><span class="quiz-stat-icon">
                    {% if type_stat.question_type == 'single_choice' %}ğŸ”˜
                    {% elif type_stat.question_type == 'multiple_choice' %}â˜‘ï¸
                    {% elif type_stat.question_type == 'fill_blank' %}ğŸ“
                    {% elif type_stat.question_type == 'short_answer' %}ğŸ’¬
                    {% else %}â“{% endif %}
                </span><div class="quiz-stat-value">{{ type_stat.count }}</div><div class="quiz-stat-label">
                    {% if type_stat.question_type == 'single_choice' %}å•é€‰é¢˜
                    {% elif type_stat.question_type == 'multiple_choice' %}å¤šé€‰é¢˜
                    {% elif type_stat.question_type == 'fill_blank' %}å¡«ç©ºé¢˜
                    {% elif type_stat.question_type == 'short_answer' %}ç®€ç­”é¢˜
                    {% else %}å…¶ä»–{% endif %}
                </div></div>
            {% endfor %}
        </div></div></div>
{% endif %}

<!-- ç¼–è¾‘é¢˜åº“æ¨¡æ€æ¡† --><div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;"><div style="background: white; border-radius: var(--quiz-radius-xl); max-width: 500px; width: 90%; padding: 2rem;"><h3 style="margin-bottom: 1.5rem; color: var(--quiz-gray-800);">âœï¸ ç¼–è¾‘é¢˜åº“</h3><form id="editForm" method="post">
            {% csrf_token %}
            <div class="quiz-form-group"><label class="quiz-form-label">é¢˜åº“åç§°</label><input type="text" name="name" value="{{ library.name }}" class="quiz-form-control" required></div><div class="quiz-form-group"><label class="quiz-form-label">é¢˜åº“æè¿°</label><textarea name="description" class="quiz-form-control" rows="3">{{ library.description }}</textarea></div><div style="display: flex; gap: 1rem; justify-content: end;"><button type="button" class="quiz-btn quiz-btn-outline" onclick="hideEditModal()">å–æ¶ˆ</button><button type="submit" class="quiz-btn quiz-btn-primary">ä¿å­˜</button></div></form></div></div><script>function showEditModal() { document.getElementById('editModal').style.display = 'flex'; } function hideEditModal() { document.getElementById('editModal').style.display = 'none'; } function editQuestion(questionId) { alert('ç¼–è¾‘é¢˜ç›®åŠŸèƒ½å¼€å‘ä¸­...'); } document.getElementById('editModal').addEventListener('click', function(e) { if (e.target === this) { hideEditModal(); } }); function handlePdfExport(element) { console.log('PDFå¯¼å‡ºæŒ‰é’®è¢«ç‚¹å‡»'); console.log('å¯¼å‡ºURL:', element.href); const originalText = element.innerHTML; element.innerHTML = '<span>â³</span><span>å¯¼å‡ºä¸­...</span>'; element.style.pointerEvents = 'none'; setTimeout(() => { element.innerHTML = originalText; element.style.pointerEvents = 'auto'; }, 2000); return true; }</script>
{% endblock %}
