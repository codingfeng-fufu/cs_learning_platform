{% extends 'knowledge_app/quiz/base_quiz.html' %}

{% block title %}分享管理 - {{ library.name }}{% endblock %}

{% block content %}
<div class="quiz-container"><!-- 面包屑导航 --><div class="quiz-breadcrumb"><a href="{% url 'knowledge_app:quiz_dashboard' %}">个人题库</a><span class="quiz-breadcrumb-separator">></span><a href="{% url 'knowledge_app:quiz_library_detail' library.id %}">{{ library.name }}</a><span class="quiz-breadcrumb-separator">></span><span>分享管理</span></div><div class="quiz-card"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;"><div><h1 style="color: black !important; margin: 0;">📤 分享管理</h1><p style="color: black !important; margin: 0.5rem 0 0 0;">管理 "{{ library.name }}" 的分享记录</p></div><a href="{% url 'knowledge_app:share_library' library.id %}" class="quiz-btn quiz-btn-primary"><span>➕</span><span>新建分享</span></a></div>

        {% if shares %}
        <div style="display: grid; gap: 1rem;">
            {% for share in shares %}
            <div class="quiz-card" style="border: 1px solid var(--quiz-gray-200); padding: 1.5rem;"><div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;"><div style="flex: 1;"><div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            {% if share.share_type == 'private' %}
                            <span class="quiz-tag quiz-tag-primary">👤 私密分享</span>
                            {% elif share.share_type == 'link' %}
                            <span class="quiz-tag quiz-tag-warning">🔗 链接分享</span>
                            {% elif share.share_type == 'public' %}
                            <span class="quiz-tag quiz-tag-success">🌍 公开分享</span>
                            {% endif %}
                            
                            {% if share.permission == 'view' %}
                            <span class="quiz-tag">👀 仅查看</span>
                            {% elif share.permission == 'copy' %}
                            <span class="quiz-tag">📋 可复制</span>
                            {% elif share.permission == 'edit' %}
                            <span class="quiz-tag">✏️ 可编辑</span>
                            {% endif %}
                            
                            {% if not share.is_active %}
                            <span class="quiz-tag quiz-tag-danger">❌ 已禁用</span>
                            {% elif share.is_expired %}
                            <span class="quiz-tag quiz-tag-danger">⏰ 已过期</span>
                            {% endif %}
                        </div>
                        
                        {% if share.shared_to %}
                        <p style="color: black !important; margin: 0 0 0.5rem 0;"><strong>分享给：</strong>{{ share.shared_to.username }}
                        </p>
                        {% endif %}
                        
                        {% if share.share_code %}
                        <p style="color: black !important; margin: 0 0 0.5rem 0;"><strong>分享链接：</strong><a href="{% url 'knowledge_app:shared_library_detail' share.share_code %}" target="_blank" style="color: var(--quiz-primary) !important;">
                                {{ request.build_absolute_uri }}{% url 'knowledge_app:shared_library_detail' share.share_code %}
                            </a><button onclick="copyToClipboard('{{ request.build_absolute_uri }}{% url 'knowledge_app:shared_library_detail' share.share_code %}')" class="quiz-btn" style="padding: 0.25rem 0.5rem; font-size: 0.8rem; margin-left: 0.5rem;">
                                📋 复制
                            </button></p>
                        {% endif %}
                        
                        {% if share.message %}
                        <p style="color: black !important; margin: 0 0 0.5rem 0;"><strong>留言：</strong>{{ share.message }}
                        </p>
                        {% endif %}
                        
                        <div style="display: flex; gap: 1rem; font-size: 0.9rem; color: black !important;"><span>📅 {{ share.created_at|date:"Y-m-d H:i" }}</span><span>👁️ {{ share.access_count }} 次访问</span>
                            {% if share.accessed_at %}
                            <span>🕒 最后访问：{{ share.accessed_at|date:"Y-m-d H:i" }}</span>
                            {% endif %}
                            {% if share.expires_at %}
                            <span>⏰ 过期时间：{{ share.expires_at|date:"Y-m-d H:i" }}</span>
                            {% endif %}
                        </div></div><div style="display: flex; gap: 0.5rem;"><button onclick="toggleShareStatus({{ share.id }})" class="quiz-btn {% if share.is_active %}quiz-btn-warning{% else %}quiz-btn-success{% endif %}" style="font-size: 0.8rem; padding: 0.5rem 1rem;">
                            {% if share.is_active %}
                            <span>⏸️ 禁用</span>
                            {% else %}
                            <span>▶️ 启用</span>
                            {% endif %}
                        </button><button onclick="deleteShare({{ share.id }})" class="quiz-btn quiz-btn-danger" style="font-size: 0.8rem; padding: 0.5rem 1rem;"><span>🗑️ 删除</span></button></div></div></div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 3rem; color: black !important;"><div style="font-size: 4rem; margin-bottom: 1rem;">📤</div><h3 style="color: black !important;">还没有分享记录</h3><p style="color: black !important; margin-bottom: 2rem;">开始分享你的题库给其他用户吧！</p><a href="{% url 'knowledge_app:share_library' library.id %}" class="quiz-btn quiz-btn-primary"><span>➕</span><span>创建分享</span></a></div>
        {% endif %}
    </div></div><script>function copyToClipboard(text) { navigator.clipboard.writeText(text).then(function() { alert('链接已复制到剪贴板！'); }, function(err) { console.error('复制失败: ', err); const textArea = document.createElement('textarea'); textArea.value = text; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); alert('链接已复制到剪贴板！'); }); } function toggleShareStatus(shareId) { if (!confirm('确定要切换分享状态吗？')) { return; } fetch(`/quiz/shares/${shareId}/toggle/`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken') } }) .then(response => response.json()) .then(data => { if (data.success) { alert(data.message); location.reload(); } else { alert('操作失败：' + data.error); } }) .catch(error => { console.error('Error:', error); alert('操作失败，请重试'); }); } function deleteShare(shareId) { if (!confirm('确定要删除这个分享吗？此操作不可恢复！')) { return; } fetch(`/quiz/shares/${shareId}/delete/`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken') } }) .then(response => response.json()) .then(data => { if (data.success) { alert(data.message); location.reload(); } else { alert('删除失败：' + data.error); } }) .catch(error => { console.error('Error:', error); alert('删除失败，请重试'); }); } function getCookie(name) { let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue; }</script>
{% endblock %}
