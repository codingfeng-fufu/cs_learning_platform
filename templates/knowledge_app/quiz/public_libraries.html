{% extends 'knowledge_app/quiz/base_quiz.html' %}

{% block title %}å…¬å¼€é¢˜åº“{% endblock %}

{% block content %}
<div class="quiz-container"><!-- é¢åŒ…å±‘å¯¼èˆª --><div class="quiz-breadcrumb"><a href="{% url 'knowledge_app:quiz_dashboard' %}">ä¸ªäººé¢˜åº“</a><span class="quiz-breadcrumb-separator">></span><span>å…¬å¼€é¢˜åº“</span></div><div class="quiz-card"><div style="text-align: center; margin-bottom: 2rem;"><h1 style="color: black !important; margin-bottom: 0.5rem;">ğŸŒ å…¬å¼€é¢˜åº“</h1><p style="color: black !important;">å‘ç°å’Œå­¦ä¹ å…¶ä»–ç”¨æˆ·åˆ†äº«çš„ä¼˜è´¨é¢˜åº“</p></div><!-- æœç´¢æ¡† --><div style="margin-bottom: 2rem;"><form method="get" style="display: flex; gap: 1rem; max-width: 600px; margin: 0 auto;"><input type="text" name="search" value="{{ search|default:'' }}" placeholder="æœç´¢é¢˜åº“åç§°..." class="quiz-form-control" style="flex: 1;"><button type="submit" class="quiz-btn quiz-btn-primary"><span>ğŸ”</span><span>æœç´¢</span></button>
                {% if search %}
                <a href="{% url 'knowledge_app:public_libraries' %}" class="quiz-btn quiz-btn-outline"><span>ğŸ”„</span><span>é‡ç½®</span></a>
                {% endif %}
            </form></div>

        {% if search %}
        <div style="text-align: center; margin-bottom: 1.5rem; color: black !important;">
            æœç´¢ "{{ search }}" çš„ç»“æœ
        </div>
        {% endif %}

        {% if page_obj %}
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem;">
            {% for share in page_obj %}
            <div class="quiz-card" style="border: 1px solid var(--quiz-gray-200); padding: 1.5rem; transition: var(--quiz-transition); height: fit-content;" onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='var(--quiz-shadow-lg)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='var(--quiz-shadow)'"><div style="margin-bottom: 1rem;"><div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;"><h3 style="color: black !important; margin: 0; flex: 1;">{{ share.library.name }}</h3><div style="display: flex; gap: 0.25rem; flex-wrap: wrap;"><span class="quiz-tag quiz-tag-success">ğŸŒ å…¬å¼€</span>
                            {% if share.permission == 'view' %}
                            <span class="quiz-tag">ğŸ‘€ æŸ¥çœ‹</span>
                            {% elif share.permission == 'copy' %}
                            <span class="quiz-tag quiz-tag-primary">ğŸ“‹ å¯å¤åˆ¶</span>
                            {% elif share.permission == 'edit' %}
                            <span class="quiz-tag quiz-tag-warning">âœï¸ å¯ç¼–è¾‘</span>
                            {% endif %}
                        </div></div>
                    
                    {% if share.library.description %}
                    <p style="color: black !important; margin: 0 0 1rem 0; line-height: 1.5;">{{ share.library.description|truncatechars:100 }}</p>
                    {% else %}
                    <p style="color: #666 !important; margin: 0 0 1rem 0; font-style: italic;">æš‚æ— æè¿°</p>
                    {% endif %}
                    
                    {% if share.message %}
                    <div style="background: rgba(34, 197, 94, 0.1); padding: 0.75rem; border-radius: var(--quiz-radius); margin-bottom: 1rem; border-left: 3px solid var(--quiz-success);"><p style="color: black !important; margin: 0; font-size: 0.9rem; font-style: italic;">"{{ share.message|truncatechars:80 }}"</p></div>
                    {% endif %}
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; font-size: 0.9rem;"><div style="text-align: center; padding: 0.5rem; background: var(--quiz-gray-50); border-radius: var(--quiz-radius);"><div style="font-weight: 600; color: var(--quiz-primary);">{{ share.library.total_questions }}</div><div style="color: black !important;">é“é¢˜ç›®</div></div><div style="text-align: center; padding: 0.5rem; background: var(--quiz-gray-50); border-radius: var(--quiz-radius);"><div style="font-weight: 600; color: var(--quiz-success);">{{ share.access_count }}</div><div style="color: black !important;">æ¬¡è®¿é—®</div></div></div><div style="display: flex; gap: 1rem; font-size: 0.85rem; color: black !important; margin-bottom: 1rem; justify-content: space-between;"><span>ğŸ‘¤ {{ share.shared_by.username }}</span><span>ğŸ“… {{ share.created_at|date:"m-d" }}</span></div></div><div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                    {% if user.is_authenticated %}
                    <a href="{% url 'knowledge_app:quiz_library_detail' share.library.id %}" class="quiz-btn quiz-btn-primary" style="flex: 1; text-align: center;"><span>ğŸ‘€</span><span>æŸ¥çœ‹é¢˜åº“</span></a>
                    
                    {% if share.permission in 'copy,edit' %}
                    <button onclick="copyLibrary({{ share.id }})" class="quiz-btn quiz-btn-success" style="flex: 1; text-align: center;"><span>ğŸ“‹</span><span>å¤åˆ¶é¢˜åº“</span></button>
                    {% endif %}
                    
                    <a href="{% url 'knowledge_app:quiz_start' share.library.id %}" class="quiz-btn quiz-btn-warning" style="flex: 1; text-align: center;"><span>ğŸ¯</span><span>å¼€å§‹ç»ƒä¹ </span></a>
                    {% else %}
                    <div style="text-align: center; padding: 0.75rem; background: var(--quiz-gray-50); border-radius: var(--quiz-radius); color: black !important; width: 100%;"><p style="margin: 0 0 0.5rem 0; color: black !important;">ç™»å½•åå¯ä»¥æŸ¥çœ‹å’Œå¤åˆ¶é¢˜åº“</p><a href="{% url 'users:login' %}" class="quiz-btn quiz-btn-primary"><span>ğŸ”‘</span><span>ç™»å½•</span></a></div>
                    {% endif %}
                </div></div>
            {% endfor %}
        </div><!-- åˆ†é¡µ -->
        {% if page_obj.has_other_pages %}
        <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 2rem;">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}" class="quiz-btn quiz-btn-outline"><span>â†</span><span>ä¸Šä¸€é¡µ</span></a>
            {% endif %}
            
            <span style="color: black !important;">
                ç¬¬ {{ page_obj.number }} é¡µï¼Œå…± {{ page_obj.paginator.num_pages }} é¡µ
            </span>
            
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}" class="quiz-btn quiz-btn-outline"><span>ä¸‹ä¸€é¡µ</span><span>â†’</span></a>
            {% endif %}
        </div>
        {% endif %}
        
        {% else %}
        <div style="text-align: center; padding: 3rem; color: black !important;"><div style="font-size: 4rem; margin-bottom: 1rem;">ğŸŒ</div>
            {% if search %}
            <h3 style="color: black !important;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³é¢˜åº“</h3><p style="color: black !important; margin-bottom: 2rem;">å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æœç´¢</p><a href="{% url 'knowledge_app:public_libraries' %}" class="quiz-btn quiz-btn-primary"><span>ğŸ”„</span><span>æŸ¥çœ‹æ‰€æœ‰å…¬å¼€é¢˜åº“</span></a>
            {% else %}
            <h3 style="color: black !important;">è¿˜æ²¡æœ‰å…¬å¼€é¢˜åº“</h3><p style="color: black !important; margin-bottom: 2rem;">æˆä¸ºç¬¬ä¸€ä¸ªåˆ†äº«é¢˜åº“çš„ç”¨æˆ·å§ï¼</p><a href="{% url 'knowledge_app:quiz_dashboard' %}" class="quiz-btn quiz-btn-primary"><span>ğŸ“š</span><span>åˆ›å»ºé¢˜åº“</span></a>
            {% endif %}
        </div>
        {% endif %}
    </div></div><script>function copyLibrary(shareId) { if (!confirm('ç¡®å®šè¦å¤åˆ¶è¿™ä¸ªé¢˜åº“åˆ°ä½ çš„ä¸ªäººé¢˜åº“å—ï¼Ÿ')) { return; } const button = event.target.closest('button'); const originalText = button.innerHTML; button.innerHTML = '<span>â³</span><span>å¤åˆ¶ä¸­...</span>'; button.disabled = true; const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken'); console.log('CSRF Token:', csrfToken ? 'Found' : 'Not found'); fetch(`/quiz/shares/${shareId}/copy/`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken } }) .then(response => { console.log('Response status:', response.status); if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); } return response.json(); }) .then(data => { console.log('Response data:', data); if (data.success) { alert(data.message); if (data.redirect_url) { window.location.href = data.redirect_url; } } else { alert('å¤åˆ¶å¤±è´¥ï¼š' + data.error); button.innerHTML = originalText; button.disabled = false; } }) .catch(error => { console.error('Fetch error:', error); alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•: ' + error.message); button.innerHTML = originalText; button.disabled = false; }); } function getCookie(name) { let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue; }</script>
{% endblock %}
