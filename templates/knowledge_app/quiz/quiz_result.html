{% extends 'knowledge_app/quiz/base_quiz.html' %}

{% block title %}ç»ƒä¹ ç»“æœ - {{ session.session_name }} - {{ block.super }}{% endblock %}

{% block quiz_breadcrumb %}
<div class="quiz-breadcrumb"><a href="{% url 'knowledge_app:quiz_dashboard' %}">ğŸ  ä¸ªäººé¢˜åº“</a><span class="quiz-breadcrumb-separator">></span><span>ğŸ“Š ç»ƒä¹ ç»“æœ</span></div>
{% endblock %}

{% block quiz_content %}
<!-- ç»“æœæ€»è§ˆ --><div class="quiz-card"><div class="quiz-card-header"><h1 class="quiz-card-title">ğŸ‰ ç»ƒä¹ å®Œæˆï¼</h1><p class="quiz-card-subtitle">{{ session.session_name }}</p></div><div class="quiz-card-body"><!-- æˆç»©ç»Ÿè®¡ --><div class="quiz-grid quiz-grid-4"><div class="quiz-stat-card"><span class="quiz-stat-icon">ğŸ“</span><div class="quiz-stat-value">{{ total_questions }}</div><div class="quiz-stat-label">æ€»é¢˜æ•°</div></div><div class="quiz-stat-card"><span class="quiz-stat-icon">âœ…</span><div class="quiz-stat-value">{{ correct_answers }}</div><div class="quiz-stat-label">æ­£ç¡®æ•°</div></div><div class="quiz-stat-card"><span class="quiz-stat-icon">âŒ</span><div class="quiz-stat-value">{{ wrong_answers }}</div><div class="quiz-stat-label">é”™è¯¯æ•°</div></div><div class="quiz-stat-card"><span class="quiz-stat-icon">ğŸ“Š</span><div class="quiz-stat-value">{{ accuracy }}%</div><div class="quiz-stat-label">æ­£ç¡®ç‡</div></div></div><!-- æˆç»©è¯„ä»· --><div style="text-align: center; margin: 2rem 0;">
            {% if accuracy >= 90 %}
            <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ†</div><h2 style="color: var(--quiz-success) !important; margin-bottom: 0.5rem;">ä¼˜ç§€ï¼</h2><p style="color: black !important;">ä½ çš„è¡¨ç°éå¸¸å‡ºè‰²ï¼Œç»§ç»­ä¿æŒï¼</p>
            {% elif accuracy >= 80 %}
            <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ¯</div><h2 style="color: var(--quiz-primary) !important; margin-bottom: 0.5rem;">è‰¯å¥½ï¼</h2><p style="color: black !important;">ä½ çš„åŸºç¡€å¾ˆæ‰å®ï¼Œå†æ¥å†å‰ï¼</p>
            {% elif accuracy >= 60 %}
            <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“š</div><h2 style="color: var(--quiz-warning) !important; margin-bottom: 0.5rem;">åŠæ ¼ï¼</h2><p style="color: black !important;">è¿˜æœ‰æå‡ç©ºé—´ï¼Œå»ºè®®å¤šåŠ ç»ƒä¹ ã€‚</p>
            {% else %}
            <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ’ª</div><h2 style="color: var(--quiz-danger) !important; margin-bottom: 0.5rem;">éœ€è¦åŠªåŠ›ï¼</h2><p style="color: black !important;">ä¸è¦æ°”é¦ï¼Œå¤šç»ƒä¹ ä¸€å®šä¼šè¿›æ­¥çš„ï¼</p>
            {% endif %}
        </div><!-- å¿«é€Ÿæ“ä½œ --><div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
            {% if session.library %}
            <a href="{% url 'knowledge_app:quiz_start' session.library.id %}" class="quiz-btn quiz-btn-primary" style="color: white;"><span>ğŸ”„</span><span>å†æ¬¡ç»ƒä¹ </span></a>
            {% endif %}
            {% if wrong_answers > 0 %}
            <a href="{% url 'knowledge_app:quiz_wrong_answers' %}" class="quiz-btn quiz-btn-warning" style="color: white;"><span>âŒ</span><span>æŸ¥çœ‹é”™é¢˜</span></a>
            {% endif %}
            <a href="{% url 'knowledge_app:quiz_dashboard' %}" class="quiz-btn quiz-btn-outline" style="color: var(--quiz-primary);"><span>ğŸ </span><span>è¿”å›é¦–é¡µ</span></a></div></div></div><!-- é¢˜å‹ç»Ÿè®¡ -->
{% if type_stats %}
<div class="quiz-card"><div class="quiz-card-body"><h2 style="margin-bottom: 1.5rem; color: var(--quiz-gray-800);">ğŸ“Š é¢˜å‹è¡¨ç°</h2><div class="quiz-grid quiz-grid-2">
            {% for type_name, stats in type_stats.items %}
            <div style="padding: 1.5rem; border: 1px solid var(--quiz-gray-200); border-radius: var(--quiz-radius-lg); background: var(--quiz-gray-50);"><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"><h3 style="color: var(--quiz-gray-800); margin: 0;">{{ type_name }}</h3><span class="quiz-tag {% if stats.accuracy >= 80 %}quiz-tag-success{% elif stats.accuracy >= 60 %}quiz-tag-warning{% else %}quiz-tag-danger{% endif %}">
                        {{ stats.accuracy }}%
                    </span></div><div style="display: flex; justify-content: space-between; color: var(--quiz-gray-600); font-size: 0.9rem;"><span>æ­£ç¡®: {{ stats.correct }}</span><span>æ€»æ•°: {{ stats.total }}</span></div><div class="quiz-progress" style="margin-top: 1rem;"><div class="quiz-progress-bar" style="width: {{ stats.accuracy }}%;"></div></div></div>
            {% endfor %}
        </div></div></div>
{% endif %}

<!-- è¯¦ç»†ç­”é¢˜è®°å½• --><div class="quiz-card"><div class="quiz-card-body"><h2 style="margin-bottom: 1.5rem; color: var(--quiz-gray-800);">ğŸ“‹ ç­”é¢˜è¯¦æƒ…</h2><div style="display: flex; flex-direction: column; gap: 1rem;">
            {% for answer in answers %}
            <div style="border: 1px solid {% if answer.is_correct %}var(--quiz-success){% else %}var(--quiz-danger){% endif %}; border-radius: var(--quiz-radius-lg); padding: 1.5rem; background: {% if answer.is_correct %}rgba(16, 185, 129, 0.05){% else %}rgba(239, 68, 68, 0.05){% endif %};"><div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;"><div style="flex: 1;"><h4 style="color: var(--quiz-gray-800); margin: 0 0 0.5rem 0;">
                            {% if answer.is_correct %}âœ…{% else %}âŒ{% endif %}
                            {{ answer.question.title }}
                        </h4><p style="color: var(--quiz-gray-600); margin: 0; font-size: 0.9rem;">
                            {{ answer.question.content|truncatechars:100 }}
                        </p></div><div style="display: flex; gap: 0.5rem;"><span class="quiz-tag quiz-tag-primary">{{ answer.question.get_question_type_display }}</span><span class="quiz-tag {% if answer.question.difficulty == 1 %}quiz-tag-success{% elif answer.question.difficulty == 2 %}quiz-tag-warning{% else %}quiz-tag-danger{% endif %}">
                            {{ answer.question.get_difficulty_display }}
                        </span></div></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;"><div><div style="color: var(--quiz-gray-700); font-weight: 600; margin-bottom: 0.5rem;">ä½ çš„ç­”æ¡ˆï¼š</div><div style="color: {% if answer.is_correct %}var(--quiz-success){% else %}var(--quiz-danger){% endif %}; font-weight: 500;">
                            {{ answer.user_answer }}
                        </div></div><div><div style="color: var(--quiz-gray-700); font-weight: 600; margin-bottom: 0.5rem;">æ­£ç¡®ç­”æ¡ˆï¼š</div><div style="color: var(--quiz-success); font-weight: 500;">
                            {{ answer.question.correct_answer }}
                        </div></div></div>
                
                {% if answer.question.explanation %}
                <div style="margin-top: 1rem; padding: 1rem; background: rgba(99, 102, 241, 0.1); border-radius: var(--quiz-radius);"><div style="color: var(--quiz-primary); font-weight: 600; margin-bottom: 0.5rem;">è§£æï¼š</div><div style="color: var(--quiz-gray-700); line-height: 1.5;">{{ answer.question.explanation }}</div></div>
                {% endif %}
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--quiz-gray-200);"><div style="display: flex; gap: 0.5rem;">
                        {% for tag in answer.question.tags.all %}
                        <span class="quiz-tag">{{ tag.name }}</span>
                        {% endfor %}
                    </div><div style="color: var(--quiz-gray-500); font-size: 0.9rem;">
                        ç”¨æ—¶: {{ answer.time_spent }}ç§’
                    </div></div></div>
            {% endfor %}
        </div></div></div><!-- å­¦ä¹ å»ºè®® --><div class="quiz-card"><div class="quiz-card-body"><h2 style="margin-bottom: 1.5rem; color: var(--quiz-gray-800); text-align: center;">ğŸ’¡ å­¦ä¹ å»ºè®®</h2><div class="quiz-grid quiz-grid-2">
            {% if wrong_answers > 0 %}
            <div style="text-align: center; padding: 2rem;"><div style="font-size: 3rem; margin-bottom: 1rem;">âŒ</div><h3 style="color: var(--quiz-gray-800); margin-bottom: 1rem;">å¤ä¹ é”™é¢˜</h3><p style="color: var(--quiz-gray-600); margin-bottom: 1.5rem;">
                    ä½ æœ‰ {{ wrong_answers }} é“é¢˜ç­”é”™äº†ï¼Œå»ºè®®é‡ç‚¹å¤ä¹ è¿™äº›çŸ¥è¯†ç‚¹
                </p><a href="{% url 'knowledge_app:quiz_wrong_answers' %}" class="quiz-btn quiz-btn-warning" style="color: white;"><span>ğŸ“–</span><span>æŸ¥çœ‹é”™é¢˜æœ¬</span></a></div>
            {% endif %}
            
            <div style="text-align: center; padding: 2rem;"><div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ¤–</div><h3 style="color: var(--quiz-gray-800); margin-bottom: 1rem;">AIåˆ†æ</h3><p style="color: var(--quiz-gray-600); margin-bottom: 1.5rem;">
                    ä½¿ç”¨AIåˆ†æåŠŸèƒ½ï¼Œè·å¾—ä¸ªæ€§åŒ–çš„å­¦ä¹ å»ºè®®å’Œæ”¹è¿›æ–¹æ¡ˆ
                </p><button class="quiz-btn quiz-btn-primary" onclick="getAIAnalysis()" style="color: white;"><span>ğŸ§ </span><span>è·å–AIå»ºè®®</span></button></div></div></div></div><!-- AIåˆ†æç»“æœæ¨¡æ€æ¡† --><div id="aiModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;"><div style="background: white; border-radius: var(--quiz-radius-xl); max-width: 600px; width: 90%; padding: 2rem;"><h3 style="color: var(--quiz-gray-800); margin-bottom: 1.5rem; text-align: center;">ğŸ¤– AIå­¦ä¹ åˆ†æ</h3><div id="aiContent"><div style="text-align: center; padding: 2rem;"><div style="font-size: 2rem; margin-bottom: 1rem;">â³</div><p style="color: var(--quiz-gray-600);">AIæ­£åœ¨åˆ†æä½ çš„å­¦ä¹ æƒ…å†µ...</p></div></div><div style="text-align: center; margin-top: 2rem;"><button class="quiz-btn quiz-btn-outline" onclick="closeAIModal()" style="color: var(--quiz-primary);">å…³é—­</button></div></div></div><script>function getAIAnalysis() { const modal = document.getElementById('aiModal'); modal.style.display = 'flex'; const analysisData = { total_questions: {{ total_questions }}, correct_answers: {{ correct_answers }}, accuracy: {{ accuracy }}, session_id: {{ session.id }} }; fetch('{% url "knowledge_app:quiz_analyze_session" session.id %}', { method: 'POST', headers: { 'Content-Type': 'application/json', 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken') }, body: JSON.stringify(analysisData) }) .then(response => response.json()) .then(data => { const content = document.getElementById('aiContent'); if (data.success) { const strengthsList = data.strengths.map(s => `<li style="color: var(--quiz-gray-700);">${s}</li>`).join(''); const weaknessesList = data.weaknesses.map(w => `<li style="color: var(--quiz-gray-700);">${w}</li>`).join(''); const suggestionsList = data.suggestions.map(s => `<li style="color: var(--quiz-gray-700);">${s}</li>`).join(''); const nextStepsList = data.next_steps.map(n => `<li style="color: var(--quiz-gray-700);">${n}</li>`).join(''); content.innerHTML = ` <div style="text-align: left;"><div style="background: rgba(99, 102, 241, 0.1); padding: 1.5rem; border-radius: var(--quiz-radius-lg); margin-bottom: 1rem;"><h4 style="color: var(--quiz-primary); margin-bottom: 1rem;">ğŸ“Š æ•´ä½“è¯„ä»·</h4><p style="color: var(--quiz-gray-700); line-height: 1.6; margin: 0;">${data.overall_analysis}</p></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;"><div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: var(--quiz-radius-lg);"><h4 style="color: var(--quiz-success); margin-bottom: 1rem;">âœ… ä¼˜åŠ¿é¢†åŸŸ</h4><ul style="margin: 0; padding-left: 1.5rem;">${strengthsList || '<li style="color: var(--quiz-gray-500);">æš‚æ— æ˜æ˜¾ä¼˜åŠ¿</li>'}</ul></div><div style="background: rgba(245, 158, 11, 0.1); padding: 1.5rem; border-radius: var(--quiz-radius-lg);"><h4 style="color: var(--quiz-warning); margin-bottom: 1rem;">âš ï¸ è–„å¼±ç¯èŠ‚</h4><ul style="margin: 0; padding-left: 1.5rem;">${weaknessesList || '<li style="color: var(--quiz-gray-500);">æš‚æ— æ˜æ˜¾è–„å¼±ç‚¹</li>'}</ul></div></div><div style="background: rgba(139, 92, 246, 0.1); padding: 1.5rem; border-radius: var(--quiz-radius-lg); margin-bottom: 1rem;"><h4 style="color: #8b5cf6; margin-bottom: 1rem;">ğŸ’¡ å­¦ä¹ å»ºè®®</h4><ul style="margin: 0; padding-left: 1.5rem;">${suggestionsList}</ul></div><div style="background: rgba(6, 182, 212, 0.1); padding: 1.5rem; border-radius: var(--quiz-radius-lg);"><h4 style="color: #06b6d4; margin-bottom: 1rem;">ğŸ¯ ä¸‹ä¸€æ­¥è®¡åˆ’</h4><ul style="margin: 0; padding-left: 1.5rem;">${nextStepsList}</ul></div></div> `; } else { content.innerHTML = ` <div style="text-align: center; padding: 2rem;"><div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ˜…</div><p style="color: var(--quiz-gray-600);">AIåˆ†ææš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚</p></div> `; } }) .catch(error => { console.error('AIåˆ†æå¤±è´¥:', error); const content = document.getElementById('aiContent'); content.innerHTML = ` <div style="text-align: center; padding: 2rem;"><div style="font-size: 2rem; margin-bottom: 1rem;">âŒ</div><p style="color: var(--quiz-gray-600);">åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚</p></div> `; }); } function closeAIModal() { document.getElementById('aiModal').style.display = 'none'; } function getCookie(name) { let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue; } document.getElementById('aiModal').addEventListener('click', function(e) { if (e.target === this) { closeAIModal(); } });</script>
{% endblock %}
