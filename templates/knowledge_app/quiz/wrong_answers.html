{% extends 'knowledge_app/quiz/base_quiz.html' %}
{% load quiz_extras %}

{% block title %}é”™é¢˜æœ¬ - {{ block.super }}{% endblock %}

{% block quiz_breadcrumb %}
<div class="quiz-breadcrumb"><a href="{% url 'knowledge_app:quiz_dashboard' %}">ğŸ  ä¸ªäººé¢˜åº“</a><span class="quiz-breadcrumb-separator">></span><span>âŒ é”™é¢˜æœ¬</span></div>
{% endblock %}

{% block quiz_content %}
<!-- é¡µé¢å¤´éƒ¨ --><div class="quiz-card"><div class="quiz-card-header"><h1 class="quiz-card-title">âŒ é”™é¢˜æœ¬</h1><p class="quiz-card-subtitle">å¤ä¹ é”™é¢˜ï¼Œå·©å›ºçŸ¥è¯†ç‚¹</p></div><div class="quiz-card-body"><!-- ç­›é€‰å’Œæ“ä½œæ  --><div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;"><form method="get" style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;"><select name="type" class="quiz-form-control" style="width: auto;"><option value="">æ‰€æœ‰ç±»å‹</option><option value="single_choice" {% if current_filters.type == 'single_choice' %}selected{% endif %}>å•é€‰é¢˜</option><option value="multiple_choice" {% if current_filters.type == 'multiple_choice' %}selected{% endif %}>å¤šé€‰é¢˜</option><option value="fill_blank" {% if current_filters.type == 'fill_blank' %}selected{% endif %}>å¡«ç©ºé¢˜</option><option value="short_answer" {% if current_filters.type == 'short_answer' %}selected{% endif %}>ç®€ç­”é¢˜</option></select><select name="difficulty" class="quiz-form-control" style="width: auto;"><option value="">æ‰€æœ‰éš¾åº¦</option><option value="1" {% if current_filters.difficulty == '1' %}selected{% endif %}>ç®€å•</option><option value="2" {% if current_filters.difficulty == '2' %}selected{% endif %}>ä¸­ç­‰</option><option value="3" {% if current_filters.difficulty == '3' %}selected{% endif %}>å›°éš¾</option></select><button type="submit" class="quiz-btn quiz-btn-primary" style="color: white;">ç­›é€‰</button>
                {% if current_filters.type or current_filters.difficulty %}
                <a href="{% url 'knowledge_app:quiz_wrong_answers' %}" class="quiz-btn quiz-btn-outline" style="color: var(--quiz-primary);">æ¸…é™¤</a>
                {% endif %}
            </form>
            
            {% if page_obj %}
            <div style="display: flex; gap: 1rem;"><a href="{% url 'knowledge_app:quiz_practice_wrong_answers' %}" class="quiz-btn quiz-btn-warning" style="color: white;"><span>ğŸ”„</span><span>é”™é¢˜ç»ƒä¹ </span></a><a href="{% url 'knowledge_app:quiz_export_wrong_answers_pdf' %}"
                   class="quiz-btn quiz-btn-primary"
                   style="color: white;"
                   onclick="return handleWrongAnswersPdfExport(this)"><span>ğŸ“„</span><span>å¯¼å‡ºPDF</span></a></div>
            {% endif %}
        </div><!-- é”™é¢˜åˆ—è¡¨ -->
        {% if page_obj %}
        <div style="display: flex; flex-direction: column; gap: 1.5rem;">
            {% for wrong_answer in page_obj %}
            <div style="border: 1px solid var(--quiz-danger); border-radius: var(--quiz-radius-lg); padding: 2rem; background: rgba(239, 68, 68, 0.05);"><!-- é¢˜ç›®ä¿¡æ¯ --><div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;"><div style="flex: 1;"><h3 style="color: black !important; margin: 0 0 0.5rem 0;">{{ wrong_answer.question.title }}</h3><p style="color: black !important; margin: 0 0 1rem 0; line-height: 1.6;">
                            {{ wrong_answer.question.content }}
                        </p>
                        {% if wrong_answer.question.question_image %}
                        <div style="margin: 1rem 0;"><img src="{{ wrong_answer.question.question_image.url }}" 
                                 style="max-width: 300px; max-height: 200px; border-radius: var(--quiz-radius); box-shadow: var(--quiz-shadow);"
                                 alt="é¢˜ç›®å›¾ç‰‡"></div>
                        {% endif %}
                    </div><div style="display: flex; gap: 0.5rem; flex-wrap: wrap;"><span class="quiz-tag quiz-tag-primary">{{ wrong_answer.question.get_question_type_display }}</span><span class="quiz-tag {% if wrong_answer.question.difficulty == 1 %}quiz-tag-success{% elif wrong_answer.question.difficulty == 2 %}quiz-tag-warning{% else %}quiz-tag-danger{% endif %}">
                            {{ wrong_answer.question.get_difficulty_display }}
                        </span><span class="quiz-tag quiz-tag-danger">é”™è¯¯{{ wrong_answer.wrong_count }}æ¬¡</span></div></div><!-- é€‰é¡¹æ˜¾ç¤ºï¼ˆé€‰æ‹©é¢˜ï¼‰ -->
                {% if wrong_answer.question.question_type in 'single_choice,multiple_choice' %}
                <div style="margin-bottom: 1.5rem;"><div style="color: black !important; font-weight: 600; margin-bottom: 1rem;">é€‰é¡¹ï¼š</div><div style="display: grid; gap: 0.5rem;">
                        {% for key, value in wrong_answer.question.options.items %}
                        <div style="display: flex; align-items: flex-start; padding: 0.75rem; background: white !important; border-radius: var(--quiz-radius); border: 1px solid var(--quiz-gray-200);"><span style="font-weight: 600; color: black !important; margin-right: 1rem; margin-top: 0.2rem;">{{ key }}.</span><div style="flex: 1;"><span style="color: black !important;">{{ value }}</span><!-- é€‰é¡¹å›¾ç‰‡ -->
                                {% if wrong_answer.question.option_images and wrong_answer.question.option_images|get_item:key %}
                                <div style="margin-top: 0.5rem;"><img src="/media/{{ wrong_answer.question.option_images|get_item:key }}"
                                         style="max-width: 150px; max-height: 100px; border-radius: var(--quiz-radius); box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                                         alt="é€‰é¡¹{{ key }}å›¾ç‰‡"
                                         onclick="openImageModal('/media/{{ wrong_answer.question.option_images|get_item:key }}')"></div>
                                {% endif %}
                            </div></div>
                        {% endfor %}
                    </div></div>
                {% endif %}

                <!-- ç­”æ¡ˆå¯¹æ¯” --><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 1.5rem;"><div style="background: rgba(239, 68, 68, 0.1); padding: 1.5rem; border-radius: var(--quiz-radius-lg); border: 1px solid var(--quiz-danger);"><h4 style="color: var(--quiz-danger) !important; margin: 0 0 0.5rem 0;">âŒ ä½ çš„ç­”æ¡ˆ</h4><p style="color: black !important; margin: 0; font-weight: 500;">{{ wrong_answer.wrong_answer }}</p></div><div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: var(--quiz-radius-lg); border: 1px solid var(--quiz-success);"><h4 style="color: var(--quiz-success) !important; margin: 0 0 0.5rem 0;">âœ… æ­£ç¡®ç­”æ¡ˆ</h4><p style="color: black !important; margin: 0; font-weight: 500;">{{ wrong_answer.correct_answer }}</p></div></div><!-- ç­”æ¡ˆè§£æ -->
                {% if wrong_answer.question.explanation %}
                <div style="background: rgba(99, 102, 241, 0.1); padding: 1.5rem; border-radius: var(--quiz-radius-lg); margin-bottom: 1.5rem;"><h4 style="color: var(--quiz-primary) !important; margin: 0 0 0.5rem 0;">ğŸ’¡ ç­”æ¡ˆè§£æ</h4><p style="color: black !important; margin: 0; line-height: 1.6;">{{ wrong_answer.question.explanation }}</p></div>
                {% endif %}

                <!-- AIåˆ†æç»“æœ -->
                {% if wrong_answer.ai_analysis %}
                <div style="background: rgba(245, 158, 11, 0.1); padding: 1.5rem; border-radius: var(--quiz-radius-lg); margin-bottom: 1.5rem;"><h4 style="color: var(--quiz-warning) !important; margin: 0 0 0.5rem 0;">ğŸ¤– AIåˆ†æ</h4><p style="color: black !important; margin: 0 0 1rem 0; line-height: 1.6;">{{ wrong_answer.ai_analysis }}</p>
                    {% if wrong_answer.study_suggestion %}
                    <div style="border-top: 1px solid rgba(245, 158, 11, 0.3); padding-top: 1rem;"><h5 style="color: var(--quiz-warning) !important; margin: 0 0 0.5rem 0;">ğŸ“š å­¦ä¹ å»ºè®®</h5><p style="color: black !important; margin: 0; line-height: 1.6;">{{ wrong_answer.study_suggestion }}</p></div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- æ“ä½œæŒ‰é’® --><div style="display: flex; justify-content: space-between; align-items: center; padding-top: 1rem; border-top: 1px solid var(--quiz-gray-200);"><div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        {% for tag in wrong_answer.question.tags.all %}
                        <span class="quiz-tag">{{ tag.name }}</span>
                        {% endfor %}
                        {% if not wrong_answer.question.tags.all %}
                        <span style="color: var(--quiz-gray-400); font-size: 0.9rem;">æ— æ ‡ç­¾</span>
                        {% endif %}
                    </div><div style="display: flex; gap: 0.5rem; align-items: center;"><span style="color: var(--quiz-gray-500); font-size: 0.9rem;">
                            {{ wrong_answer.last_wrong_at|date:"m-d H:i" }}
                        </span>
                        {% if not wrong_answer.ai_analysis %}
                        <button class="quiz-btn quiz-btn-warning" 
                                style="font-size: 0.8rem; padding: 0.4rem 0.8rem; color: white;" 
                                onclick="analyzeWrongAnswer({{ wrong_answer.id }})">
                            ğŸ¤– AIåˆ†æ
                        </button>
                        {% endif %}
                        <button class="quiz-btn quiz-btn-success" 
                                style="font-size: 0.8rem; padding: 0.4rem 0.8rem; color: white;" 
                                onclick="markMastered({{ wrong_answer.id }})">
                            âœ… å·²æŒæ¡
                        </button></div></div></div>
            {% endfor %}
        </div><!-- åˆ†é¡µ -->
        {% if page_obj.has_other_pages %}
        <div style="display: flex; justify-content: center; margin-top: 2rem;"><div style="display: flex; gap: 0.5rem; align-items: center;">
                {% if page_obj.has_previous %}
                <a href="?page=1{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="quiz-btn quiz-btn-outline" style="color: var(--quiz-primary);">é¦–é¡µ</a><a href="?page={{ page_obj.previous_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="quiz-btn quiz-btn-outline" style="color: var(--quiz-primary);">ä¸Šä¸€é¡µ</a>
                {% endif %}
                
                <span style="padding: 0.75rem 1rem; color: var(--quiz-gray-600);">
                    ç¬¬ {{ page_obj.number }} é¡µï¼Œå…± {{ page_obj.paginator.num_pages }} é¡µ
                </span>
                
                {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="quiz-btn quiz-btn-outline" style="color: var(--quiz-primary);">ä¸‹ä¸€é¡µ</a><a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in current_filters.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="quiz-btn quiz-btn-outline" style="color: var(--quiz-primary);">æœ«é¡µ</a>
                {% endif %}
            </div></div>
        {% endif %}

        {% else %}
        <!-- ç©ºçŠ¶æ€ --><div style="text-align: center; padding: 4rem 2rem;"><div style="font-size: 6rem; margin-bottom: 2rem; opacity: 0.5;">ğŸ‰</div><h2 style="color: var(--quiz-gray-600); margin-bottom: 1rem;">å¤ªæ£’äº†ï¼æ²¡æœ‰é”™é¢˜</h2><p style="color: var(--quiz-gray-500); margin-bottom: 2rem;">ç»§ç»­ä¿æŒï¼Œæˆ–è€…å»ç»ƒä¹ æ›´å¤šé¢˜ç›®å§ï¼</p><a href="{% url 'knowledge_app:quiz_dashboard' %}" class="quiz-btn quiz-btn-primary" style="color: white;"><span>ğŸ </span><span>è¿”å›é¦–é¡µ</span></a></div>
        {% endif %}
    </div></div><!-- å›¾ç‰‡æ¨¡æ€æ¡† --><div id="imageModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); cursor: pointer;" onclick="closeImageModal()"><div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); max-width: 90%; max-height: 90%;"><img id="modalImage" style="max-width: 100%; max-height: 100%; border-radius: var(--quiz-radius);" alt="æ”¾å¤§å›¾ç‰‡"><div style="position: absolute; top: -40px; right: 0; color: white; font-size: 2rem; cursor: pointer;" onclick="closeImageModal()">&times;</div></div></div><script>function analyzeWrongAnswer(wrongAnswerId) { const button = event.target; const originalText = button.innerHTML; button.innerHTML = 'â³ åˆ†æä¸­...'; button.disabled = true; fetch(`/quiz/wrong-answers/${wrongAnswerId}/analyze/`, { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken') } }) .then(response => response.json()) .then(data => { if (data.success) { location.reload(); } else { alert('AIåˆ†æå¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯')); button.innerHTML = originalText; button.disabled = false; } }) .catch(error => { console.error('AIåˆ†æå¤±è´¥:', error); alert('AIåˆ†æå¤±è´¥ï¼Œè¯·ç¨åå†è¯•'); button.innerHTML = originalText; button.disabled = false; }); } function markMastered(wrongAnswerId) { if (!confirm('ç¡®å®šè¦æ ‡è®°è¿™é“é¢˜ä¸ºå·²æŒæ¡å—ï¼Ÿ')) { return; } fetch(`/quiz/wrong-answers/${wrongAnswerId}/mastered/`, { method: 'POST', headers: { 'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken') } }) .then(response => response.json()) .then(data => { if (data.success) { event.target.closest('div[style*="border: 1px solid var(--quiz-danger)"]').remove(); const remainingItems = document.querySelectorAll('div[style*="border: 1px solid var(--quiz-danger)"]'); if (remainingItems.length === 0) { location.reload(); } } else { alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•'); } }) .catch(error => { console.error('æ ‡è®°å¤±è´¥:', error); alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åå†è¯•'); }); } function getCookie(name) { let cookieValue = null; if (document.cookie && document.cookie !== '') { const cookies = document.cookie.split(';'); for (let i = 0; i < cookies.length; i++) { const cookie = cookies[i].trim(); if (cookie.substring(0, name.length + 1) === (name + '=')) { cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); break; } } } return cookieValue; } function handleWrongAnswersPdfExport(element) { console.log('é”™é¢˜æœ¬PDFå¯¼å‡ºæŒ‰é’®è¢«ç‚¹å‡»'); console.log('å¯¼å‡ºURL:', element.href); const originalText = element.innerHTML; element.innerHTML = '<span>â³</span><span>å¯¼å‡ºä¸­...</span>'; element.style.pointerEvents = 'none'; setTimeout(() => { element.innerHTML = originalText; element.style.pointerEvents = 'auto'; }, 3000); return true; } function openImageModal(imageSrc) { const modal = document.getElementById('imageModal'); const modalImage = document.getElementById('modalImage'); modalImage.src = imageSrc; modal.style.display = 'block'; document.body.style.overflow = 'hidden'; } function closeImageModal() { const modal = document.getElementById('imageModal'); modal.style.display = 'none'; document.body.style.overflow = 'auto'; } document.addEventListener('keydown', function(event) { if (event.key === 'Escape') { closeImageModal(); } });</script>
{% endblock %}
