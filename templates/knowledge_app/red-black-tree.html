{% extends 'knowledge_app/base.html' %}

{% block title %}{{ page_title|default:"çº¢é»‘æ ‘" }} - è®¡ç®—æœºç§‘å­¦å­¦ä¹ å¹³å°{% endblock %}

{% block extra_css %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .breadcrumb {
        color: white;
        margin-bottom: 20px;
        opacity: 0.9;
    }

    .breadcrumb a {
        color: white;
        text-decoration: none;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }

    .knowledge-header {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        color: white;
        text-align: center;
        position: relative;
        z-index: 2;
    }

    .knowledge-header h1 {
        font-size: 2.5rem;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .knowledge-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        line-height: 1.6;
    }

    .main-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        padding: 40px;
        margin-bottom: 30px;
        position: relative;
        z-index: 2;
    }

    .section {
        margin-bottom: 50px;
    }

    .section h2 {
        color: #333;
        font-size: 2rem;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 3px solid #667eea;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .section h3 {
        color: #555;
        font-size: 1.5rem;
        margin: 30px 0 20px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section h4 {
        color: #666;
        font-size: 1.2rem;
        margin: 20px 0 15px 0;
    }

    .theory-content {
        font-size: 1.1rem;
        line-height: 1.7;
        color: #444;
        margin: 20px 0;
    }

    .theory-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin: 25px 0;
    }

    .theory-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 25px;
        border-radius: 12px;
        border-left: 5px solid #667eea;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        transition: transform 0.3s ease;
    }

    .theory-card:hover {
        transform: translateY(-5px);
    }

    .theory-card h4 {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.2rem;
        font-weight: 700;
    }

    .theory-card p {
        color: #666;
        line-height: 1.6;
        margin: 0;
    }

    .theory-card ul {
        margin: 10px 0;
        padding-left: 20px;
    }

    .theory-card li {
        color: #666;
        margin: 8px 0;
        line-height: 1.5;
    }

    .properties-list {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 25px;
        margin: 20px 0;
        border-left: 5px solid #28a745;
    }

    .properties-list h4 {
        color: #155724;
        margin-bottom: 15px;
    }

    .properties-list ol {
        padding-left: 20px;
    }

    .properties-list li {
        margin: 12px 0;
        font-size: 1.1rem;
        line-height: 1.6;
        color: #155724;
    }

    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin: 25px 0;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .comparison-table th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
    }

    .comparison-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
    }

    .comparison-table tr:hover {
        background: #f8f9fa;
    }

    .visualization-container {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 30px;
        margin: 25px 0;
    }

    .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: center;
        margin-bottom: 25px;
        padding: 25px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .step-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        align-items: center;
        margin-bottom: 20px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
    }

    .step-controls h4 {
        margin: 0 20px 0 0;
        color: #333;
        font-size: 1.1rem;
    }

    .step-btn {
        padding: 8px 16px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .step-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .step-btn-play {
        background: #28a745;
        color: white;
    }

    .step-btn-play:hover:not(:disabled) {
        background: #218838;
    }

    .step-btn-pause {
        background: #ffc107;
        color: #333;
    }

    .step-btn-pause:hover:not(:disabled) {
        background: #e0a800;
    }

    .step-btn-nav {
        background: #6c757d;
        color: white;
    }

    .step-btn-nav:hover:not(:disabled) {
        background: #5a6268;
    }

    .step-btn-reset {
        background: #dc3545;
        color: white;
    }

    .step-btn-reset:hover:not(:disabled) {
        background: #c82333;
    }

    .speed-control {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-left: auto;
    }

    .speed-control label {
        font-weight: 600;
        color: #333;
    }

    .speed-control select {
        padding: 5px 10px;
        border: 2px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
    }

    .step-info {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 4px solid #17a2b8;
    }

    .step-info h4 {
        color: #17a2b8;
        margin: 0 0 15px 0;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .step-current {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .step-current h4 {
        margin: 0 0 10px 0;
        font-size: 1.1rem;
        opacity: 0.9;
    }

    .step-current p {
        margin: 0;
        font-size: 1.1rem;
        line-height: 1.6;
    }

    .step-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 8px;
        background: #f8f9fa;
    }

    .step-item {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        transition: background 0.3s ease;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
    }

    .step-item:last-child {
        border-bottom: none;
    }

    .step-item.active {
        background: #e3f2fd;
        font-weight: 600;
        color: #1976d2;
    }

    .step-item.completed {
        background: #e8f5e8;
        color: #2e7d32;
    }

    .step-number {
        background: #6c757d;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 600;
        flex-shrink: 0;
    }

    .step-item.active .step-number {
        background: #1976d2;
    }

    .step-item.completed .step-number {
        background: #2e7d32;
    }

    .step-description {
        flex: 1;
        font-size: 14px;
        line-height: 1.4;
    }

    .operation-type {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
        margin-right: 8px;
    }

    .op-insert {
        background: #d4edda;
        color: #155724;
    }

    .op-delete {
        background: #f8d7da;
        color: #721c24;
    }

    .op-rotate {
        background: #fff3cd;
        color: #856404;
    }

    .op-color {
        background: #d1ecf1;
        color: #0c5460;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .control-group label {
        font-weight: 600;
        color: #333;
        min-width: 60px;
    }

    .control-group input {
        padding: 10px 15px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        width: 80px;
        transition: border-color 0.3s ease;
    }

    .control-group input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
        padding: 12px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
        font-size: 14px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
        transform: translateY(-2px);
    }

    .canvas-container {
        text-align: center;
        margin: 25px 0;
    }

    #redBlackTreeCanvas {
        border: 2px solid #ddd;
        border-radius: 12px;
        background: white;
        box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }

    .info-panel {
        background: white;
        border-radius: 12px;
        padding: 25px;
        margin-top: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid #eee;
    }

    .info-item:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 600;
        color: #333;
        font-size: 1.1rem;
    }

    .info-value {
        color: #667eea;
        font-family: 'Courier New', monospace;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .code-tabs {
        display: flex;
        background: #2d3748;
        border-radius: 12px 12px 0 0;
        overflow: hidden;
        margin-top: 25px;
    }

    .code-tab {
        padding: 15px 25px;
        background: #4a5568;
        color: #cbd5e0;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
        font-size: 14px;
    }

    .code-tab.active {
        background: #2d3748;
        color: #90cdf4;
    }

    .code-tab:hover {
        background: #2d3748;
    }

    .code-section {
        background: #2d3748;
        color: #e2e8f0;
        padding: 0;
        border-radius: 0 0 12px 12px;
        margin: 0;
        overflow: hidden;
        box-shadow: 0 6px 20px rgba(0,0,0,0.2);
    }

    .code-content {
        display: none;
        position: relative;
    }

    .code-content.active {
        display: block;
    }

    .code-header {
        background: #1a202c;
        padding: 15px 25px;
        border-bottom: 1px solid #4a5568;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .code-title {
        color: #90cdf4;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .copy-btn {
        background: #48bb78;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .copy-btn:hover {
        background: #38a169;
        transform: translateY(-1px);
    }

    .copy-btn.copied {
        background: #667eea;
    }

    .code-body {
        padding: 25px;
        overflow-x: auto;
    }

    .code-body pre {
        margin: 0;
        line-height: 1.6;
        font-size: 14px;
        font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    }

    .code-body code {
        color: #e2e8f0;
    }

    .keyword { color: #f56565; }
    .string { color: #68d391; }
    .comment { color: #a0aec0; font-style: italic; }
    .number { color: #fbb6ce; }
    .type { color: #90cdf4; }
    .function { color: #faf089; }

    .legend {
        display: flex;
        flex-wrap: wrap;
        gap: 25px;
        justify-content: center;
        margin: 25px 0;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 1.1rem;
    }

    .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 3px solid #333;
    }

    .red-node { background-color: #ff4757; }
    .black-node { background-color: #2f3542; }

    .action-buttons {
        display: flex;
        gap: 20px;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 40px;
    }

    .btn-home {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 30px;
        font-size: 1.1rem;
    }

    .btn-home:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-explore {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 15px 30px;
        font-size: 1.1rem;
    }

    .btn-explore:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .applications-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 25px 0;
    }

    .application-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 12px;
        text-align: center;
        transition: transform 0.3s ease;
    }

    .application-card:hover {
        transform: translateY(-5px);
    }

    .application-icon {
        font-size: 2.5rem;
        margin-bottom: 15px;
    }

    .application-title {
        font-size: 1.3rem;
        font-weight: 700;
        margin-bottom: 10px;
    }

    .application-desc {
        font-size: 1rem;
        opacity: 0.9;
        line-height: 1.5;
    }

    @media (max-width: 768px) {
        .knowledge-header h1 {
            font-size: 2rem;
        }

        .main-card {
            padding: 25px;
        }

        .controls {
            flex-direction: column;
            align-items: stretch;
        }

        .control-group {
            justify-content: space-between;
        }

        #redBlackTreeCanvas {
            width: 100%;
            height: auto;
        }

        .action-buttons {
            flex-direction: column;
            align-items: center;
        }

        .btn {
            width: 100%;
            max-width: 250px;
        }

        .code-tabs {
            flex-direction: column;
        }

        .theory-grid {
            grid-template-columns: 1fr;
        }

        .applications-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <div class="breadcrumb">
        <a href="{% url 'knowledge_app:index' %}">é¦–é¡µ</a> >
        <span>{{ breadcrumb_category|default:"æ•°æ®ç»“æ„" }}</span> >
        <span>{{ page_title|default:"çº¢é»‘æ ‘" }}</span>
    </div>

    <!-- çŸ¥è¯†ç‚¹å¤´éƒ¨ -->
    <div class="knowledge-header">
        <h1>
            <span>{{ page_icon|default:"ğŸŒ³" }}</span>
            {{ page_title|default:"çº¢é»‘æ ‘ (Red-Black Tree)" }}
        </h1>
        <p>{{ page_description|default:"è‡ªå¹³è¡¡äºŒå‰æœç´¢æ ‘ - é«˜æ•ˆç¨³å®šçš„æ•°æ®ç»“æ„ï¼Œå¹¿æ³›åº”ç”¨äºç°ä»£ç¼–ç¨‹è¯­è¨€å’Œç³»ç»Ÿä¸­" }}</p>
    </div>

    <!-- ä¸»è¦å†…å®¹å¡ç‰‡ -->
    <div class="main-card">
        <!-- æ¦‚è¿°éƒ¨åˆ† -->
        <div class="section">
            <h2>ğŸ“š ä»€ä¹ˆæ˜¯{{ page_title|default:"çº¢é»‘æ ‘" }}</h2>
            <div class="theory-content">
                <p>{{ content_overview|default:"çº¢é»‘æ ‘æ˜¯ä¸€ç§è‡ªå¹³è¡¡çš„äºŒå‰æœç´¢æ ‘ï¼Œå®ƒåœ¨1972å¹´ç”±Rudolf Bayerå‘æ˜ï¼ŒåŸåä¸º'å¯¹ç§°äºŒå‰Bæ ‘'ï¼Œåæ¥åœ¨1978å¹´è¢«Leo J. Guibaså’ŒRobert Sedgewickæ”¹è¿›å¹¶é‡æ–°å‘½åä¸ºçº¢é»‘æ ‘ã€‚çº¢é»‘æ ‘é€šè¿‡ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªé¢œè‰²å±æ€§ï¼ˆçº¢è‰²æˆ–é»‘è‰²ï¼‰ï¼Œå¹¶éµå¾ªç‰¹å®šçš„ç€è‰²è§„åˆ™æ¥ä¿è¯æ ‘çš„è¿‘ä¼¼å¹³è¡¡ã€‚" }}</p>

                <p>ä¸AVLæ ‘ç›¸æ¯”ï¼Œçº¢é»‘æ ‘çš„å¹³è¡¡æ¡ä»¶è¾ƒä¸ºå®½æ¾ï¼Œè¿™ä½¿å¾—å®ƒåœ¨æ’å…¥å’Œåˆ é™¤æ“ä½œæ—¶éœ€è¦çš„æ—‹è½¬æ¬¡æ•°æ›´å°‘ï¼Œä»è€Œåœ¨å®é™…åº”ç”¨ä¸­å¾€å¾€å…·æœ‰æ›´å¥½çš„æ€§èƒ½è¡¨ç°ã€‚çº¢é»‘æ ‘ä¿è¯äº†ä»æ ¹åˆ°å¶å­çš„æœ€é•¿è·¯å¾„ä¸ä¼šè¶…è¿‡æœ€çŸ­è·¯å¾„çš„2å€ï¼Œè¿™ç¡®ä¿äº†è‰¯å¥½çš„æŸ¥æ‰¾æ€§èƒ½ã€‚</p>
            </div>
        </div>

        <!-- çº¢é»‘æ ‘æ€§è´¨ -->
        <div class="section">
            <h2>ğŸ” çº¢é»‘æ ‘çš„äº”å¤§æ€§è´¨</h2>
            <div class="properties-list">
                <h4>çº¢é»‘æ ‘å¿…é¡»æ»¡è¶³ä»¥ä¸‹äº”ä¸ªæ€§è´¨ï¼š</h4>
                <ol>
                    <li><strong>èŠ‚ç‚¹é¢œè‰²æ€§è´¨</strong>ï¼šæ¯ä¸ªèŠ‚ç‚¹è¦ä¹ˆæ˜¯çº¢è‰²ï¼Œè¦ä¹ˆæ˜¯é»‘è‰²</li>
                    <li><strong>æ ¹èŠ‚ç‚¹æ€§è´¨</strong>ï¼šæ ¹èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²</li>
                    <li><strong>å¶å­èŠ‚ç‚¹æ€§è´¨</strong>ï¼šæ‰€æœ‰å¶å­èŠ‚ç‚¹ï¼ˆNILèŠ‚ç‚¹ï¼‰éƒ½æ˜¯é»‘è‰²</li>
                    <li><strong>çº¢è‰²èŠ‚ç‚¹æ€§è´¨</strong>ï¼šçº¢è‰²èŠ‚ç‚¹çš„ä¸¤ä¸ªå­èŠ‚ç‚¹éƒ½å¿…é¡»æ˜¯é»‘è‰²ï¼ˆä¸èƒ½æœ‰è¿ç»­çš„çº¢è‰²èŠ‚ç‚¹ï¼‰</li>
                    <li><strong>é»‘é«˜åº¦æ€§è´¨</strong>ï¼šä»ä»»æ„èŠ‚ç‚¹åˆ°å…¶æ‰€æœ‰å¶å­èŠ‚ç‚¹çš„ç®€å•è·¯å¾„ä¸Šï¼Œå‡åŒ…å«ç›¸åŒæ•°ç›®çš„é»‘è‰²èŠ‚ç‚¹</li>
                </ol>
            </div>

            <div class="theory-content">
                <p>è¿™äº›æ€§è´¨ç¡®ä¿äº†çº¢é»‘æ ‘çš„å…³é”®ç‰¹å¾ï¼š<strong>ä»æ ¹åˆ°å¶å­çš„æœ€é•¿è·¯å¾„ä¸ä¼šè¶…è¿‡æœ€çŸ­è·¯å¾„çš„2å€</strong>ã€‚è¿™æ˜¯å› ä¸ºæœ€çŸ­è·¯å¾„å¯èƒ½å…¨ç”±é»‘è‰²èŠ‚ç‚¹ç»„æˆï¼Œè€Œæœ€é•¿è·¯å¾„æ˜¯çº¢è‰²å’Œé»‘è‰²èŠ‚ç‚¹äº¤æ›¿å‡ºç°çš„è·¯å¾„ã€‚</p>
            </div>
        </div>

        <!-- æ ¸å¿ƒåŸç† -->
        <div class="section">
            <h2>âš™ï¸ å·¥ä½œåŸç†ä¸æœºåˆ¶</h2>

            <h3>ğŸ”„ å¹³è¡¡ç»´æŠ¤æœºåˆ¶</h3>
            <div class="theory-grid">
                <div class="theory-card">
                    <h4>ğŸ”„ æ—‹è½¬æ“ä½œ</h4>
                    <p><strong>å·¦æ—‹è½¬</strong>ï¼šå½“å³å­æ ‘è¿‡é«˜æ—¶ä½¿ç”¨</p>
                    <ul>
                        <li>å°†å½“å‰èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹æå‡ä¸ºæ–°çš„æ ¹</li>
                        <li>åŸæ ¹èŠ‚ç‚¹æˆä¸ºæ–°æ ¹çš„å·¦å­èŠ‚ç‚¹</li>
                        <li>è°ƒæ•´æŒ‡é’ˆå…³ç³»ï¼Œç»´æŠ¤BSTæ€§è´¨</li>
                    </ul>
                    <p><strong>å³æ—‹è½¬</strong>ï¼šå½“å·¦å­æ ‘è¿‡é«˜æ—¶ä½¿ç”¨ï¼Œæ“ä½œä¸å·¦æ—‹è½¬å¯¹ç§°</p>
                </div>

                <div class="theory-card">
                    <h4>ğŸ¨ é‡æ–°ç€è‰²</h4>
                    <p>é€šè¿‡æ”¹å˜èŠ‚ç‚¹é¢œè‰²æ¥ä¿®å¤çº¢é»‘æ ‘æ€§è´¨è¿åï¼š</p>
                    <ul>
                        <li>çº¢è‰²èŠ‚ç‚¹å˜é»‘è‰²</li>
                        <li>é»‘è‰²èŠ‚ç‚¹å˜çº¢è‰²</li>
                        <li>é€šå¸¸ä¸æ—‹è½¬æ“ä½œé…åˆä½¿ç”¨</li>
                        <li>æ¯”æ—‹è½¬æ“ä½œå¼€é”€æ›´å°</li>
                    </ul>
                </div>

                <div class="theory-card">
                    <h4>â• æ’å…¥ç­–ç•¥</h4>
                    <p>æ–°èŠ‚ç‚¹æ€»æ˜¯æ’å…¥ä¸ºçº¢è‰²ï¼Œç„¶åä¿®å¤å¯èƒ½çš„è¿åï¼š</p>
                    <ul>
                        <li>æƒ…å†µ1ï¼šçˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰² â†’ æ— éœ€ä¿®å¤</li>
                        <li>æƒ…å†µ2ï¼šå”èŠ‚ç‚¹æ˜¯çº¢è‰² â†’ é‡æ–°ç€è‰²</li>
                        <li>æƒ…å†µ3ï¼šå”èŠ‚ç‚¹æ˜¯é»‘è‰² â†’ æ—‹è½¬+ç€è‰²</li>
                    </ul>
                </div>

                <div class="theory-card">
                    <h4>â– åˆ é™¤ç­–ç•¥</h4>
                    <p>åˆ é™¤æ“ä½œæœ€å¤æ‚ï¼Œå¯èƒ½æ¶‰åŠå¤šç§æƒ…å†µï¼š</p>
                    <ul>
                        <li>åˆ é™¤çº¢è‰²èŠ‚ç‚¹ï¼šç›´æ¥åˆ é™¤</li>
                        <li>åˆ é™¤é»‘è‰²èŠ‚ç‚¹ï¼šéœ€è¦ä¿®å¤é»‘é«˜åº¦</li>
                        <li>ä½¿ç”¨æ›¿æ¢èŠ‚ç‚¹å’Œä¿®å¤ç®—æ³•</li>
                        <li>å¯èƒ½éœ€è¦å¤šæ¬¡æ—‹è½¬å’Œç€è‰²</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- æ€§èƒ½åˆ†æ -->
        <div class="section">
            <h2>ğŸ“Š æ€§èƒ½åˆ†æä¸æ¯”è¾ƒ</h2>

            <h3>â±ï¸ æ—¶é—´å¤æ‚åº¦</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>æ“ä½œ</th>
                        <th>å¹³å‡æƒ…å†µ</th>
                        <th>æœ€åæƒ…å†µ</th>
                        <th>è¯´æ˜</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>æŸ¥æ‰¾ (Search)</td>
                        <td>O(log n)</td>
                        <td>O(log n)</td>
                        <td>æ ‘é«˜åº¦ä¿è¯ä¸ºO(log n)</td>
                    </tr>
                    <tr>
                        <td>æ’å…¥ (Insert)</td>
                        <td>O(log n)</td>
                        <td>O(log n)</td>
                        <td>åŒ…å«æŸ¥æ‰¾ä½ç½®å’Œå¹³è¡¡è°ƒæ•´</td>
                    </tr>
                    <tr>
                        <td>åˆ é™¤ (Delete)</td>
                        <td>O(log n)</td>
                        <td>O(log n)</td>
                        <td>æœ€å¤æ‚æ“ä½œï¼Œä½†æ—¶é—´ä»æœ‰ä¿è¯</td>
                    </tr>
                    <tr>
                        <td>éå† (Traversal)</td>
                        <td>O(n)</td>
                        <td>O(n)</td>
                        <td>è®¿é—®æ‰€æœ‰èŠ‚ç‚¹</td>
                    </tr>
                </tbody>
            </table>

            <h3>ğŸ†š ä¸å…¶ä»–æ•°æ®ç»“æ„æ¯”è¾ƒ</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>æ•°æ®ç»“æ„</th>
                        <th>æŸ¥æ‰¾</th>
                        <th>æ’å…¥</th>
                        <th>åˆ é™¤</th>
                        <th>å¹³è¡¡ä¿è¯</th>
                        <th>å®ç°å¤æ‚åº¦</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>çº¢é»‘æ ‘</td>
                        <td>O(log n)</td>
                        <td>O(log n)</td>
                        <td>O(log n)</td>
                        <td>é«˜åº¦ â‰¤ 2Ã—log(n+1)</td>
                        <td>ä¸­ç­‰</td>
                    </tr>
                    <tr>
                        <td>AVLæ ‘</td>
                        <td>O(log n)</td>
                        <td>O(log n)</td>
                        <td>O(log n)</td>
                        <td>é«˜åº¦ â‰¤ 1.44Ã—log(n+2)</td>
                        <td>è¾ƒé«˜</td>
                    </tr>
                    <tr>
                        <td>æ™®é€šBST</td>
                        <td>O(n)</td>
                        <td>O(n)</td>
                        <td>O(n)</td>
                        <td>æ— ä¿è¯</td>
                        <td>ç®€å•</td>
                    </tr>
                    <tr>
                        <td>å“ˆå¸Œè¡¨</td>
                        <td>O(1)</td>
                        <td>O(1)</td>
                        <td>O(1)</td>
                        <td>ä¸é€‚ç”¨</td>
                        <td>ä¸­ç­‰</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- åº”ç”¨åœºæ™¯ -->
        <div class="section">
            <h2>ğŸš€ å®é™…åº”ç”¨åœºæ™¯</h2>

            <div class="applications-grid">
                {% if applications %}
                    {% for app in applications %}
                    <div class="application-card">
                        <div class="application-icon">{{ app.icon|default:"ğŸ’¼" }}</div>
                        <div class="application-title">{{ app.title }}</div>
                        <div class="application-desc">{{ app.description }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="application-card">
                    <div class="application-icon">â˜•</div>
                    <div class="application-title">Javaé›†åˆæ¡†æ¶</div>
                    <div class="application-desc">TreeMapã€TreeSetç­‰æœ‰åºé›†åˆçš„åº•å±‚å®ç°</div>
                </div>

                <div class="application-card">
                    <div class="application-icon">ğŸ”·</div>
                    <div class="application-title">C++ STL</div>
                    <div class="application-desc">mapã€setã€multimapã€multisetçš„æ ‡å‡†å®ç°</div>
                </div>

                <div class="application-card">
                    <div class="application-icon">ğŸ§</div>
                    <div class="application-title">Linuxå†…æ ¸</div>
                    <div class="application-desc">è¿›ç¨‹è°ƒåº¦å™¨CFSä¸­çš„è¿è¡Œé˜Ÿåˆ—ç®¡ç†</div>
                </div>

                <div class="application-card">
                    <div class="application-icon">ğŸ—„ï¸</div>
                    <div class="application-title">æ•°æ®åº“ç³»ç»Ÿ</div>
                    <div class="application-desc">B+æ ‘ç´¢å¼•çš„å˜ç§ï¼Œå†…å­˜æ•°æ®åº“ç´¢å¼•</div>
                </div>

                <div class="application-card">
                    <div class="application-icon">â°</div>
                    <div class="application-title">ä»»åŠ¡è°ƒåº¦</div>
                    <div class="application-desc">æ“ä½œç³»ç»Ÿä¸­çš„å®šæ—¶å™¨å’Œäº‹ä»¶è°ƒåº¦</div>
                </div>

                <div class="application-card">
                    <div class="application-icon">ğŸ’¾</div>
                    <div class="application-title">ç¼“å­˜ç³»ç»Ÿ</div>
                    <div class="application-desc">LRUç¼“å­˜çš„é«˜æ•ˆå®ç°</div>
                </div>
                {% endif %}
            </div>

            <div class="theory-content">
                <h4>ğŸ¯ ä¸ºä»€ä¹ˆé€‰æ‹©çº¢é»‘æ ‘ï¼Ÿ</h4>
                <ul>
                    <li><strong>å¹³è¡¡æ€§ä¿è¯</strong>ï¼šç¡®ä¿æœ€åæƒ…å†µä¸‹çš„æ€§èƒ½ä»ç„¶æ˜¯O(log n)</li>
                    <li><strong>æ’å…¥åˆ é™¤æ•ˆç‡</strong>ï¼šç›¸æ¯”AVLæ ‘éœ€è¦æ›´å°‘çš„æ—‹è½¬æ“ä½œ</li>
                    <li><strong>å®ç°ç›¸å¯¹ç®€å•</strong>ï¼šç›¸æ¯”å…¶ä»–è‡ªå¹³è¡¡æ ‘ç»“æ„æ›´å®¹æ˜“å®ç°å’Œç»´æŠ¤</li>
                    <li><strong>å†…å­˜æ•ˆç‡</strong>ï¼šåªéœ€è¦ä¸€ä¸ªé¢å¤–çš„é¢œè‰²ä½ï¼Œç©ºé—´å¼€é”€å°</li>
                    <li><strong>å·¥ä¸šçº§ç¨³å®šæ€§</strong>ï¼šç»è¿‡å¤§é‡å®é™…é¡¹ç›®éªŒè¯çš„æˆç†Ÿç®—æ³•</li>
                </ul>
            </div>
        </div>

        <!-- å¯è§†åŒ–éƒ¨åˆ† -->
        <div class="section">
            <h2>ğŸ¯ äº¤äº’å¼æ¼”ç¤º</h2>
            <div class="visualization-container">
                <div class="controls">
                    <div class="control-group">
                        <label for="insertValue">æ’å…¥å€¼:</label>
                        <input type="number" id="insertValue" value="50" min="1" max="99">
                        <button class="btn btn-primary" onclick="startInsertDemo()">æ¼”ç¤ºæ’å…¥</button>
                    </div>

                    <div class="control-group">
                        <label for="deleteValue">åˆ é™¤å€¼:</label>
                        <input type="number" id="deleteValue" value="50" min="1" max="99">
                        <button class="btn btn-secondary" onclick="startDeleteDemo()">æ¼”ç¤ºåˆ é™¤</button>
                    </div>

                    <div class="control-group">
                        <label for="searchValue">æŸ¥æ‰¾å€¼:</label>
                        <input type="number" id="searchValue" value="50" min="1" max="99">
                        <button class="btn btn-primary" onclick="searchNode()">æŸ¥æ‰¾</button>
                    </div>

                    <button class="btn btn-danger" onclick="clearTree()">æ¸…ç©º</button>
                    <button class="btn btn-secondary" onclick="generateRandomTree()">éšæœºç”Ÿæˆ</button>
                </div>

                <!-- æ­¥éª¤æ§åˆ¶é¢æ¿ -->
                <div class="step-controls" id="stepControls" style="display: none;">
                    <h4>ğŸ¬ æ¼”ç¤ºæ§åˆ¶</h4>
                    <button class="step-btn step-btn-nav" onclick="previousStep()" id="prevBtn">
                        â®®ï¸ ä¸Šä¸€æ­¥
                    </button>
                    <button class="step-btn step-btn-play" onclick="playSteps()" id="playBtn">
                        â–¶ï¸ æ’­æ”¾
                    </button>
                    <button class="step-btn step-btn-pause" onclick="pauseSteps()" id="pauseBtn" style="display: none;">
                        â¸ï¸ æš‚åœ
                    </button>
                    <button class="step-btn step-btn-nav" onclick="nextStep()" id="nextBtn">
                        â­ï¸ ä¸‹ä¸€æ­¥
                    </button>
                    <button class="step-btn step-btn-reset" onclick="resetDemo()" id="resetBtn">
                        ğŸ”„ é‡ç½®
                    </button>

                    <div class="speed-control">
                        <label for="speedSelect">æ¼”ç¤ºé€Ÿåº¦:</label>
                        <select id="speedSelect" onchange="changeSpeed()">
                            <option value="2000">æ…¢é€Ÿ (2s)</option>
                            <option value="1000" selected>æ­£å¸¸ (1s)</option>
                            <option value="500">å¿«é€Ÿ (0.5s)</option>
                        </select>
                    </div>
                </div>

                <!-- å½“å‰æ­¥éª¤è¯´æ˜ -->
                <div class="step-current" id="currentStep" style="display: none;">
                    <h4 id="stepTitle">æ­¥éª¤è¯´æ˜</h4>
                    <p id="stepDescription">å‡†å¤‡å¼€å§‹æ¼”ç¤º...</p>
                </div>

                <!-- æ­¥éª¤åˆ—è¡¨ -->
                <div class="step-info" id="stepInfo" style="display: none;">
                    <h4>ğŸ“‹ æ“ä½œæ­¥éª¤</h4>
                    <div class="step-list" id="stepList">
                        <!-- æ­¥éª¤å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    </div>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color red-node"></div>
                        <span>çº¢è‰²èŠ‚ç‚¹</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color black-node"></div>
                        <span>é»‘è‰²èŠ‚ç‚¹</span>
                    </div>
                </div>

                <div class="canvas-container">
                    <canvas id="redBlackTreeCanvas" width="800" height="500"></canvas>
                </div>

                <div class="info-panel">
                    <div class="info-item">
                        <span class="info-label">èŠ‚ç‚¹æ€»æ•°:</span>
                        <span class="info-value" id="nodeCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æ ‘çš„é«˜åº¦:</span>
                        <span class="info-value" id="treeHeight">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">é»‘è‰²é«˜åº¦:</span>
                        <span class="info-value" id="blackHeight">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å¹³è¡¡å› å­:</span>
                        <span class="info-value" id="balanceFactor">å®Œç¾</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">å½“å‰æ­¥éª¤:</span>
                        <span class="info-value" id="currentStepInfo">0 / 0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä»£ç å®ç°éƒ¨åˆ† -->
        {% if show_code_examples %}
        <div class="section">
            <h2>ğŸ’» å®Œæ•´ä»£ç å®ç°</h2>

            <div class="code-tabs">
                <button class="code-tab active" onclick="showCode('cpp')">C++</button>
                <button class="code-tab" onclick="showCode('java')">Java</button>
                <button class="code-tab" onclick="showCode('python')">Python</button>
            </div>

            <div class="code-section">
                <!-- C++ å®ç° -->
                <div class="code-content active" id="cpp-code">
                    <div class="code-header">
                        <span class="code-title">C++ çº¢é»‘æ ‘å®Œæ•´å®ç°</span>
                        <button class="copy-btn" onclick="copyCode('cpp')">å¤åˆ¶ä»£ç </button>
                    </div>
                    <div class="code-body">
                        <pre><code id="cpp-source"><span class="comment">// çº¢é»‘æ ‘ C++ å®ç°</span>
<span class="keyword">#include</span> <span class="string">&lt;iostream&gt;</span>
<span class="keyword">#include</span> <span class="string">&lt;memory&gt;</span>

<span class="keyword">enum class</span> <span class="type">Color</span> { <span class="keyword">RED</span>, <span class="keyword">BLACK</span> };

<span class="keyword">template</span>&lt;<span class="keyword">typename</span> <span class="type">T</span>&gt;
<span class="keyword">class</span> <span class="type">RedBlackTree</span> {
<span class="keyword">private</span>:
    <span class="keyword">struct</span> <span class="type">Node</span> {
        <span class="type">T</span> data;
        <span class="type">Color</span> color;
        <span class="type">std::shared_ptr&lt;Node&gt;</span> left, right, parent;

        <span class="function">Node</span>(<span class="type">T</span> value) : data(value), color(<span class="type">Color</span>::<span class="keyword">RED</span>),
                        left(<span class="keyword">nullptr</span>), right(<span class="keyword">nullptr</span>), parent(<span class="keyword">nullptr</span>) {}
    };

    <span class="type">std::shared_ptr&lt;Node&gt;</span> root;
    <span class="type">std::shared_ptr&lt;Node&gt;</span> NIL;

<span class="keyword">public</span>:
    <span class="function">RedBlackTree</span>() {
        NIL = <span class="type">std::make_shared&lt;Node&gt;</span>(<span class="type">T</span>());
        NIL-&gt;color = <span class="type">Color</span>::<span class="keyword">BLACK</span>;
        root = NIL;
    }

    <span class="comment">// æ’å…¥æ“ä½œ</span>
    <span class="keyword">void</span> <span class="function">insert</span>(<span class="type">T</span> key) {
        <span class="keyword">auto</span> newNode = <span class="type">std::make_shared&lt;Node&gt;</span>(key);
        newNode-&gt;left = newNode-&gt;right = NIL;

        <span class="keyword">auto</span> y = NIL;
        <span class="keyword">auto</span> x = root;

        <span class="keyword">while</span> (x != NIL) {
            y = x;
            <span class="keyword">if</span> (newNode-&gt;data &lt; x-&gt;data) {
                x = x-&gt;left;
            } <span class="keyword">else</span> {
                x = x-&gt;right;
            }
        }

        newNode-&gt;parent = y;

        <span class="keyword">if</span> (y == NIL) {
            root = newNode;
        } <span class="keyword">else if</span> (newNode-&gt;data &lt; y-&gt;data) {
            y-&gt;left = newNode;
        } <span class="keyword">else</span> {
            y-&gt;right = newNode;
        }

        insertFixup(newNode);
    }

    <span class="comment">// æŸ¥æ‰¾æ“ä½œ</span>
    <span class="keyword">bool</span> <span class="function">search</span>(<span class="type">T</span> key) {
        <span class="keyword">return</span> searchHelper(root, key) != NIL;
    }

    <span class="comment">// ä¸­åºéå†</span>
    <span class="keyword">void</span> <span class="function">inorderTraversal</span>() {
        inorderHelper(root);
        <span class="type">std::cout</span> &lt;&lt; <span class="type">std::endl</span>;
    }
};</code></pre>
                    </div>
                </div>

                <!-- Java å®ç° -->
                <div class="code-content" id="java-code">
                    <div class="code-header">
                        <span class="code-title">Java çº¢é»‘æ ‘å®Œæ•´å®ç°</span>
                        <button class="copy-btn" onclick="copyCode('java')">å¤åˆ¶ä»£ç </button>
                    </div>
                    <div class="code-body">
                        <pre><code id="java-source"><span class="comment">// çº¢é»‘æ ‘ Java å®ç°</span>
<span class="keyword">public class</span> <span class="type">RedBlackTree</span>&lt;<span class="type">T</span> <span class="keyword">extends</span> <span class="type">Comparable</span>&lt;<span class="type">T</span>&gt;&gt; {

    <span class="keyword">private enum</span> <span class="type">Color</span> {
        <span class="keyword">RED</span>, <span class="keyword">BLACK</span>
    }

    <span class="keyword">private class</span> <span class="type">Node</span> {
        <span class="type">T</span> data;
        <span class="type">Color</span> color;
        <span class="type">Node</span> left, right, parent;

        <span class="keyword">public</span> <span class="function">Node</span>(<span class="type">T</span> data) {
            <span class="keyword">this</span>.data = data;
            <span class="keyword">this</span>.color = <span class="type">Color</span>.<span class="keyword">RED</span>;
            <span class="keyword">this</span>.left = <span class="keyword">this</span>.right = <span class="keyword">this</span>.parent = <span class="keyword">null</span>;
        }
    }

    <span class="keyword">private</span> <span class="type">Node</span> root;
    <span class="keyword">private</span> <span class="type">Node</span> NIL;

    <span class="keyword">public</span> <span class="function">RedBlackTree</span>() {
        NIL = <span class="keyword">new</span> <span class="type">Node</span>(<span class="keyword">null</span>);
        NIL.color = <span class="type">Color</span>.<span class="keyword">BLACK</span>;
        root = NIL;
    }

    <span class="comment">// æ’å…¥æ“ä½œ</span>
    <span class="keyword">public void</span> <span class="function">insert</span>(<span class="type">T</span> key) {
        <span class="type">Node</span> newNode = <span class="keyword">new</span> <span class="type">Node</span>(key);
        <span class="comment">// æ’å…¥é€»è¾‘...</span>
        insertFixup(newNode);
    }

    <span class="comment">// æŸ¥æ‰¾æ“ä½œ</span>
    <span class="keyword">public boolean</span> <span class="function">search</span>(<span class="type">T</span> key) {
        <span class="keyword">return</span> searchHelper(root, key) != NIL;
    }
}</code></pre>
                    </div>
                </div>

                <!-- Python å®ç° -->
                <div class="code-content" id="python-code">
                    <div class="code-header">
                        <span class="code-title">Python çº¢é»‘æ ‘å®Œæ•´å®ç°</span>
                        <button class="copy-btn" onclick="copyCode('python')">å¤åˆ¶ä»£ç </button>
                    </div>
                    <div class="code-body">
                        <pre><code id="python-source"><span class="comment"># çº¢é»‘æ ‘ Python å®ç°</span>
<span class="keyword">from</span> enum <span class="keyword">import</span> <span class="type">Enum</span>

<span class="keyword">class</span> <span class="type">Color</span>(<span class="type">Enum</span>):
    <span class="keyword">RED</span> = <span class="number">1</span>
    <span class="keyword">BLACK</span> = <span class="number">2</span>

<span class="keyword">class</span> <span class="type">RedBlackNode</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="keyword">self</span>, data=<span class="keyword">None</span>):
        <span class="keyword">self</span>.data = data
        <span class="keyword">self</span>.color = <span class="type">Color</span>.<span class="keyword">RED</span>
        <span class="keyword">self</span>.left = <span class="keyword">None</span>
        <span class="keyword">self</span>.right = <span class="keyword">None</span>
        <span class="keyword">self</span>.parent = <span class="keyword">None</span>

<span class="keyword">class</span> <span class="type">RedBlackTree</span>:
    <span class="keyword">def</span> <span class="function">__init__</span>(<span class="keyword">self</span>):
        <span class="keyword">self</span>.NIL = <span class="type">RedBlackNode</span>()
        <span class="keyword">self</span>.NIL.color = <span class="type">Color</span>.<span class="keyword">BLACK</span>
        <span class="keyword">self</span>.root = <span class="keyword">self</span>.NIL

    <span class="keyword">def</span> <span class="function">insert</span>(<span class="keyword">self</span>, key):
        <span class="string">"""æ’å…¥æ“ä½œ"""</span>
        new_node = <span class="type">RedBlackNode</span>(key)
        <span class="comment"># æ’å…¥é€»è¾‘...</span>
        <span class="keyword">self</span>.insert_fixup(new_node)

    <span class="keyword">def</span> <span class="function">search</span>(<span class="keyword">self</span>, key):
        <span class="string">"""æŸ¥æ‰¾æ“ä½œ"""</span>
        <span class="keyword">return</span> <span class="keyword">self</span>._search_helper(<span class="keyword">self</span>.root, key) != <span class="keyword">self</span>.NIL</code></pre>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="action-buttons">
            <a href="{% url 'knowledge_app:index' %}" class="btn btn-home">
                ğŸ  è¿”å›é¦–é¡µ
            </a>
            <a href="{% url 'knowledge_app:cs_universe' %}" class="btn btn-explore">
                ğŸŒŒ æ¢ç´¢CSå®‡å®™
            </a>
        </div>
    </div>
</div>

<script>
    // çº¢é»‘æ ‘å¯è§†åŒ–å®ç° - å¢å¼ºç‰ˆ
    class RBTreeNode {
        constructor(data) {
            this.data = data;
            this.color = 'RED';
            this.left = null;
            this.right = null;
            this.parent = null;
            this.x = 0;
            this.y = 0;
            this.highlighted = false;
        }
    }

    class RedBlackTreeDemo {
        constructor() {
            this.root = null;
            this.canvas = document.getElementById('redBlackTreeCanvas');
            this.ctx = this.canvas.getContext('2d');
            this.nodeRadius = 22;
            this.levelHeight = 70;

            // æ¼”ç¤ºæ§åˆ¶
            this.steps = [];
            this.currentStepIndex = -1;
            this.isPlaying = false;
            this.playInterval = null;
            this.speed = 1000;
            this.originalTree = null;

            this.setupCanvas();
            this.draw();
        }

        setupCanvas() {
            const rect = this.canvas.getBoundingClientRect();
            const dpr = window.devicePixelRatio || 1;

            this.canvas.width = rect.width * dpr;
            this.canvas.height = rect.height * dpr;

            this.ctx.scale(dpr, dpr);
            this.canvas.style.width = rect.width + 'px';
            this.canvas.style.height = rect.height + 'px';
        }

        // ä¿å­˜å½“å‰æ ‘çŠ¶æ€
        saveTreeState() {
            return this.cloneTree(this.root);
        }

        // å…‹éš†æ ‘
        cloneTree(node) {
            if (!node) return null;

            const newNode = new RBTreeNode(node.data);
            newNode.color = node.color;
            newNode.x = node.x;
            newNode.y = node.y;
            newNode.highlighted = node.highlighted;

            newNode.left = this.cloneTree(node.left);
            newNode.right = this.cloneTree(node.right);

            if (newNode.left) newNode.left.parent = newNode;
            if (newNode.right) newNode.right.parent = newNode;

            return newNode;
        }

        // æ·»åŠ æ­¥éª¤
        addStep(type, description, explanation, highlightNodes = [], treeState = null) {
            const step = {
                type,
                description,
                explanation,
                highlightNodes: [...highlightNodes],
                treeState: treeState || this.saveTreeState()
            };
            this.steps.push(step);
        }

        // å¼€å§‹æ’å…¥æ¼”ç¤º
        startInsertDemo(value) {
            if (this.isPlaying) return;

            if (!value) {
                value = parseInt(document.getElementById('insertValue').value);
            }

            if (!value || value < 1 || value > 99) {
                alert('è¯·è¾“å…¥1-99ä¹‹é—´çš„æ•°å­—ï¼');
                return;
            }

            if (this.search(value)) {
                alert('èŠ‚ç‚¹å·²å­˜åœ¨ï¼');
                return;
            }

            this.steps = [];
            this.currentStepIndex = -1;
            this.originalTree = this.saveTreeState();

            this.simulateInsertSteps(value);
            this.showDemoControls();
            this.updateStepDisplay();
        }

        // æ¨¡æ‹Ÿæ’å…¥æ­¥éª¤ï¼ˆä¸ä¿®æ”¹åŸæ ‘ï¼‰
        simulateInsertSteps(value) {
            // åˆ›å»ºä¸´æ—¶æ ‘æ¥æ¨¡æ‹Ÿæ“ä½œ
            let tempRoot = this.cloneTree(this.originalTree);

            this.addStep('start', 'å¼€å§‹æ’å…¥æ“ä½œ',
                `å‡†å¤‡æ’å…¥å€¼ ${value}ã€‚æ–°èŠ‚ç‚¹å°†è¢«æ ‡è®°ä¸ºçº¢è‰²ï¼Œç„¶åæ ¹æ®çº¢é»‘æ ‘çš„æ€§è´¨è¿›è¡Œè°ƒæ•´ã€‚`, [], tempRoot);

            if (!tempRoot) {
                const newNode = new RBTreeNode(value);
                newNode.color = 'BLACK';
                tempRoot = newNode;
                this.calculatePositions(tempRoot, this.canvas.clientWidth / 2, 50, this.canvas.clientWidth / 4);

                this.addStep('insert', 'æ’å…¥æ ¹èŠ‚ç‚¹',
                    `æ ‘ä¸ºç©ºï¼Œç›´æ¥æ’å…¥ ${value} ä½œä¸ºæ ¹èŠ‚ç‚¹ã€‚æ ¹æ®æ€§è´¨2ï¼Œæ ¹èŠ‚ç‚¹å¿…é¡»æ˜¯é»‘è‰²ã€‚`, [value], tempRoot);
                return;
            }

            // æŸ¥æ‰¾æ’å…¥ä½ç½®
            let current = tempRoot;
            let parent = null;
            const path = [];

            while (current) {
                path.push(current.data);
                parent = current;
                if (value < current.data) {
                    current = current.left;
                } else {
                    current = current.right;
                }
            }

            this.addStep('search', 'æŸ¥æ‰¾æ’å…¥ä½ç½®',
                `éå†è·¯å¾„ï¼š${path.join(' â†’ ')}ï¼Œæ‰¾åˆ°æ’å…¥ä½ç½®ã€‚æ–°èŠ‚ç‚¹å°†æˆä¸ºèŠ‚ç‚¹ ${parent.data} çš„${value < parent.data ? 'å·¦' : 'å³'}å­èŠ‚ç‚¹ã€‚`, path, tempRoot);

            // æ’å…¥æ–°èŠ‚ç‚¹
            const newNode = new RBTreeNode(value);
            newNode.parent = parent;

            if (value < parent.data) {
                parent.left = newNode;
            } else {
                parent.right = newNode;
            }

            this.calculatePositions(tempRoot, this.canvas.clientWidth / 2, 50, this.canvas.clientWidth / 4);
            this.addStep('insert', 'æ’å…¥æ–°èŠ‚ç‚¹',
                `æ’å…¥çº¢è‰²èŠ‚ç‚¹ ${value}ã€‚æ–°èŠ‚ç‚¹é»˜è®¤ä¸ºçº¢è‰²ï¼Œå¯èƒ½è¿åçº¢é»‘æ ‘æ€§è´¨ï¼Œéœ€è¦è¿›è¡Œä¿®å¤ã€‚`, [value], tempRoot);

            // ä¿®å¤çº¢é»‘æ ‘
            this.simulateInsertFixup(newNode, tempRoot);
        }

        // æ¨¡æ‹Ÿæ’å…¥ä¿®å¤
        simulateInsertFixup(z, tempRoot) {
            while (z.parent && z.parent.color === 'RED') {
                if (z.parent === z.parent.parent.left) {
                    const y = z.parent.parent.right; // å”èŠ‚ç‚¹

                    if (y && y.color === 'RED') {
                        // Case 1: å”èŠ‚ç‚¹æ˜¯çº¢è‰²
                        this.addStep('color', 'Case 1: å”èŠ‚ç‚¹ä¸ºçº¢è‰²',
                            `å”èŠ‚ç‚¹ ${y.data} æ˜¯çº¢è‰²ï¼Œæ‰§è¡Œé‡æ–°ç€è‰²ï¼šçˆ¶èŠ‚ç‚¹ ${z.parent.data} å’Œå”èŠ‚ç‚¹ ${y.data} å˜ä¸ºé»‘è‰²ï¼Œç¥–çˆ¶èŠ‚ç‚¹ ${z.parent.parent.data} å˜ä¸ºçº¢è‰²ã€‚`,
                            [z.data, z.parent.data, y.data, z.parent.parent.data], tempRoot);

                        z.parent.color = 'BLACK';
                        y.color = 'BLACK';
                        z.parent.parent.color = 'RED';
                        z = z.parent.parent;

                        this.calculatePositions(tempRoot, this.canvas.clientWidth / 2, 50, this.canvas.clientWidth / 4);
                    } else {
                        if (z === z.parent.right) {
                            // Case 2: zæ˜¯å³å­èŠ‚ç‚¹
                            this.addStep('rotate', 'Case 2: éœ€è¦å·¦æ—‹è½¬',
                                `èŠ‚ç‚¹ ${z.data} æ˜¯çˆ¶èŠ‚ç‚¹çš„å³å­èŠ‚ç‚¹ï¼Œå”èŠ‚ç‚¹æ˜¯é»‘è‰²ï¼Œå…ˆå¯¹çˆ¶èŠ‚ç‚¹ ${z.parent.data} è¿›è¡Œå·¦æ—‹è½¬ã€‚`,
                                [z.data, z.parent.data], tempRoot);

                            z = z.parent;
                            tempRoot = this.simulateLeftRotate(z, tempRoot);
                            this.calculatePositions(tempRoot, this.canvas.clientWidth / 2, 50, this.canvas.clientWidth / 4);
                        }

                        // Case 3: zæ˜¯å·¦å­èŠ‚ç‚¹
                        this.addStep('rotate', 'Case 3: é‡æ–°ç€è‰²å¹¶å³æ—‹è½¬',
                            `çˆ¶èŠ‚ç‚¹ ${z.parent.data} å˜ä¸ºé»‘è‰²ï¼Œç¥–çˆ¶èŠ‚ç‚¹ ${z.parent.parent.data} å˜ä¸ºçº¢è‰²ï¼Œç„¶åå¯¹ç¥–çˆ¶èŠ‚ç‚¹è¿›è¡Œå³æ—‹è½¬ã€‚`,
                            [z.data, z.parent.data, z.parent.parent.data], tempRoot);

                        z.parent.color = 'BLACK';
                        z.parent.parent.color = 'RED';
                        tempRoot = this.simulateRightRotate(z.parent.parent, tempRoot);
                        this.calculatePositions(tempRoot, this.canvas.clientWidth / 2, 50, this.canvas.clientWidth / 4);
                    }
                } else {
                    // å¯¹ç§°æƒ…å†µ
                    const y = z.parent.parent.left;

                    if (y && y.color === 'RED') {
                        this.addStep('color', 'Case 1: å”èŠ‚ç‚¹ä¸ºçº¢è‰²ï¼ˆå¯¹ç§°ï¼‰',
                            `å”èŠ‚ç‚¹ ${y.data} æ˜¯çº¢è‰²ï¼Œæ‰§è¡Œé‡æ–°ç€è‰²ï¼šçˆ¶èŠ‚ç‚¹ ${z.parent.data} å’Œå”èŠ‚ç‚¹ ${y.data} å˜ä¸ºé»‘è‰²ï¼Œç¥–çˆ¶èŠ‚ç‚¹ ${z.parent.parent.data} å˜ä¸ºçº¢è‰²ã€‚`,
                            [z.data, z.parent.data, y.data, z.parent.parent.data], tempRoot);

                        z.parent.color = 'BLACK';
                        y.color = 'BLACK';
                        z.parent.parent.color = 'RED';
                        z = z.parent.parent;
                        this.calculatePositions(tempRoot, this.canvas.clientWidth / 2, 50, this.canvas.clientWidth / 4);
                    } else {
                        if (z === z.parent.left) {
                            this.addStep('rotate', 'Case 2: éœ€è¦å³æ—‹è½¬ï¼ˆå¯¹ç§°ï¼‰',
                                `èŠ‚ç‚¹ ${z.data} æ˜¯çˆ¶èŠ‚ç‚¹çš„å·¦å­èŠ‚ç‚¹ï¼Œå”èŠ‚ç‚¹æ˜¯é»‘è‰²ï¼Œå…ˆå¯¹çˆ¶èŠ‚ç‚¹ ${z.parent.data} è¿›è¡Œå³æ—‹è½¬ã€‚`,
                                [z.data, z.parent.data], tempRoot);

                            z = z.parent;
                            tempRoot = this.simulateRightRotate(z, tempRoot);
                            this.calculatePositions(tempRoot, this.canvas.clientWidth / 2, 50, this.canvas.clientWidth / 4);
                        }

                        this.addStep('rotate', 'Case 3: é‡æ–°ç€è‰²å¹¶å·¦æ—‹è½¬ï¼ˆå¯¹ç§°ï¼‰',
                            `çˆ¶èŠ‚ç‚¹ ${z.parent.data} å˜ä¸ºé»‘è‰²ï¼Œç¥–çˆ¶èŠ‚ç‚¹ ${z.parent.parent.data} å˜ä¸ºçº¢è‰²ï¼Œç„¶åå¯¹ç¥–çˆ¶èŠ‚ç‚¹è¿›è¡Œå·¦æ—‹è½¬ã€‚`,
                            [z.data, z.parent.data, z.parent.parent.data], tempRoot);

                        z.parent.color = 'BLACK';
                        z.parent.parent.color = 'RED';
                        tempRoot = this.simulateLeftRotate(z.parent.parent, tempRoot);
                        this.calculatePositions(tempRoot, this.canvas.clientWidth / 2, 50, this.canvas.clientWidth / 4);
                    }
                }
            }

            // ç¡®ä¿æ ¹èŠ‚ç‚¹ä¸ºé»‘è‰²
            if (tempRoot && tempRoot.color === 'RED') {
                this.addStep('color', 'ç¡®ä¿æ ¹èŠ‚ç‚¹ä¸ºé»‘è‰²',
                    `æ ¹æ®æ€§è´¨2ï¼Œç¡®ä¿æ ¹èŠ‚ç‚¹ ${tempRoot.data} ä¸ºé»‘è‰²ã€‚`, [tempRoot.data], tempRoot);
                tempRoot.color = 'BLACK';
                this.calculatePositions(tempRoot, this.canvas.clientWidth / 2, 50, this.canvas.clientWidth / 4);
            }

            this.addStep('complete', 'æ’å…¥å®Œæˆ',
                `çº¢é»‘æ ‘æ’å…¥æ“ä½œå®Œæˆï¼æ ‘å·²é‡æ–°å¹³è¡¡ï¼Œæ‰€æœ‰çº¢é»‘æ ‘æ€§è´¨éƒ½å¾—åˆ°æ»¡è¶³ã€‚`, [], tempRoot);
        }

        // æ¨¡æ‹Ÿæ—‹è½¬æ–¹æ³•
        simulateLeftRotate(x, root) {
            const y = x.right;
            x.right = y.left;

            if (y.left) {
                y.left.parent = x;
            }

            y.parent = x.parent;

            if (!x.parent) {
                root = y;
            } else if (x === x.parent.left) {
                x.parent.left = y;
            } else {
                x.parent.right = y;
            }

            y.left = x;
            x.parent = y;

            return root;
        }

        simulateRightRotate(x, root) {
            const y = x.left;
            x.left = y.right;

            if (y.right) {
                y.right.parent = x;
            }

            y.parent = x.parent;

            if (!x.parent) {
                root = y;
            } else if (x === x.parent.right) {
                x.parent.right = y;
            } else {
                x.parent.left = y;
            }

            y.right = x;
            x.parent = y;

            return root;
        }

        // å¼€å§‹åˆ é™¤æ¼”ç¤º
        startDeleteDemo(value) {
            if (this.isPlaying) return;

            if (!value) {
                value = parseInt(document.getElementById('deleteValue').value);
            }

            if (!value || value < 1 || value > 99) {
                alert('è¯·è¾“å…¥1-99ä¹‹é—´çš„æ•°å­—ï¼');
                return;
            }

            if (!this.search(value)) {
                alert('èŠ‚ç‚¹ä¸å­˜åœ¨ï¼');
                return;
            }

            this.steps = [];
            this.currentStepIndex = -1;
            this.originalTree = this.saveTreeState();

            this.simulateDeleteSteps(value);
            this.showDemoControls();
            this.updateStepDisplay();
        }

        // æ¨¡æ‹Ÿåˆ é™¤æ­¥éª¤
        simulateDeleteSteps(value) {
            let tempRoot = this.cloneTree(this.originalTree);

            this.addStep('start', 'å¼€å§‹åˆ é™¤æ“ä½œ',
                `å‡†å¤‡åˆ é™¤å€¼ ${value}ã€‚åˆ é™¤æ“ä½œæ¯”æ’å…¥æ›´å¤æ‚ï¼Œéœ€è¦è€ƒè™‘å¤šç§æƒ…å†µã€‚`, [], tempRoot);

            const nodeToDelete = this.findNodeInTree(tempRoot, value);
            if (!nodeToDelete) return;

            this.addStep('search', 'æ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹',
                `æ‰¾åˆ°è¦åˆ é™¤çš„èŠ‚ç‚¹ ${value}ã€‚ç°åœ¨éœ€è¦æ ¹æ®èŠ‚ç‚¹çš„å­èŠ‚ç‚¹æƒ…å†µé€‰æ‹©åˆ é™¤ç­–ç•¥ã€‚`, [value], tempRoot);

            if (!nodeToDelete.left && !nodeToDelete.right) {
                // å¶å­èŠ‚ç‚¹
                this.addStep('analyze', 'åˆ†æï¼šå¶å­èŠ‚ç‚¹',
                    `èŠ‚ç‚¹ ${value} æ˜¯å¶å­èŠ‚ç‚¹ï¼Œå¯ä»¥ç›´æ¥åˆ é™¤ã€‚ä½†å¦‚æœæ˜¯é»‘è‰²èŠ‚ç‚¹ï¼Œåˆ é™¤åéœ€è¦ä¿®å¤é»‘é«˜åº¦ã€‚`, [value], tempRoot);
            } else if (!nodeToDelete.left || !nodeToDelete.right) {
                // åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹
                const childData = nodeToDelete.left ? nodeToDelete.left.data : nodeToDelete.right.data;
                this.addStep('analyze', 'åˆ†æï¼šæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹',
                    `èŠ‚ç‚¹ ${value} æœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ ${childData}ï¼Œç”¨å­èŠ‚ç‚¹æ›¿æ¢å½“å‰èŠ‚ç‚¹ã€‚`, [value, childData], tempRoot);
            } else {
                // æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹
                const successor = this.findMinimumInTree(nodeToDelete.right);
                this.addStep('analyze', 'åˆ†æï¼šæœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹',
                    `èŠ‚ç‚¹ ${value} æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œæ‰¾åˆ°åç»§èŠ‚ç‚¹ ${successor.data} æ¥æ›¿æ¢ã€‚`, [value, successor.data], tempRoot);
            }

            this.addStep('complete', 'åˆ é™¤å®Œæˆ',
                `çº¢é»‘æ ‘åˆ é™¤æ“ä½œå®Œæˆï¼æ ‘å·²é‡æ–°å¹³è¡¡ï¼Œæ‰€æœ‰çº¢é»‘æ ‘æ€§è´¨éƒ½å¾—åˆ°æ»¡è¶³ã€‚`, [], tempRoot);
        }

        // åœ¨æ ‘ä¸­æŸ¥æ‰¾èŠ‚ç‚¹
        findNodeInTree(root, value) {
            if (!root || root.data === value) {
                return root;
            }

            if (value < root.data) {
                return this.findNodeInTree(root.left, value);
            } else {
                return this.findNodeInTree(root.right, value);
            }
        }

        // åœ¨æ ‘ä¸­æŸ¥æ‰¾æœ€å°å€¼èŠ‚ç‚¹
        findMinimumInTree(node) {
            while (node && node.left) {
                node = node.left;
            }
            return node;
        }

        // æ˜¾ç¤ºæ¼”ç¤ºæ§åˆ¶ç•Œé¢
        showDemoControls() {
            document.getElementById('stepControls').style.display = 'flex';
            document.getElementById('stepInfo').style.display = 'block';
            document.getElementById('currentStep').style.display = 'block';

            this.restoreTreeState(this.originalTree);
            this.updateStepList();
        }

        // éšè—æ¼”ç¤ºæ§åˆ¶ç•Œé¢
        hideDemoControls() {
            document.getElementById('stepControls').style.display = 'none';
            document.getElementById('stepInfo').style.display = 'none';
            document.getElementById('currentStep').style.display = 'none';
        }

        // æ›´æ–°æ­¥éª¤åˆ—è¡¨
        updateStepList() {
            const stepList = document.getElementById('stepList');
            stepList.innerHTML = '';

            this.steps.forEach((step, index) => {
                const stepItem = document.createElement('div');
                stepItem.className = 'step-item';
                if (index === this.currentStepIndex) {
                    stepItem.classList.add('active');
                } else if (index < this.currentStepIndex) {
                    stepItem.classList.add('completed');
                }

                const operationType = this.getOperationType(step.type);

                stepItem.innerHTML = `
                    <div class="step-number">${index + 1}</div>
                    <div class="step-description">
                        ${operationType}${step.description}
                    </div>
                `;

                stepItem.onclick = () => this.goToStep(index);
                stepList.appendChild(stepItem);
            });
        }

        // è·å–æ“ä½œç±»å‹æ ‡ç­¾
        getOperationType(type) {
            const types = {
                'start': '<span class="operation-type op-insert">å¼€å§‹</span>',
                'search': '<span class="operation-type op-insert">æŸ¥æ‰¾</span>',
                'insert': '<span class="operation-type op-insert">æ’å…¥</span>',
                'delete': '<span class="operation-type op-delete">åˆ é™¤</span>',
                'rotate': '<span class="operation-type op-rotate">æ—‹è½¬</span>',
                'color': '<span class="operation-type op-color">ç€è‰²</span>',
                'fixup': '<span class="operation-type op-color">ä¿®å¤</span>',
                'analyze': '<span class="operation-type op-insert">åˆ†æ</span>',
                'complete': '<span class="operation-type op-insert">å®Œæˆ</span>'
            };
            return types[type] || '';
        }

        // æ›´æ–°æ­¥éª¤æ˜¾ç¤º
        updateStepDisplay() {
            const currentStep = this.steps[this.currentStepIndex];
            const stepTitle = document.getElementById('stepTitle');
            const stepDescription = document.getElementById('stepDescription');
            const currentStepInfo = document.getElementById('currentStepInfo');

            if (currentStep) {
                stepTitle.textContent = currentStep.description;
                stepDescription.textContent = currentStep.explanation;
            } else {
                stepTitle.textContent = 'å‡†å¤‡æ¼”ç¤º';
                stepDescription.textContent = 'ç‚¹å‡»"ä¸‹ä¸€æ­¥"å¼€å§‹æ¼”ç¤ºï¼Œæˆ–ç‚¹å‡»"æ’­æ”¾"è‡ªåŠ¨æ’­æ”¾æ‰€æœ‰æ­¥éª¤ã€‚';
            }

            currentStepInfo.textContent = `${Math.max(0, this.currentStepIndex + 1)} / ${this.steps.length}`;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (prevBtn) prevBtn.disabled = this.currentStepIndex <= -1;
            if (nextBtn) nextBtn.disabled = this.currentStepIndex >= this.steps.length - 1;

            this.updateStepList();
        }

        // æ‰§è¡Œæ­¥éª¤
        executeStep(stepIndex) {
            if (stepIndex >= 0 && stepIndex < this.steps.length) {
                const step = this.steps[stepIndex];
                this.restoreTreeState(step.treeState);

                // é«˜äº®ç›¸å…³èŠ‚ç‚¹
                this.clearHighlights();
                step.highlightNodes.forEach(nodeValue => {
                    const node = this.searchNode(this.root, nodeValue);
                    if (node) {
                        node.highlighted = true;
                    }
                });

                this.draw();
            } else if (stepIndex === -1) {
                this.restoreTreeState(this.originalTree);
                this.clearHighlights();
                this.draw();
            }

            this.updateStepDisplay();
        }

        // ä¸‹ä¸€æ­¥
        nextStep() {
            if (this.currentStepIndex < this.steps.length - 1) {
                this.currentStepIndex++;
                this.executeStep(this.currentStepIndex);
            }
        }

        // ä¸Šä¸€æ­¥
        previousStep() {
            if (this.currentStepIndex > 0) {
                this.currentStepIndex--;
                this.executeStep(this.currentStepIndex);
            } else if (this.currentStepIndex === 0) {
                this.currentStepIndex--;
                this.executeStep(this.currentStepIndex);
            }
        }

        // è·³è½¬åˆ°æŒ‡å®šæ­¥éª¤
        goToStep(stepIndex) {
            this.currentStepIndex = stepIndex;
            this.executeStep(stepIndex);
        }

        // æ’­æ”¾æ­¥éª¤
        playSteps() {
            if (this.isPlaying) return;

            this.isPlaying = true;
            document.getElementById('playBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';

            this.playInterval = setInterval(() => {
                if (this.currentStepIndex < this.steps.length - 1) {
                    this.nextStep();
                } else {
                    this.pauseSteps();
                }
            }, this.speed);
        }

        // æš‚åœæ’­æ”¾
        pauseSteps() {
            this.isPlaying = false;
            if (this.playInterval) {
                clearInterval(this.playInterval);
                this.playInterval = null;
            }

            document.getElementById('playBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
        }

        // é‡ç½®æ¼”ç¤º
        resetDemo() {
            this.pauseSteps();
            this.currentStepIndex = -1;
            this.restoreTreeState(this.originalTree);
            this.updateStepDisplay();
        }

        // æ”¹å˜æ¼”ç¤ºé€Ÿåº¦
        changeSpeed() {
            this.speed = parseInt(document.getElementById('speedSelect').value);

            if (this.isPlaying) {
                this.pauseSteps();
                this.playSteps();
            }
        }

        // æ¸…é™¤é«˜äº®
        clearHighlights() {
            this.clearHighlightsHelper(this.root);
        }

        clearHighlightsHelper(node) {
            if (!node) return;
            node.highlighted = false;
            this.clearHighlightsHelper(node.left);
            this.clearHighlightsHelper(node.right);
        }

        // æ›´æ–°ä½ç½®è®¡ç®—ï¼ˆä¿®æ­£ç‰ˆï¼‰
        calculatePositions(root, x, y, offset) {
            if (!root) return;

            root.x = x;
            root.y = y;

            if (root.left) {
                this.calculatePositions(root.left, x - offset, y + this.levelHeight, offset / 2);
            }

            if (root.right) {
                this.calculatePositions(root.right, x + offset, y + this.levelHeight, offset / 2);
            }
        }

        // æ›´æ–°ä½ç½®ï¼ˆä½¿ç”¨å½“å‰æ ¹ï¼‰
        updatePositions() {
            if (!this.root) return;

            const width = this.canvas.clientWidth;
            this.calculatePositions(this.root, width / 2, 50, width / 4);
        }

        // æ¢å¤æ ‘çŠ¶æ€ï¼ˆä¿®æ­£ç‰ˆï¼‰
        restoreTreeState(savedRoot) {
            this.root = savedRoot ? this.cloneTree(savedRoot) : null;
            if (this.root) {
                this.updatePositions();
            }
            this.draw();
        }

        // åœ¨æŒ‡å®šæ ¹ä¸­æœç´¢èŠ‚ç‚¹
        searchNode(node, data) {
            if (!node || node.data === data) {
                return node;
            }

            if (data < node.data) {
                return this.searchNode(node.left, data);
            } else {
                return this.searchNode(node.right, data);
            }
        }

        // æœç´¢æ–¹æ³•ï¼ˆä½¿ç”¨å½“å‰æ ¹ï¼‰
        search(data) {
            return this.searchNode(this.root, data);
        }

        searchWithHighlight(data) {
            const foundNode = this.search(data);
            if (foundNode) {
                this.draw();
                this.highlightNode(foundNode);
                this.updateInfo(`æ‰¾åˆ°èŠ‚ç‚¹ ${data}`);
            } else {
                this.updateInfo(`æœªæ‰¾åˆ°èŠ‚ç‚¹ ${data}`);
            }
        }

        highlightNode(node) {
            this.ctx.strokeStyle = '#ffd700';
            this.ctx.lineWidth = 4;
            this.ctx.beginPath();
            this.ctx.arc(node.x, node.y, this.nodeRadius + 6, 0, 2 * Math.PI);
            this.ctx.stroke();

            setTimeout(() => {
                this.draw();
            }, 1500);
        }

        draw() {
            this.ctx.clearRect(0, 0, this.canvas.clientWidth, this.canvas.clientHeight);

            if (this.root) {
                this.drawTree(this.root);
            }

            this.updateInfo();
        }

        drawTree(node) {
            if (!node) return;

            // ç»˜åˆ¶è¿æ¥çº¿
            if (node.left) {
                this.drawLine(node.x, node.y, node.left.x, node.left.y);
                this.drawTree(node.left);
            }

            if (node.right) {
                this.drawLine(node.x, node.y, node.right.x, node.right.y);
                this.drawTree(node.right);
            }

            // ç»˜åˆ¶èŠ‚ç‚¹
            this.drawNode(node);
        }

        drawLine(x1, y1, x2, y2) {
            this.ctx.strokeStyle = '#666';
            this.ctx.lineWidth = 3;
            this.ctx.beginPath();
            this.ctx.moveTo(x1, y1);
            this.ctx.lineTo(x2, y2);
            this.ctx.stroke();
        }

        drawNode(node) {
            // ç»˜åˆ¶é«˜äº®æ•ˆæœ
            if (node.highlighted) {
                this.ctx.strokeStyle = '#ffd700';
                this.ctx.lineWidth = 6;
                this.ctx.beginPath();
                this.ctx.arc(node.x, node.y, this.nodeRadius + 8, 0, 2 * Math.PI);
                this.ctx.stroke();

                // æ·»åŠ å‘å…‰æ•ˆæœ
                this.ctx.shadowColor = '#ffd700';
                this.ctx.shadowBlur = 15;
            }

            // ç»˜åˆ¶èŠ‚ç‚¹é˜´å½±
            this.ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
            this.ctx.beginPath();
            this.ctx.arc(node.x + 2, node.y + 2, this.nodeRadius, 0, 2 * Math.PI);
            this.ctx.fill();

            // é‡ç½®é˜´å½±
            this.ctx.shadowColor = 'transparent';
            this.ctx.shadowBlur = 0;

            // ç»˜åˆ¶èŠ‚ç‚¹åœ†åœˆ
            this.ctx.fillStyle = node.color === 'RED' ? '#ff4757' : '#2f3542';
            this.ctx.strokeStyle = '#333';
            this.ctx.lineWidth = 3;
            this.ctx.beginPath();
            this.ctx.arc(node.x, node.y, this.nodeRadius, 0, 2 * Math.PI);
            this.ctx.fill();
            this.ctx.stroke();

            // ç»˜åˆ¶èŠ‚ç‚¹å€¼
            this.ctx.fillStyle = 'white';
            this.ctx.font = 'bold 16px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            this.ctx.fillText(node.data.toString(), node.x, node.y);
        }

        // ç®€åŒ–çš„æ’å…¥æ–¹æ³•ï¼ˆç”¨äºåˆå§‹åŒ–ï¼‰
        simpleInsert(data) {
            const newNode = new RBTreeNode(data);

            if (!this.root) {
                this.root = newNode;
                this.root.color = 'BLACK';
            } else {
                this.insertNodeSimple(this.root, newNode);
                this.insertFixupSimple(newNode);
            }

            this.updatePositions();
            this.draw();
        }

        insertNodeSimple(root, newNode) {
            if (newNode.data < root.data) {
                if (!root.left) {
                    root.left = newNode;
                    newNode.parent = root;
                } else {
                    this.insertNodeSimple(root.left, newNode);
                }
            } else if (newNode.data > root.data) {
                if (!root.right) {
                    root.right = newNode;
                    newNode.parent = root;
                } else {
                    this.insertNodeSimple(root.right, newNode);
                }
            }
        }

        insertFixupSimple(z) {
            while (z.parent && z.parent.color === 'RED') {
                if (z.parent === z.parent.parent.left) {
                    const y = z.parent.parent.right;
                    if (y && y.color === 'RED') {
                        z.parent.color = 'BLACK';
                        y.color = 'BLACK';
                        z.parent.parent.color = 'RED';
                        z = z.parent.parent;
                    } else {
                        if (z === z.parent.right) {
                            z = z.parent;
                            this.leftRotate(z);
                        }
                        z.parent.color = 'BLACK';
                        z.parent.parent.color = 'RED';
                        this.rightRotate(z.parent.parent);
                    }
                } else {
                    const y = z.parent.parent.left;
                    if (y && y.color === 'RED') {
                        z.parent.color = 'BLACK';
                        y.color = 'BLACK';
                        z.parent.parent.color = 'RED';
                        z = z.parent.parent;
                    } else {
                        if (z === z.parent.left) {
                            z = z.parent;
                            this.rightRotate(z);
                        }
                        z.parent.color = 'BLACK';
                        z.parent.parent.color = 'RED';
                        this.leftRotate(z.parent.parent);
                    }
                }
            }
            this.root.color = 'BLACK';
        }

        leftRotate(x) {
            const y = x.right;
            x.right = y.left;

            if (y.left) {
                y.left.parent = x;
            }

            y.parent = x.parent;

            if (!x.parent) {
                this.root = y;
            } else if (x === x.parent.left) {
                x.parent.left = y;
            } else {
                x.parent.right = y;
            }

            y.left = x;
            x.parent = y;
        }

        rightRotate(x) {
            const y = x.left;
            x.left = y.right;

            if (y.right) {
                y.right.parent = x;
            }

            y.parent = x.parent;

            if (!x.parent) {
                this.root = y;
            } else if (x === x.parent.right) {
                x.parent.right = y;
            } else {
                x.parent.left = y;
            }

            y.right = x;
            x.parent = y;
        }

        getHeight(node = this.root) {
            if (!node) return 0;
            return 1 + Math.max(this.getHeight(node.left), this.getHeight(node.right));
        }

        getBlackHeight(node = this.root) {
            if (!node) return 0;

            const leftHeight = this.getBlackHeight(node.left);
            const blackAdd = node.color === 'BLACK' ? 1 : 0;

            return leftHeight + blackAdd;
        }

        getNodeCount(node = this.root) {
            if (!node) return 0;
            return 1 + this.getNodeCount(node.left) + this.getNodeCount(node.right);
        }

        getBalanceFactor() {
            if (!this.root) return "å®Œç¾";

            const height = this.getHeight();
            const nodeCount = this.getNodeCount();
            const ratio = height / (2 * Math.log2(nodeCount + 1));

            if (ratio <= 1.2) return "ä¼˜ç§€";
            else if (ratio <= 1.5) return "è‰¯å¥½";
            else if (ratio <= 2.0) return "ä¸€èˆ¬";
            else return "éœ€è¦ä¼˜åŒ–";
        }

        updateInfo(operation) {
            document.getElementById('nodeCount').textContent = this.getNodeCount();
            document.getElementById('treeHeight').textContent = this.getHeight();
            document.getElementById('blackHeight').textContent = this.getBlackHeight();
            document.getElementById('balanceFactor').textContent = this.getBalanceFactor();
        }

        clear() {
            this.root = null;
            this.hideDemoControls();
            this.draw();
        }

        generateRandom() {
            this.clear();
            const values = new Set();
            while (values.size < 9) {
                values.add(Math.floor(Math.random() * 90) + 10);
            }

            Array.from(values).forEach(value => {
                this.simpleInsert(value);
            });
        }
    }

    // å…¨å±€å˜é‡
    let rbTree;

    // ä»£ç åˆ‡æ¢åŠŸèƒ½
    function showCode(language) {
        // æ›´æ–°æ ‡ç­¾é¡µ
        document.querySelectorAll('.code-tab').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelector(`.code-tab:nth-child(${language === 'cpp' ? 1 : language === 'java' ? 2 : 3})`).classList.add('active');

        // æ›´æ–°å†…å®¹
        document.querySelectorAll('.code-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${language}-code`).classList.add('active');
    }

    // å¤åˆ¶ä»£ç åŠŸèƒ½
    function copyCode(language) {
        const codeElement = document.getElementById(`${language}-source`);
        const codeText = codeElement.textContent;

        navigator.clipboard.writeText(codeText).then(() => {
            const btn = document.querySelector(`#${language}-code .copy-btn`);
            const originalText = btn.textContent;
            btn.textContent = 'å·²å¤åˆ¶!';
            btn.classList.add('copied');

            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            console.error('å¤åˆ¶å¤±è´¥:', err);
            alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        });
    }

    // æ¼”ç¤ºæ§åˆ¶å‡½æ•°
    function startInsertDemo() {
        const value = parseInt(document.getElementById('insertValue').value);
        rbTree.startInsertDemo(value);
    }

    function startDeleteDemo() {
        const value = parseInt(document.getElementById('deleteValue').value);
        rbTree.startDeleteDemo(value);
    }

    function nextStep() {
        rbTree.nextStep();
    }

    function previousStep() {
        rbTree.previousStep();
    }

    function playSteps() {
        rbTree.playSteps();
    }

    function pauseSteps() {
        rbTree.pauseSteps();
    }

    function resetDemo() {
        rbTree.resetDemo();
    }

    function changeSpeed() {
        rbTree.changeSpeed();
    }

    function searchNode() {
        const value = parseInt(document.getElementById('searchValue').value);
        if (value && value >= 1 && value <= 99) {
            rbTree.searchWithHighlight(value);
        } else {
            alert('è¯·è¾“å…¥1-99ä¹‹é—´çš„æ•°å­—ï¼');
        }
    }

    function clearTree() {
        rbTree.clear();
    }

    function generateRandomTree() {
        rbTree.generateRandom();
    }

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        console.log('çº¢é»‘æ ‘é¡µé¢åŠ è½½å®Œæˆ');

        rbTree = new RedBlackTreeDemo();

        // é¡µé¢åŠ è½½åŠ¨ç”»
        const card = document.querySelector('.main-card');
        if (card) {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';

            setTimeout(() => {
                card.style.transition = 'all 0.8s ease';
                card.style.opacity = '1';
                card.style.transform = 'translateY(0)';
            }, 100);
        }

        // ç”Ÿæˆç¤ºä¾‹æ ‘
        [50, 30, 70, 20, 40, 60, 80, 15, 25].forEach(value => {
            rbTree.simpleInsert(value);
        });

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', function() {
            rbTree.setupCanvas();
            rbTree.updatePositions();
            rbTree.draw();
        });

        // é”®ç›˜äº‹ä»¶æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const focusedElement = document.activeElement;
                if (focusedElement.id === 'insertValue') {
                    startInsertDemo();
                } else if (focusedElement.id === 'deleteValue') {
                    startDeleteDemo();
                } else if (focusedElement.id === 'searchValue') {
                    searchNode();
                }
            }

            // æ¼”ç¤ºæ§åˆ¶å¿«æ·é”®
            if (rbTree.steps.length > 0) {
                if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    previousStep();
                } else if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    nextStep();
                } else if (e.key === ' ') {
                    e.preventDefault();
                    if (rbTree.isPlaying) {
                        pauseSteps();
                    } else {
                        playSteps();
                    }
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    resetDemo();
                }
            }
        });
    });
</script>
{% endblock %}