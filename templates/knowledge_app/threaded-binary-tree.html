{% extends 'knowledge_app/base.html' %}

{% block title %}çº¿ç´¢äºŒå‰æ ‘ - è®¡ç®—æœºç§‘å­¦å­¦ä¹ å¹³å°{% endblock %}

{% block content %}
<div class="page-container fade-in">
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <div class="breadcrumb">
        <a href="{% url 'knowledge_app:index' %}">é¦–é¡µ</a>
        <span>></span>
        <span>æ•°æ®ç»“æ„</span>
        <span>></span>
        <span>çº¿ç´¢äºŒå‰æ ‘</span>
    </div>

    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header slide-in-left">
        <h1>
            <span class="page-icon">ğŸ”—</span>
            çº¿ç´¢äºŒå‰æ ‘
        </h1>
        <p>åˆ©ç”¨çº¿ç´¢åŒ–æŠ€æœ¯ä¼˜åŒ–äºŒå‰æ ‘éå†ï¼Œå®ç°æ— é€’å½’é«˜æ•ˆè®¿é—®</p>
    </div>

    <!-- ğŸ“‹ çŸ¥è¯†ç‚¹æ¦‚è¿° -->
    <div class="content-card slide-in-right">
        <div class="content-section">
            <h2 class="section-title">
                <span class="section-icon">ğŸ“‹</span>
                çŸ¥è¯†ç‚¹æ¦‚è¿°
            </h2>

            <div class="overview-content">
                <div class="concept-intro">
                    <h3>æ ¸å¿ƒæ¦‚å¿µ</h3>
                    <p>çº¿ç´¢äºŒå‰æ ‘å°±åƒåœ¨è¿·å®«ä¸­æ‹‰ä¸€æ ¹å¯¼çº¿ï¼Œè®©ä½ èƒ½å¤Ÿä¸è¿·è·¯åœ°éå†æ•´ä¸ªè¿·å®«ã€‚å®ƒåˆ©ç”¨äºŒå‰æ ‘ä¸­çš„ç©ºæŒ‡é’ˆåŸŸæ¥å­˜å‚¨çº¿ç´¢ä¿¡æ¯ï¼Œå°†éçº¿æ€§ç»“æ„çº¿æ€§åŒ–ï¼Œå®ç°é«˜æ•ˆçš„éé€’å½’éå†ã€‚</p>
                </div>

                <div class="unified-grid unified-grid-2">
                    <div class="info-box info-box-info">
                        <span class="info-icon">ğŸ“š</span>
                        <div>
                            <strong>å­¦ä¹ éš¾åº¦ï¼š</strong>ä¸­ç­‰
                            <br><strong>å‰ç½®çŸ¥è¯†ï¼š</strong>äºŒå‰æ ‘éå†ã€æŒ‡é’ˆæ“ä½œ
                        </div>
                    </div>
                    <div class="info-box info-box-success">
                        <span class="info-icon">â±ï¸</span>
                        <div>
                            <strong>å­¦ä¹ æ—¶é—´ï¼š</strong>45-60åˆ†é’Ÿ
                            <br><strong>é‡è¦ç¨‹åº¦ï¼š</strong>â­â­â­â­
                        </div>
                    </div>
                </div>

                <div class="terms-list">
                    <h4>ğŸ”‘ å…³é”®æœ¯è¯­</h4>
                    <div class="unified-grid unified-grid-2">
                        <div class="term-item">
                            <strong>çº¿ç´¢ï¼š</strong>åˆ©ç”¨ç©ºæŒ‡é’ˆåŸŸå­˜å‚¨çš„å‰é©±æˆ–åç»§ä¿¡æ¯
                        </div>
                        <div class="term-item">
                            <strong>çº¿ç´¢åŒ–ï¼š</strong>å°†æ™®é€šäºŒå‰æ ‘è½¬æ¢ä¸ºçº¿ç´¢äºŒå‰æ ‘çš„è¿‡ç¨‹
                        </div>
                        <div class="term-item">
                            <strong>å‰é©±çº¿ç´¢ï¼š</strong>æŒ‡å‘ä¸­åºéå†ä¸­å‰é©±èŠ‚ç‚¹çš„çº¿ç´¢
                        </div>
                        <div class="term-item">
                            <strong>åç»§çº¿ç´¢ï¼š</strong>æŒ‡å‘ä¸­åºéå†ä¸­åç»§èŠ‚ç‚¹çš„çº¿ç´¢
                        </div>
                    </div>
                </div>

                <div class="problem-solution">
                    <h4>ğŸ’¡ è§£å†³çš„é—®é¢˜</h4>
                    <div class="unified-grid unified-grid-2">
                        <div class="problem-box">
                            <h5>ğŸ”´ ä¼ ç»Ÿé—®é¢˜</h5>
                            <ul>
                                <li>é€’å½’éå†éœ€è¦å¤§é‡æ ˆç©ºé—´</li>
                                <li>å¤§é‡ç©ºæŒ‡é’ˆåŸŸæµªè´¹å­˜å‚¨ç©ºé—´</li>
                                <li>éš¾ä»¥æ‰¾åˆ°èŠ‚ç‚¹çš„å‰é©±å’Œåç»§</li>
                                <li>éé€’å½’éå†å®ç°å¤æ‚</li>
                            </ul>
                        </div>
                        <div class="solution-box">
                            <h5>ğŸŸ¢ çº¿ç´¢åŒ–ä¼˜åŠ¿</h5>
                            <ul>
                                <li>åˆ©ç”¨ç©ºæŒ‡é’ˆåŸŸå­˜å‚¨æœ‰ç”¨ä¿¡æ¯</li>
                                <li>å®ç°O(1)æ—¶é—´æ‰¾åˆ°å‰é©±åç»§</li>
                                <li>æ”¯æŒé«˜æ•ˆçš„éé€’å½’éå†</li>
                                <li>èŠ‚çœæ ˆç©ºé—´ï¼Œé€‚åˆå¤§å‹æ ‘</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ“– æ¦‚å¿µè¯¦è§£ -->
    <div class="content-card">
        <div class="content-section">
            <h2 class="section-title">
                <span class="section-icon">ğŸ“–</span>
                æ¦‚å¿µè¯¦è§£
            </h2>

            <div class="concept-details">
                <div class="concept-item">
                    <h3>ğŸ¯ ä»€ä¹ˆæ˜¯çº¿ç´¢äºŒå‰æ ‘</h3>
                    <p>çº¿ç´¢äºŒå‰æ ‘æ˜¯ä¸€ç§æ”¹è¿›çš„äºŒå‰æ ‘å­˜å‚¨ç»“æ„ï¼Œå®ƒåˆ©ç”¨äºŒå‰æ ‘ä¸­å¤§é‡çš„ç©ºæŒ‡é’ˆåŸŸæ¥å­˜å‚¨èŠ‚ç‚¹çš„å‰é©±å’Œåç»§ä¿¡æ¯ã€‚</p>
                    <div class="example-box">
                        <strong>ç©ºé—´åˆ©ç”¨ç‡ï¼š</strong>åœ¨nä¸ªèŠ‚ç‚¹çš„äºŒå‰æ ‘ä¸­ï¼Œæœ‰n+1ä¸ªç©ºæŒ‡é’ˆåŸŸï¼Œçº¿ç´¢åŒ–å¯ä»¥å°†è¿™äº›"åºŸç‰©"å˜æˆ"å®è´"ã€‚
                    </div>
                    <div class="stats-box">
                        <h5>ğŸ“Š ç©ºé—´ç»Ÿè®¡</h5>
                        <p><strong>èŠ‚ç‚¹æ•°ï¼š</strong>nä¸ªèŠ‚ç‚¹</p>
                        <p><strong>æŒ‡é’ˆæ€»æ•°ï¼š</strong>2nä¸ªæŒ‡é’ˆåŸŸ</p>
                        <p><strong>éç©ºæŒ‡é’ˆï¼š</strong>n-1ä¸ªï¼ˆè¿æ¥çˆ¶å­èŠ‚ç‚¹ï¼‰</p>
                        <p><strong>ç©ºæŒ‡é’ˆï¼š</strong>n+1ä¸ªï¼ˆå¯ç”¨äºçº¿ç´¢åŒ–ï¼‰</p>
                    </div>
                </div>

                <div class="concept-item">
                    <h3>ğŸ¯ çº¿ç´¢ç±»å‹</h3>
                    <div class="thread-types">
                        <div class="type-box">
                            <h4>å·¦çº¿ç´¢æ ‘</h4>
                            <p>åªåœ¨å·¦æŒ‡é’ˆåŸŸä¸ºç©ºæ—¶æ·»åŠ å‰é©±çº¿ç´¢</p>
                            <div class="type-feature">ç‰¹ç‚¹ï¼šå¿«é€Ÿæ‰¾åˆ°å‰é©±èŠ‚ç‚¹</div>
                        </div>
                        <div class="type-box">
                            <h4>å³çº¿ç´¢æ ‘</h4>
                            <p>åªåœ¨å³æŒ‡é’ˆåŸŸä¸ºç©ºæ—¶æ·»åŠ åç»§çº¿ç´¢</p>
                            <div class="type-feature">ç‰¹ç‚¹ï¼šå¿«é€Ÿæ‰¾åˆ°åç»§èŠ‚ç‚¹</div>
                        </div>
                        <div class="type-box">
                            <h4>å…¨çº¿ç´¢æ ‘</h4>
                            <p>åŒæ—¶æ·»åŠ å‰é©±å’Œåç»§çº¿ç´¢</p>
                            <div class="type-feature">ç‰¹ç‚¹ï¼šåŒå‘å¿«é€Ÿè®¿é—®</div>
                        </div>
                    </div>
                </div>

                <div class="concept-item">
                    <h3>ğŸ¯ çº¿ç´¢åŒ–è¿‡ç¨‹</h3>
                    <p>çº¿ç´¢åŒ–æ˜¯é€šè¿‡ä¸­åºéå†äºŒå‰æ ‘ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­å»ºç«‹çº¿ç´¢çš„è¿‡ç¨‹ã€‚</p>
                    <div class="process-steps">
                        <div class="step-box">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h5>ä¸­åºéå†</h5>
                                <p>æŒ‰ç…§å·¦â†’æ ¹â†’å³çš„é¡ºåºè®¿é—®èŠ‚ç‚¹</p>
                            </div>
                        </div>
                        <div class="step-box">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h5>å»ºç«‹å‰é©±çº¿ç´¢</h5>
                                <p>å¦‚æœå½“å‰èŠ‚ç‚¹å·¦æŒ‡é’ˆä¸ºç©ºï¼ŒæŒ‡å‘å‰é©±èŠ‚ç‚¹</p>
                            </div>
                        </div>
                        <div class="step-box">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h5>å»ºç«‹åç»§çº¿ç´¢</h5>
                                <p>å¦‚æœå‰ä¸€ä¸ªèŠ‚ç‚¹å³æŒ‡é’ˆä¸ºç©ºï¼ŒæŒ‡å‘å½“å‰èŠ‚ç‚¹</p>
                            </div>
                        </div>
                        <div class="step-box">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h5>æ ‡è®°çº¿ç´¢</h5>
                                <p>ç”¨æ ‡å¿—ä½åŒºåˆ†æŒ‡é’ˆæ˜¯çº¿ç´¢è¿˜æ˜¯å­æ ‘æŒ‡é’ˆ</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="concept-item">
                    <h3>ğŸ¯ çº¿ç´¢éå†</h3>
                    <p>åˆ©ç”¨çº¿ç´¢å¯ä»¥å®ç°ä¸éœ€è¦é€’å½’æ ˆçš„é«˜æ•ˆéå†ã€‚</p>
                    <div class="traversal-algorithm">
                        <h5>ä¸­åºçº¿ç´¢éå†ç®—æ³•ï¼š</h5>
                        <div class="algorithm-steps">
                            <div class="algo-step">
                                <span class="step-label">æ­¥éª¤1ï¼š</span>
                                <span>æ‰¾åˆ°ä¸­åºéå†çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆæœ€å·¦ä¸‹èŠ‚ç‚¹ï¼‰</span>
                            </div>
                            <div class="algo-step">
                                <span class="step-label">æ­¥éª¤2ï¼š</span>
                                <span>è®¿é—®å½“å‰èŠ‚ç‚¹</span>
                            </div>
                            <div class="algo-step">
                                <span class="step-label">æ­¥éª¤3ï¼š</span>
                                <span>å¦‚æœå³æŒ‡é’ˆæ˜¯çº¿ç´¢ï¼Œç›´æ¥è·³åˆ°åç»§èŠ‚ç‚¹</span>
                            </div>
                            <div class="algo-step">
                                <span class="step-label">æ­¥éª¤4ï¼š</span>
                                <span>å¦‚æœå³æŒ‡é’ˆæ˜¯å­æ ‘æŒ‡é’ˆï¼Œè½¬å‘å³å­æ ‘çš„æœ€å·¦èŠ‚ç‚¹</span>
                            </div>
                            <div class="algo-step">
                                <span class="step-label">æ­¥éª¤5ï¼š</span>
                                <span>é‡å¤æ­¥éª¤2-4ç›´åˆ°éå†å®Œæˆ</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-box info-box-warning">
                    <span class="info-icon">âš ï¸</span>
                    <strong>é‡è¦æç¤ºï¼š</strong>
                    <ul>
                        <li>çº¿ç´¢åŒ–é€šå¸¸åŸºäºä¸­åºéå†ï¼Œå› ä¸ºä¸­åºéå†å¯¹BSTæœ‰ç‰¹æ®Šæ„ä¹‰</li>
                        <li>éœ€è¦æ ‡å¿—ä½åŒºåˆ†æ™®é€šæŒ‡é’ˆå’Œçº¿ç´¢æŒ‡é’ˆ</li>
                        <li>çº¿ç´¢åŒ–åçš„æ ‘ç»“æ„ä¸èƒ½éšæ„ä¿®æ”¹ï¼Œå¦åˆ™çº¿ç´¢ä¼šå¤±æ•ˆ</li>
                        <li>é€‚åˆæŸ¥è¯¢é¢‘ç¹ä½†ä¿®æ”¹è¾ƒå°‘çš„åº”ç”¨åœºæ™¯</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ“Š å¯è§†åŒ–å±•ç¤º -->
    <div class="content-card">
        <div class="content-section">
            <h2 class="section-title">
                <span class="section-icon">ğŸ“Š</span>
                äº¤äº’å¼å¯è§†åŒ–æ¼”ç¤º
            </h2>

            <div class="visualization-container">
                <div class="demo-description">
                    <p>è§‚çœ‹çº¿ç´¢åŒ–è¿‡ç¨‹å’Œçº¿ç´¢éå†çš„åŠ¨ç”»æ¼”ç¤ºã€‚<span style="color: #3b82f6; font-weight: bold; opacity: 0.8;">æ¸å˜è“è‰²æ›²çº¿</span>è¡¨ç¤ºå‰é©±çº¿ç´¢ï¼ˆå‘ä¸Šå¼¯æ›²ï¼‰ï¼Œ<span style="color: #dc2626; font-weight: bold; opacity: 0.8;">æ¸å˜çº¢è‰²æ›²çº¿</span>è¡¨ç¤ºåç»§çº¿ç´¢ï¼ˆå‘ä¸‹å¼¯æ›²ï¼‰ï¼Œå®çº¿è¡¨ç¤ºæ­£å¸¸çš„çˆ¶å­å…³ç³»ã€‚</p>
                    <div style="margin-top: 10px; font-size: 14px; color: #666;">
                        âœ¨ <strong>ä¼˜åŒ–å‡çº§è®¾è®¡ï¼š</strong>çº¿ç´¢æ›²çº¿é‡‡ç”¨æ¸å˜é€æ˜æ•ˆæœï¼Œç½®äºæœ€é¡¶å±‚æ˜¾ç¤ºï¼Œæ—¢çªå‡ºçº¿ç´¢è¿æ¥å…³ç³»ï¼Œåˆä¸é®æŒ¡åº•å±‚ç»“æ„ï¼Œè§†è§‰å±‚æ¬¡æ›´æ¸…æ™°ï¼
                    </div>
                </div>

                <div class="canvas-demo">
                    <div class="controls">
                        <button class="threading-btn" onclick="startThreading()">ğŸ”— å¼€å§‹çº¿ç´¢åŒ–</button>
                        <button class="traverse-btn" onclick="startThreadTraversal()">ğŸš¶ çº¿ç´¢éå†</button>
                        <button class="toggle-threads-btn" onclick="toggleThreadsVisibility()">ğŸ‘ï¸ æ˜¾ç¤º/éšè—çº¿ç´¢</button>
                        <button class="reset-btn" onclick="resetThreadDemo()">ğŸ”„ é‡ç½®</button>
                    </div>

                    <div class="canvas-container">
                        <canvas id="threadCanvas" width="800" height="450"></canvas>
                    </div>

                    <div class="legend">
                        <h4>å›¾ä¾‹è¯´æ˜</h4>
                        <div class="legend-items">
                            <div class="legend-item">
                                <div class="legend-node-demo">
                                    <div class="legend-pointer-field">L</div>
                                    <div class="legend-data-field">A</div>
                                    <div class="legend-pointer-field">R</div>
                                </div>
                                <span>æ™®é€šèŠ‚ç‚¹ç»“æ„</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-node-demo threaded">
                                    <div class="legend-pointer-field">T</div>
                                    <div class="legend-data-field">B</div>
                                    <div class="legend-pointer-field">T</div>
                                </div>
                                <span>çº¿ç´¢åŒ–èŠ‚ç‚¹</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line normal-line"></div>
                                <span>æ­£å¸¸æŒ‡é’ˆ(å®çº¿)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line predecessor-thread-line"></div>
                                <span>å‰é©±çº¿ç´¢(æ¸å˜è“)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-line successor-thread-line"></div>
                                <span>åç»§çº¿ç´¢(æ¸å˜çº¢)</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #ff4444;"></div>
                                <span>æ­£åœ¨å¤„ç†</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: #22c55e;"></div>
                                <span>çº¿ç´¢åŒ–å®Œæˆ</span>
                            </div>
                        </div>
                        <div class="legend-explanation">
                            <p><strong>æŒ‡é’ˆåŸŸè¯´æ˜ï¼š</strong></p>
                            <ul>
                                <li><strong>L/Rï¼š</strong>æŒ‡å‘å·¦/å³å­æ ‘çš„æ­£å¸¸æŒ‡é’ˆ</li>
                                <li><strong>Tï¼š</strong>çº¿ç´¢æŒ‡é’ˆï¼ˆè“è‰²=å‰é©±ï¼Œçº¢è‰²=åç»§ï¼‰</li>
                                <li><strong>âˆ…ï¼š</strong>ç©ºæŒ‡é’ˆ</li>
                                <li><strong>â†™/â†˜/â†’ï¼š</strong>æŒ‡é’ˆæ–¹å‘æŒ‡ç¤º</li>
                            </ul>
                            <div style="margin-top: 12px; padding: 10px; background: #f0f9ff; border-left: 3px solid #3b82f6; border-radius: 4px;">
                                <strong>ğŸ’» ä¼˜åŒ–å‡çº§æ›²çº¿è®¾è®¡ï¼š</strong>
                                <ul style="margin: 8px 0 0 15px; font-size: 12px;">
                                    <li>ğŸ”µ <strong>å‰é©±çº¿ç´¢</strong>ï¼šæ¸å˜è“è‰²æ›²çº¿ï¼Œå‘ä¸Šä¼˜é›…å¼¯æ›²ï¼Œé¡¶å±‚æ˜¾ç¤º</li>
                                    <li>ğŸ”´ <strong>åç»§çº¿ç´¢</strong>ï¼šæ¸å˜çº¢è‰²æ›²çº¿ï¼Œå‘ä¸‹è‡ªç„¶å¼¯æ›²ï¼Œé¡¶å±‚æ˜¾ç¤º</li>
                                    <li>ğŸ’« <strong>æ¸å˜æ•ˆæœ</strong>ï¼š50%-80%é€æ˜åº¦ï¼Œæ—¢çªå‡ºåˆä¸é®æŒ¡åº•å±‚å…ƒç´ </li>
                                    <li>ğŸ¯ <strong>æŸ”å’Œç®­å¤´</strong>ï¼šæ¸å˜å¡«å……ï¼Œåœ†æ¶¦è¾¹ç¼˜ï¼Œæ— é”åˆ©å°–è§’</li>
                                    <li>ğŸ·ï¸ <strong>æµ®å±‚æ ‡ç­¾</strong>ï¼šåŠé€æ˜èƒŒæ™¯ï¼Œç™½è‰²æ–‡å­—ï¼Œè½»å¾®é˜´å½±æ•ˆæœ</li>
                                    <li>ğŸ“ <strong>ä¸‰å±‚æ¸²æŸ“</strong>ï¼šè¿æ¥çº¿â†’èŠ‚ç‚¹â†’çº¿ç´¢ï¼Œå±‚æ¬¡åˆ†æ˜ï¼Œçº¿ç´¢æ°¸è¿œåœ¨é¡¶å±‚</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="info">
                        <div class="info-box">
                            <h4>éå†åºåˆ—</h4>
                            <div class="sequence" id="threadSequence"></div>
                            <div class="status" id="threadStatus">ç‚¹å‡»æŒ‰é’®å¼€å§‹æ¼”ç¤º</div>
                        </div>
                        <div class="info-box">
                            <h4>å½“å‰æ“ä½œ</h4>
                            <div class="sequence" id="threadCurrentAction">ç­‰å¾…å¼€å§‹...</div>
                            <div class="status" id="threadStepInfo">é€‰æ‹©æ“ä½œç±»å‹</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸ’» ä»£ç å®ç° -->
    <div class="content-card">
        <div class="content-section">
            <h2 class="section-title">
                <span class="section-icon">ğŸ’»</span>
                ä»£ç å®ç°
            </h2>

            <div class="code-implementation">
                <div class="code-tabs">
                    <button class="tab-btn active" onclick="showCode('cpp')">C++</button>
                    <button class="tab-btn" onclick="showCode('java')">Java</button>
                    <button class="tab-btn" onclick="showCode('python')">Python</button>
                </div>

                <div id="cpp-code" class="code-content active">
                    <div class="code-header">
                        <span>C++ å®ç°</span>
                        <button onclick="copyCode('cpp', this)" class="copy-btn">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code id="cpp-source">#include &lt;iostream&gt;
using namespace std;

// çº¿ç´¢äºŒå‰æ ‘èŠ‚ç‚¹ç»“æ„
struct ThreadNode {
    int data;
    ThreadNode* left;
    ThreadNode* right;
    bool leftTag;   // falseè¡¨ç¤ºå·¦æŒ‡é’ˆæŒ‡å‘å­èŠ‚ç‚¹ï¼Œtrueè¡¨ç¤ºå‰é©±çº¿ç´¢
    bool rightTag;  // falseè¡¨ç¤ºå³æŒ‡é’ˆæŒ‡å‘å­èŠ‚ç‚¹ï¼Œtrueè¡¨ç¤ºåç»§çº¿ç´¢

    ThreadNode(int val) : data(val), left(nullptr), right(nullptr),
                         leftTag(false), rightTag(false) {}
};

class ThreadedBinaryTree {
private:
    ThreadNode* root;
    ThreadNode* pre;  // ä¸­åºéå†ä¸­çš„å‰é©±èŠ‚ç‚¹

public:
    ThreadedBinaryTree() : root(nullptr), pre(nullptr) {}

    // ä¸­åºçº¿ç´¢åŒ–
    void inorderThreading(ThreadNode* node) {
        if (node) {
            // é€’å½’çº¿ç´¢åŒ–å·¦å­æ ‘
            inorderThreading(node->left);

            // å¤„ç†å½“å‰èŠ‚ç‚¹çš„çº¿ç´¢
            if (!node->left) {  // å·¦æŒ‡é’ˆä¸ºç©ºï¼Œå»ºç«‹å‰é©±çº¿ç´¢
                node->leftTag = true;
                node->left = pre;
            }

            if (pre && !pre->right) {  // å‰é©±èŠ‚ç‚¹å³æŒ‡é’ˆä¸ºç©ºï¼Œå»ºç«‹åç»§çº¿ç´¢
                pre->rightTag = true;
                pre->right = node;
            }

            pre = node;  // æ›´æ–°å‰é©±èŠ‚ç‚¹

            // é€’å½’çº¿ç´¢åŒ–å³å­æ ‘
            inorderThreading(node->right);
        }
    }

    // çº¿ç´¢åŒ–åŒ…è£…å‡½æ•°
    void createInorderThread() {
        if (root) {
            pre = nullptr;
            inorderThreading(root);
        }
    }

    // æ‰¾åˆ°ä¸­åºéå†çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
    ThreadNode* firstNode() {
        ThreadNode* p = root;
        if (!p) return nullptr;

        while (!p->leftTag) {  // ä¸€ç›´å‘å·¦æ‰¾åˆ°æœ€å·¦ä¸‹èŠ‚ç‚¹
            p = p->left;
        }
        return p;
    }

    // åœ¨ä¸­åºçº¿ç´¢æ ‘ä¸­æ‰¾åˆ°èŠ‚ç‚¹pçš„åç»§
    ThreadNode* nextNode(ThreadNode* p) {
        if (p->rightTag) {
            // å³æŒ‡é’ˆæ˜¯çº¿ç´¢ï¼Œç›´æ¥è¿”å›åç»§
            return p->right;
        } else {
            // å³æŒ‡é’ˆæŒ‡å‘å­æ ‘ï¼Œæ‰¾åˆ°å³å­æ ‘çš„æœ€å·¦èŠ‚ç‚¹
            p = p->right;
            while (!p->leftTag) {
                p = p->left;
            }
            return p;
        }
    }

    // ä¸­åºçº¿ç´¢éå†
    void inorderTraversal() {
        ThreadNode* p = firstNode();
        while (p) {
            cout << p->data << " ";
            p = nextNode(p);
        }
        cout << endl;
    }

    // æ’å…¥èŠ‚ç‚¹ï¼ˆå»ºæ ‘ç”¨ï¼‰
    void insert(int val) {
        if (!root) {
            root = new ThreadNode(val);
            return;
        }

        ThreadNode* curr = root;
        ThreadNode* parent = nullptr;

        while (curr) {
            parent = curr;
            if (val < curr->data) {
                if (curr->leftTag) break;  // é‡åˆ°çº¿ç´¢å°±åœæ­¢
                curr = curr->left;
            } else {
                if (curr->rightTag) break;  // é‡åˆ°çº¿ç´¢å°±åœæ­¢
                curr = curr->right;
            }
        }

        ThreadNode* newNode = new ThreadNode(val);
        if (val < parent->data) {
            parent->left = newNode;
        } else {
            parent->right = newNode;
        }
    }
};</code></pre>
                </div>

                <div id="java-code" class="code-content">
                    <div class="code-header">
                        <span>Java å®ç°</span>
                        <button onclick="copyCode('java', this)" class="copy-btn">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code id="java-source">// çº¿ç´¢äºŒå‰æ ‘èŠ‚ç‚¹ç±»
class ThreadNode {
    int data;
    ThreadNode left;
    ThreadNode right;
    boolean leftTag;   // falseè¡¨ç¤ºå·¦æŒ‡é’ˆæŒ‡å‘å­èŠ‚ç‚¹ï¼Œtrueè¡¨ç¤ºå‰é©±çº¿ç´¢
    boolean rightTag;  // falseè¡¨ç¤ºå³æŒ‡é’ˆæŒ‡å‘å­èŠ‚ç‚¹ï¼Œtrueè¡¨ç¤ºåç»§çº¿ç´¢

    public ThreadNode(int data) {
        this.data = data;
        this.left = null;
        this.right = null;
        this.leftTag = false;
        this.rightTag = false;
    }
}

public class ThreadedBinaryTree {
    private ThreadNode root;
    private ThreadNode pre;  // ä¸­åºéå†ä¸­çš„å‰é©±èŠ‚ç‚¹

    public ThreadedBinaryTree() {
        this.root = null;
        this.pre = null;
    }

    // ä¸­åºçº¿ç´¢åŒ–
    private void inorderThreading(ThreadNode node) {
        if (node != null) {
            // é€’å½’çº¿ç´¢åŒ–å·¦å­æ ‘
            inorderThreading(node.left);

            // å¤„ç†å½“å‰èŠ‚ç‚¹çš„çº¿ç´¢
            if (node.left == null) {  // å·¦æŒ‡é’ˆä¸ºç©ºï¼Œå»ºç«‹å‰é©±çº¿ç´¢
                node.leftTag = true;
                node.left = pre;
            }

            if (pre != null && pre.right == null) {  // å‰é©±èŠ‚ç‚¹å³æŒ‡é’ˆä¸ºç©ºï¼Œå»ºç«‹åç»§çº¿ç´¢
                pre.rightTag = true;
                pre.right = node;
            }

            pre = node;  // æ›´æ–°å‰é©±èŠ‚ç‚¹

            // é€’å½’çº¿ç´¢åŒ–å³å­æ ‘
            inorderThreading(node.right);
        }
    }

    // çº¿ç´¢åŒ–åŒ…è£…å‡½æ•°
    public void createInorderThread() {
        if (root != null) {
            pre = null;
            inorderThreading(root);
        }
    }

    // æ‰¾åˆ°ä¸­åºéå†çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
    private ThreadNode firstNode() {
        ThreadNode p = root;
        if (p == null) return null;

        while (!p.leftTag) {  // ä¸€ç›´å‘å·¦æ‰¾åˆ°æœ€å·¦ä¸‹èŠ‚ç‚¹
            p = p.left;
        }
        return p;
    }

    // åœ¨ä¸­åºçº¿ç´¢æ ‘ä¸­æ‰¾åˆ°èŠ‚ç‚¹pçš„åç»§
    private ThreadNode nextNode(ThreadNode p) {
        if (p.rightTag) {
            // å³æŒ‡é’ˆæ˜¯çº¿ç´¢ï¼Œç›´æ¥è¿”å›åç»§
            return p.right;
        } else {
            // å³æŒ‡é’ˆæŒ‡å‘å­æ ‘ï¼Œæ‰¾åˆ°å³å­æ ‘çš„æœ€å·¦èŠ‚ç‚¹
            p = p.right;
            while (!p.leftTag) {
                p = p.left;
            }
            return p;
        }
    }

    // ä¸­åºçº¿ç´¢éå†
    public void inorderTraversal() {
        ThreadNode p = firstNode();
        while (p != null) {
            System.out.print(p.data + " ");
            p = nextNode(p);
        }
        System.out.println();
    }

    // æ’å…¥èŠ‚ç‚¹ï¼ˆå»ºæ ‘ç”¨ï¼‰
    public void insert(int val) {
        if (root == null) {
            root = new ThreadNode(val);
            return;
        }

        ThreadNode curr = root;
        ThreadNode parent = null;

        while (curr != null) {
            parent = curr;
            if (val < curr.data) {
                if (curr.leftTag) break;  // é‡åˆ°çº¿ç´¢å°±åœæ­¢
                curr = curr.left;
            } else {
                if (curr.rightTag) break;  // é‡åˆ°çº¿ç´¢å°±åœæ­¢
                curr = curr.right;
            }
        }

        ThreadNode newNode = new ThreadNode(val);
        if (val < parent.data) {
            parent.left = newNode;
        } else {
            parent.right = newNode;
        }
    }
}</code></pre>
                </div>

                <div id="python-code" class="code-content">
                    <div class="code-header">
                        <span>Python å®ç°</span>
                        <button onclick="copyCode('python', this)" class="copy-btn">ğŸ“‹ å¤åˆ¶ä»£ç </button>
                    </div>
                    <pre><code id="python-source">class ThreadNode:
    """çº¿ç´¢äºŒå‰æ ‘èŠ‚ç‚¹ç±»"""
    def __init__(self, data):
        self.data = data
        self.left = None
        self.right = None
        self.left_tag = False   # Falseè¡¨ç¤ºå·¦æŒ‡é’ˆæŒ‡å‘å­èŠ‚ç‚¹ï¼ŒTrueè¡¨ç¤ºå‰é©±çº¿ç´¢
        self.right_tag = False  # Falseè¡¨ç¤ºå³æŒ‡é’ˆæŒ‡å‘å­èŠ‚ç‚¹ï¼ŒTrueè¡¨ç¤ºåç»§çº¿ç´¢

class ThreadedBinaryTree:
    """çº¿ç´¢äºŒå‰æ ‘ç±»"""
    def __init__(self):
        self.root = None
        self.pre = None  # ä¸­åºéå†ä¸­çš„å‰é©±èŠ‚ç‚¹

    def inorder_threading(self, node):
        """ä¸­åºçº¿ç´¢åŒ–"""
        if node:
            # é€’å½’çº¿ç´¢åŒ–å·¦å­æ ‘
            self.inorder_threading(node.left)

            # å¤„ç†å½“å‰èŠ‚ç‚¹çš„çº¿ç´¢
            if not node.left:  # å·¦æŒ‡é’ˆä¸ºç©ºï¼Œå»ºç«‹å‰é©±çº¿ç´¢
                node.left_tag = True
                node.left = self.pre

            if self.pre and not self.pre.right:  # å‰é©±èŠ‚ç‚¹å³æŒ‡é’ˆä¸ºç©ºï¼Œå»ºç«‹åç»§çº¿ç´¢
                self.pre.right_tag = True
                self.pre.right = node

            self.pre = node  # æ›´æ–°å‰é©±èŠ‚ç‚¹

            # é€’å½’çº¿ç´¢åŒ–å³å­æ ‘
            self.inorder_threading(node.right)

    def create_inorder_thread(self):
        """çº¿ç´¢åŒ–åŒ…è£…å‡½æ•°"""
        if self.root:
            self.pre = None
            self.inorder_threading(self.root)

    def first_node(self):
        """æ‰¾åˆ°ä¸­åºéå†çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹"""
        p = self.root
        if not p:
            return None

        while not p.left_tag:  # ä¸€ç›´å‘å·¦æ‰¾åˆ°æœ€å·¦ä¸‹èŠ‚ç‚¹
            p = p.left
        return p

    def next_node(self, p):
        """åœ¨ä¸­åºçº¿ç´¢æ ‘ä¸­æ‰¾åˆ°èŠ‚ç‚¹pçš„åç»§"""
        if p.right_tag:
            # å³æŒ‡é’ˆæ˜¯çº¿ç´¢ï¼Œç›´æ¥è¿”å›åç»§
            return p.right
        else:
            # å³æŒ‡é’ˆæŒ‡å‘å­æ ‘ï¼Œæ‰¾åˆ°å³å­æ ‘çš„æœ€å·¦èŠ‚ç‚¹
            p = p.right
            while not p.left_tag:
                p = p.left
            return p

    def inorder_traversal(self):
        """ä¸­åºçº¿ç´¢éå†"""
        result = []
        p = self.first_node()
        while p:
            result.append(p.data)
            p = self.next_node(p)
        return result

    def insert(self, val):
        """æ’å…¥èŠ‚ç‚¹ï¼ˆå»ºæ ‘ç”¨ï¼‰"""
        if not self.root:
            self.root = ThreadNode(val)
            return

        curr = self.root
        parent = None

        while curr:
            parent = curr
            if val < curr.data:
                if curr.left_tag:  # é‡åˆ°çº¿ç´¢å°±åœæ­¢
                    break
                curr = curr.left
            else:
                if curr.right_tag:  # é‡åˆ°çº¿ç´¢å°±åœæ­¢
                    break
                curr = curr.right

        new_node = ThreadNode(val)
        if val < parent.data:
            parent.left = new_node
        else:
            parent.right = new_node

# ä½¿ç”¨ç¤ºä¾‹
def example_usage():
    tree = ThreadedBinaryTree()

    # æ„å»ºäºŒå‰æ ‘
    values = [50, 30, 70, 20, 40, 60, 80]
    for val in values:
        tree.insert(val)

    # çº¿ç´¢åŒ–
    tree.create_inorder_thread()

    # éå†
    print("ä¸­åºçº¿ç´¢éå†ç»“æœ:", tree.inorder_traversal())</code></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- ğŸŒŸ å®é™…åº”ç”¨ -->
    <div class="content-card">
        <div class="content-section">
            <h2 class="section-title">
                <span class="section-icon">ğŸŒŸ</span>
                å®é™…åº”ç”¨
            </h2>

            <div class="applications">
                <div class="unified-grid unified-grid-2">
                    <div class="app-item">
                        <h4>ğŸ—„ï¸ æ•°æ®åº“ç´¢å¼•</h4>
                        <p><strong>åº”ç”¨åœºæ™¯ï¼š</strong>B+æ ‘å¶å­èŠ‚ç‚¹çš„çº¿ç´¢è¿æ¥</p>
                        <p><strong>ä¼˜åŠ¿ï¼š</strong>æ”¯æŒèŒƒå›´æŸ¥è¯¢å’Œé¡ºåºè®¿é—®</p>
                        <p><strong>å®ç°ï¼š</strong>å¶å­èŠ‚ç‚¹é€šè¿‡çº¿ç´¢å½¢æˆæœ‰åºé“¾è¡¨</p>
                    </div>

                    <div class="app-item">
                        <h4>ğŸ’¾ å†…å­˜å—é™ç¯å¢ƒ</h4>
                        <p><strong>åº”ç”¨åœºæ™¯ï¼š</strong>åµŒå…¥å¼ç³»ç»Ÿã€å•ç‰‡æœºç¼–ç¨‹</p>
                        <p><strong>ä¼˜åŠ¿ï¼š</strong>é¿å…é€’å½’æ ˆæº¢å‡ºé—®é¢˜</p>
                        <p><strong>å®ç°ï¼š</strong>ç”¨çº¿ç´¢æ›¿ä»£å‡½æ•°è°ƒç”¨æ ˆ</p>
                    </div>

                    <div class="app-item">
                        <h4>ğŸ“Š è¡¨è¾¾å¼æ±‚å€¼</h4>
                        <p><strong>åº”ç”¨åœºæ™¯ï¼š</strong>ç¼–è¯‘å™¨ä¸­çš„è¯­æ³•æ ‘éå†</p>
                        <p><strong>ä¼˜åŠ¿ï¼š</strong>é«˜æ•ˆçš„éé€’å½’éå†ç®—æ³•</p>
                        <p><strong>å®ç°ï¼š</strong>çº¿ç´¢åŒ–è¯­æ³•æ ‘è¿›è¡Œä»£ç ç”Ÿæˆ</p>
                    </div>

                    <div class="app-item">
                        <h4>ğŸ“ˆ å¤§æ•°æ®éå†</h4>
                        <p><strong>åº”ç”¨åœºæ™¯ï¼š</strong>å¤§è§„æ¨¡æ ‘å½¢æ•°æ®çš„é¡ºåºè®¿é—®</p>
                        <p><strong>ä¼˜åŠ¿ï¼š</strong>èŠ‚çœå†…å­˜ï¼Œæé«˜ç¼“å­˜å‘½ä¸­ç‡</p>
                        <p><strong>å®ç°ï¼š</strong>å°†æ ‘å½¢ç»“æ„çº¿æ€§åŒ–è®¿é—®</p>
                    </div>
                </div>

                <div class="comparison-table">
                    <h4>ğŸ“ˆ æ€§èƒ½å¯¹æ¯”</h4>
                    <table>
                        <thead>
                            <tr>
                                <th>æ“ä½œç±»å‹</th>
                                <th>æ™®é€šäºŒå‰æ ‘</th>
                                <th>çº¿ç´¢äºŒå‰æ ‘</th>
                                <th>ä¼˜åŠ¿è¯´æ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>æ‰¾å‰é©±èŠ‚ç‚¹</td>
                                <td>O(h)</td>
                                <td>O(1)</td>
                                <td>ç›´æ¥é€šè¿‡çº¿ç´¢è®¿é—®</td>
                            </tr>
                            <tr>
                                <td>æ‰¾åç»§èŠ‚ç‚¹</td>
                                <td>O(h)</td>
                                <td>O(1)</td>
                                <td>ç›´æ¥é€šè¿‡çº¿ç´¢è®¿é—®</td>
                            </tr>
                            <tr>
                                <td>ä¸­åºéå†</td>
                                <td>O(n), éœ€è¦O(h)æ ˆç©ºé—´</td>
                                <td>O(n), éœ€è¦O(1)æ ˆç©ºé—´</td>
                                <td>èŠ‚çœæ ˆç©ºé—´</td>
                            </tr>
                            <tr>
                                <td>ç©ºé—´åˆ©ç”¨ç‡</td>
                                <td>æœ‰n+1ä¸ªç©ºæŒ‡é’ˆåŸŸ</td>
                                <td>å……åˆ†åˆ©ç”¨ç©ºæŒ‡é’ˆåŸŸ</td>
                                <td>æé«˜å­˜å‚¨æ•ˆç‡</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- âœ… å­¦ä¹ æ£€éªŒ -->
    <div class="content-card">
        <div class="content-section">
            <h2 class="section-title">
                <span class="section-icon">âœ…</span>
                å­¦ä¹ æ£€éªŒ
            </h2>

            <div class="quiz-section">
                <div class="quiz-item">
                    <h4>ğŸ¤” é—®é¢˜1ï¼šç©ºé—´åˆ†æ</h4>
                    <p>ä¸€æ£µæœ‰100ä¸ªèŠ‚ç‚¹çš„å®Œå…¨äºŒå‰æ ‘ï¼Œæœ‰å¤šå°‘ä¸ªç©ºæŒ‡é’ˆåŸŸå¯ä»¥ç”¨äºçº¿ç´¢åŒ–ï¼Ÿçº¿ç´¢åŒ–åèƒ½èŠ‚çœå¤šå°‘ç©ºé—´ï¼Ÿ</p>
                    <button class="quiz-btn" onclick="toggleAnswer(1)">ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</button>
                    <div id="answer1" class="quiz-answer">
                        <strong>ç­”æ¡ˆï¼š</strong><br>
                        <strong>ç©ºæŒ‡é’ˆåŸŸæ•°é‡ï¼š</strong>100ä¸ªèŠ‚ç‚¹çš„äºŒå‰æ ‘æœ‰200ä¸ªæŒ‡é’ˆåŸŸï¼Œå…¶ä¸­99ä¸ªç”¨äºè¿æ¥çˆ¶å­èŠ‚ç‚¹ï¼Œæ‰€ä»¥æœ‰101ä¸ªç©ºæŒ‡é’ˆåŸŸ<br>
                        <strong>çº¿ç´¢åŒ–æ•ˆæœï¼š</strong>å¯ä»¥åˆ©ç”¨è¿™101ä¸ªç©ºæŒ‡é’ˆåŸŸå­˜å‚¨å‰é©±åç»§ä¿¡æ¯ï¼Œå¤§å¤§æé«˜ç©ºé—´åˆ©ç”¨ç‡<br>
                        <strong>å…¬å¼ï¼š</strong>nä¸ªèŠ‚ç‚¹çš„äºŒå‰æ ‘æœ‰n+1ä¸ªç©ºæŒ‡é’ˆåŸŸ
                    </div>
                </div>

                <div class="quiz-item">
                    <h4>ğŸ¤” é—®é¢˜2ï¼šæ—¶é—´å¤æ‚åº¦å¯¹æ¯”</h4>
                    <p>åœ¨çº¿ç´¢äºŒå‰æ ‘ä¸­æŸ¥æ‰¾æŸä¸ªèŠ‚ç‚¹çš„ä¸­åºå‰é©±çš„æ—¶é—´å¤æ‚åº¦æ˜¯å¤šå°‘ï¼Ÿæ™®é€šäºŒå‰æ ‘å‘¢ï¼Ÿ</p>
                    <button class="quiz-btn" onclick="toggleAnswer(2)">ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</button>
                    <div id="answer2" class="quiz-answer">
                        <strong>ç­”æ¡ˆï¼š</strong><br>
                        <strong>çº¿ç´¢äºŒå‰æ ‘ï¼š</strong>O(1) - é€šè¿‡å‰é©±çº¿ç´¢ç›´æ¥è®¿é—®<br>
                        <strong>æ™®é€šäºŒå‰æ ‘ï¼š</strong>O(h) - éœ€è¦å‘ä¸Šå›æº¯æˆ–é‡æ–°éå†ï¼Œhæ˜¯æ ‘çš„é«˜åº¦<br>
                        <strong>ä¼˜åŠ¿ï¼š</strong>çº¿ç´¢äºŒå‰æ ‘å°†æŸ¥æ‰¾å‰é©±åç»§çš„æ“ä½œä»å¯¹æ•°æ—¶é—´ä¼˜åŒ–ä¸ºå¸¸æ•°æ—¶é—´
                    </div>
                </div>

                <div class="quiz-item">
                    <h4>ğŸ¤” é—®é¢˜3ï¼šçº¿ç´¢åŒ–è¿‡ç¨‹</h4>
                    <p>ç»™å®šäºŒå‰æ ‘ç»“æ„ï¼Œè¯·æè¿°å¯¹èŠ‚ç‚¹Eè¿›è¡Œçº¿ç´¢åŒ–æ—¶éœ€è¦å»ºç«‹å“ªäº›çº¿ç´¢ï¼Ÿ</p>
                    <pre class="tree-structure">
        D
       / \
      B   F
     / \ / \
    A  C E  G
                    </pre>
                    <button class="quiz-btn" onclick="toggleAnswer(3)">ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</button>
                    <div id="answer3" class="quiz-answer">
                        <strong>ç­”æ¡ˆï¼š</strong><br>
                        <strong>èŠ‚ç‚¹Eçš„çº¿ç´¢åŒ–ï¼š</strong><br>
                        â€¢ å·¦æŒ‡é’ˆåŸŸä¸ºç©ºï¼Œå»ºç«‹å‰é©±çº¿ç´¢æŒ‡å‘Dï¼ˆä¸­åºéå†ä¸­Eçš„å‰é©±æ˜¯Dï¼‰<br>
                        â€¢ å³æŒ‡é’ˆåŸŸä¸ºç©ºï¼Œå»ºç«‹åç»§çº¿ç´¢æŒ‡å‘Fï¼ˆä¸­åºéå†ä¸­Eçš„åç»§æ˜¯Fï¼‰<br>
                        <strong>ä¸­åºéå†åºåˆ—ï¼š</strong>A â†’ B â†’ C â†’ D â†’ E â†’ F â†’ G<br>
                        <strong>æ ‡å¿—ä½ï¼š</strong>leftTag=true, rightTag=trueï¼ˆéƒ½æ˜¯çº¿ç´¢ï¼‰
                    </div>
                </div>

                <div class="quiz-item">
                    <h4>ğŸ¤” é—®é¢˜4ï¼šé€‚ç”¨åœºæ™¯åˆ¤æ–­</h4>
                    <p>ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨çº¿ç´¢äºŒå‰æ ‘æœ€åˆé€‚ï¼Ÿä»€ä¹ˆæƒ…å†µä¸‹ä¸å»ºè®®ä½¿ç”¨ï¼Ÿ</p>
                    <button class="quiz-btn" onclick="toggleAnswer(4)">ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ</button>
                    <div id="answer4" class="quiz-answer">
                        <strong>ç­”æ¡ˆï¼š</strong><br>
                        <strong>é€‚åˆä½¿ç”¨çš„åœºæ™¯ï¼š</strong><br>
                        â€¢ é¢‘ç¹éœ€è¦æ‰¾å‰é©±åç»§èŠ‚ç‚¹çš„åº”ç”¨<br>
                        â€¢ å†…å­˜å—é™éœ€è¦é¿å…é€’å½’æ ˆçš„ç¯å¢ƒ<br>
                        â€¢ æ ‘ç»“æ„ç›¸å¯¹ç¨³å®šï¼Œå¾ˆå°‘è¿›è¡Œæ’å…¥åˆ é™¤æ“ä½œ<br>
                        â€¢ éœ€è¦é¡ºåºéå†çš„å¤§å‹æ•°æ®é›†<br><br>
                        <strong>ä¸å»ºè®®ä½¿ç”¨çš„åœºæ™¯ï¼š</strong><br>
                        â€¢ é¢‘ç¹æ’å…¥åˆ é™¤æ“ä½œï¼ˆä¼šç ´åçº¿ç´¢ç»“æ„ï¼‰<br>
                        â€¢ åªéœ€è¦å¶å°”éå†çš„å°è§„æ¨¡æ•°æ®<br>
                        â€¢ ä¸»è¦è¿›è¡ŒæŸ¥æ‰¾æ“ä½œè€Œééå†æ“ä½œ
                    </div>
                </div>
            </div>

            <div class="next-steps">
                <h4>ğŸš€ ä¸‹ä¸€æ­¥å­¦ä¹ å»ºè®®</h4>
                <div class="unified-grid unified-grid-2">
                    <div class="info-box info-box-info">
                        <span class="info-icon">ğŸ“–</span>
                        <strong>ç»§ç»­å­¦ä¹ ï¼š</strong>Bæ ‘ã€B+æ ‘çš„çº¿ç´¢åŒ–åº”ç”¨
                    </div>
                    <div class="info-box info-box-success">
                        <span class="info-icon">ğŸ’ª</span>
                        <strong>ç»ƒä¹ å»ºè®®ï¼š</strong>æ‰‹åŠ¨çº¿ç´¢åŒ–å°è§„æ¨¡äºŒå‰æ ‘ï¼Œå®ç°çº¿ç´¢éå†ç®—æ³•
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å¯¼èˆªæŒ‰é’® -->
    <div style="text-align: center; margin-top: 40px;">
        <a href="{% url 'knowledge_app:index' %}" class="unified-btn unified-btn-primary">
            <span>ğŸ </span>
            è¿”å›é¦–é¡µ
        </a>
        <a href="{% url 'knowledge_app:cs_universe' %}" class="unified-btn unified-btn-secondary">
            <span>ğŸŒŒ</span>
            æ¢ç´¢CSå®‡å®™
        </a>
    </div>
</div>

<style>
/* é¡µé¢åŸºç¡€æ ·å¼ */
.page-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.breadcrumb {
    margin-bottom: 20px;
    font-size: 14px;
    color: #666;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    font-size: 2.5rem;
    color: #333;
    margin-bottom: 10px;
}

.page-icon {
    font-size: 3rem;
    margin-right: 15px;
}

.content-card {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 20px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.1);
}

.section-title {
    font-size: 1.5rem;
    color: #333;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-icon {
    font-size: 1.8rem;
}

/* ç½‘æ ¼å¸ƒå±€ */
.unified-grid {
    display: grid;
    gap: 20px;
}

.unified-grid-2 {
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
}

/* ä¿¡æ¯æ¡†æ ·å¼ */
.info-box {
    padding: 20px;
    border-radius: 8px;
    border-left: 4px solid #4299e1;
}

.info-box-info {
    background: #ebf8ff;
    border-left-color: #4299e1;
}

.info-box-success {
    background: #f0fff4;
    border-left-color: #48bb78;
}

.info-box-warning {
    background: #fffaf0;
    border-left-color: #ed8936;
}

.info-icon {
    margin-right: 8px;
}

/* æ¦‚å¿µè¯¦è§£æ ·å¼ */
.concept-item {
    margin-bottom: 25px;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.concept-item h3 {
    color: #2d3748;
    margin-bottom: 10px;
}

.example-box {
    margin-top: 15px;
    padding: 15px;
    background: #e6fffa;
    border-left: 4px solid #38b2ac;
    border-radius: 4px;
}

/* é—®é¢˜è§£å†³æ–¹æ¡ˆæ ·å¼ */
.problem-solution {
    margin-top: 25px;
}

.problem-box {
    padding: 20px;
    background: #fef2f2;
    border-left: 4px solid #f56565;
    border-radius: 8px;
}

.solution-box {
    padding: 20px;
    background: #f0fff4;
    border-left: 4px solid #48bb78;
    border-radius: 8px;
}

/* ç»Ÿè®¡æ¡†æ ·å¼ */
.stats-box {
    margin-top: 15px;
    padding: 15px;
    background: #f7fafc;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.stats-box h5 {
    color: #2d3748;
    margin-bottom: 10px;
}

/* çº¿ç´¢ç±»å‹æ ·å¼ */
.thread-types {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.type-box {
    padding: 15px;
    background: #ebf4ff;
    border-radius: 8px;
    border-left: 4px solid #3182ce;
    text-align: center;
}

.type-box h4 {
    color: #2b6cb0;
    margin-bottom: 10px;
}

.type-feature {
    margin-top: 10px;
    font-size: 0.9rem;
    color: #4a5568;
    font-style: italic;
}

/* è¿‡ç¨‹æ­¥éª¤æ ·å¼ */
.process-steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.step-box {
    display: flex;
    align-items: flex-start;
    gap: 15px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
}

.step-number {
    background: #4299e1;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    flex-shrink: 0;
}

.step-content h5 {
    color: #2d3748;
    margin-bottom: 5px;
}

/* éå†ç®—æ³•æ ·å¼ */
.traversal-algorithm {
    margin-top: 15px;
}

.algorithm-steps {
    background: #f7fafc;
    padding: 20px;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

.algo-step {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 10px;
    padding: 8px 0;
}

.step-label {
    background: #ed8936;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: bold;
    flex-shrink: 0;
}

/* Canvasæ¼”ç¤ºæ ·å¼ */
.canvas-demo {
    background: white;
    border-radius: 15px;
    padding: 25px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
}

.controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.controls button {
    padding: 12px 20px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s ease;
    color: white;
}

.threading-btn { background: linear-gradient(45deg, #667eea, #764ba2); }
.traverse-btn { background: linear-gradient(45deg, #f093fb, #f5576c); }
.toggle-threads-btn { background: linear-gradient(45deg, #4facfe, #00f2fe); }
.reset-btn { background: linear-gradient(45deg, #4a5568, #2d3748); }

.controls button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
}

.canvas-container {
    display: flex;
    justify-content: center;
    margin-bottom: 20px;
}

#threadCanvas {
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    background: white;
}

/* å›¾ä¾‹æ ·å¼ */
.legend {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    margin: 20px 0;
    border: 1px solid #e2e8f0;
}

.legend h4 {
    margin: 0 0 15px 0;
    color: #2d3748;
    font-size: 16px;
}

.legend-items {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    margin-bottom: 15px;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 12px;
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.legend-line {
    width: 30px;
    height: 3px;
}

.normal-line {
    background: #374151;
}

.predecessor-thread-line {
    background: linear-gradient(90deg, rgba(59, 130, 246, 0.8), rgba(147, 197, 253, 0.6));
    border-radius: 2px;
}

.successor-thread-line {
    background: linear-gradient(90deg, rgba(220, 38, 38, 0.8), rgba(248, 113, 113, 0.6));
    border-radius: 2px;
}

.legend-color {
    width: 20px;
    height: 20px;
    border-radius: 50%;
}

/* èŠ‚ç‚¹æ¼”ç¤ºæ ·å¼ */
.legend-node-demo {
    display: flex;
    border: 2px solid #374151;
    border-radius: 4px;
    overflow: hidden;
    font-size: 10px;
    font-weight: bold;
}

.legend-node-demo.threaded {
    border-color: #22c55e;
}

.legend-pointer-field {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #e5e7eb;
    border-right: 1px solid #374151;
    color: #374151;
}

.legend-pointer-field:last-child {
    border-right: none;
}

.legend-threaded .legend-pointer-field {
    color: #dc2626;
}

.legend-data-field {
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f3f4f6;
    border-right: 1px solid #374151;
    color: #1f2937;
    font-weight: bold;
}

.legend-explanation {
    background: white;
    padding: 12px;
    border-radius: 6px;
    border-left: 4px solid #3b82f6;
}

.legend-explanation p {
    margin: 0 0 8px 0;
    font-weight: bold;
    color: #2d3748;
}

.legend-explanation ul {
    margin: 0;
    padding-left: 20px;
}

.legend-explanation li {
    margin-bottom: 4px;
    font-size: 14px;
    color: #4a5568;
}

.info {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
}

.info .info-box {
    background: #f7fafc;
    border: 1px solid #e2e8f0;
}

.info h4 {
    margin-top: 0;
    color: #2d3748;
}

.sequence {
    font-size: 16px;
    font-weight: bold;
    color: #4299e1;
    min-height: 20px;
}

.status {
    font-size: 14px;
    color: #718096;
    margin-top: 8px;
}

/* ä»£ç æ ·å¼ */
.code-tabs {
    display: flex;
    border-bottom: 1px solid #e2e8f0;
    margin-bottom: 20px;
}

.tab-btn {
    padding: 12px 24px;
    border: none;
    background: none;
    cursor: pointer;
    font-size: 16px;
    border-bottom: 2px solid transparent;
    transition: all 0.3s ease;
}

.tab-btn.active {
    color: #4299e1;
    border-bottom-color: #4299e1;
}

.code-content {
    display: none;
}

.code-content.active {
    display: block;
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.copy-btn {
    background: #4299e1;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
}

.copy-btn:hover {
    background: #3182ce;
}

pre {
    background: #2d3748;
    color: #e2e8f0;
    padding: 20px;
    border-radius: 8px;
    overflow-x: auto;
    line-height: 1.6;
    font-size: 14px;
}

/* åº”ç”¨åœºæ™¯æ ·å¼ */
.app-item {
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid #4299e1;
}

.app-item h4 {
    color: #2d3748;
    margin-bottom: 15px;
}

/* æ€§èƒ½å¯¹æ¯”è¡¨æ ¼æ ·å¼ */
.comparison-table {
    margin-top: 30px;
}

.comparison-table table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.comparison-table th,
.comparison-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

.comparison-table th {
    background: #f7fafc;
    font-weight: bold;
    color: #2d3748;
}

/* æœ¯è¯­åˆ—è¡¨æ ·å¼ */
.terms-list .unified-grid-2 {
    margin-top: 15px;
}

.term-item {
    padding: 12px;
    background: white;
    border-radius: 6px;
    border-left: 3px solid #4299e1;
}

/* æµ‹éªŒæ ·å¼ */
.quiz-item {
    margin-bottom: 25px;
    padding: 20px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
}

.quiz-btn {
    background: #4299e1;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 15px;
    transition: background 0.3s ease;
}

.quiz-btn:hover {
    background: #3182ce;
}

.quiz-answer {
    display: none;
    margin-top: 15px;
    padding: 15px;
    background: #f0fff4;
    border-left: 4px solid #48bb78;
    border-radius: 4px;
}

.quiz-answer.show {
    display: block;
}

.tree-structure {
    background: #f7fafc;
    color: #2d3748;
    font-family: 'Courier New', monospace;
    text-align: center;
    margin: 15px 0;
}

.unified-btn {
    display: inline-block;
    padding: 12px 24px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    margin: 0 10px;
    transition: all 0.3s ease;
}

.unified-btn-primary {
    background: #4299e1;
    color: white;
}

.unified-btn-secondary {
    background: #718096;
    color: white;
}

.unified-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

@media (max-width: 768px) {
    .info {
        grid-template-columns: 1fr;
    }

    .controls {
        flex-direction: column;
        align-items: center;
    }

    .controls button {
        width: 200px;
    }

    .unified-grid-2 {
        grid-template-columns: 1fr;
    }

    .thread-types {
        grid-template-columns: 1fr;
    }

    .process-steps {
        grid-template-columns: 1fr;
    }
}
</style>

<script>
// Canvasçº¿ç´¢äºŒå‰æ ‘æ¼”ç¤ºç›¸å…³ä»£ç 
const threadCanvas = document.getElementById('threadCanvas');
const threadCtx = threadCanvas.getContext('2d');

// çº¿ç´¢äºŒå‰æ ‘èŠ‚ç‚¹ç±»
class ThreadedNode {
    constructor(val, x, y) {
        this.val = val;
        this.x = x;
        this.y = y;
        this.left = null;
        this.right = null;
        this.leftTag = false;   // falseè¡¨ç¤ºå·¦æŒ‡é’ˆæŒ‡å‘å­èŠ‚ç‚¹ï¼Œtrueè¡¨ç¤ºå‰é©±çº¿ç´¢
        this.rightTag = false;  // falseè¡¨ç¤ºå³æŒ‡é’ˆæŒ‡å‘å­èŠ‚ç‚¹ï¼Œtrueè¡¨ç¤ºåç»§çº¿ç´¢
        this.visited = false;
        this.current = false;
        this.threaded = false;  // æ˜¯å¦å·²ç»å®Œæˆçº¿ç´¢åŒ–
        this.width = 80;        // èŠ‚ç‚¹å®½åº¦
        this.height = 40;       // èŠ‚ç‚¹é«˜åº¦
    }

    // è·å–å·¦æŒ‡é’ˆåŸŸçš„ä½ç½®
    getLeftPointerPos() {
        return {
            x: this.x - this.width/2 + this.width/6,
            y: this.y
        };
    }

    // è·å–å³æŒ‡é’ˆåŸŸçš„ä½ç½®
    getRightPointerPos() {
        return {
            x: this.x + this.width/2 - this.width/6,
            y: this.y
        };
    }

    // è·å–æ•°æ®åŸŸçš„ä½ç½®
    getDataPos() {
        return {
            x: this.x,
            y: this.y
        };
    }
}

// åˆ›å»ºç¤ºä¾‹çº¿ç´¢äºŒå‰æ ‘ - å‘ä¸‹å¹³ç§»
function createSampleThreadTree() {
    const root = new ThreadedNode('D', 400, 120);  // ä»80å‘ä¸‹ç§»åˆ°120
    root.left = new ThreadedNode('B', 250, 180);   // ä»140å‘ä¸‹ç§»åˆ°180
    root.right = new ThreadedNode('F', 550, 180);  // ä»140å‘ä¸‹ç§»åˆ°180
    root.left.left = new ThreadedNode('A', 150, 240);   // ä»200å‘ä¸‹ç§»åˆ°240
    root.left.right = new ThreadedNode('C', 350, 240);  // ä»200å‘ä¸‹ç§»åˆ°240
    root.right.left = new ThreadedNode('E', 450, 240);  // ä»200å‘ä¸‹ç§»åˆ°240
    root.right.right = new ThreadedNode('G', 650, 240); // ä»200å‘ä¸‹ç§»åˆ°240

    return root;
}

let threadTree = createSampleThreadTree();
let threadAnimationState = {
    isAnimating: false,
    currentOperation: '',
    sequence: [],
    threadsVisible: true,
    pre: null  // ç”¨äºçº¿ç´¢åŒ–è¿‡ç¨‹ä¸­è®°å½•å‰é©±èŠ‚ç‚¹
};

// ç»˜åˆ¶çŸ©å½¢èŠ‚ç‚¹
function drawThreadNode(node) {
    const x = node.x - node.width/2;
    const y = node.y - node.height/2;

    // æ ¹æ®èŠ‚ç‚¹çŠ¶æ€è®¾ç½®é¢œè‰²
    let fillColor, strokeColor, lineWidth;
    if (node.current) {
        fillColor = '#ff4444';
        strokeColor = '#cc0000';
        lineWidth = 3;
    } else if (node.threaded) {
        fillColor = '#22c55e';
        strokeColor = '#16a34a';
        lineWidth = 2;
    } else if (node.visited) {
        fillColor = '#f97316';
        strokeColor = '#ea580c';
        lineWidth = 2;
    } else {
        fillColor = '#e2e8f0';
        strokeColor = '#a0aec0';
        lineWidth = 2;
    }

    // ç»˜åˆ¶æ•´ä¸ªèŠ‚ç‚¹æ¡†æ¶
    threadCtx.fillStyle = fillColor;
    threadCtx.strokeStyle = strokeColor;
    threadCtx.lineWidth = lineWidth;
    threadCtx.fillRect(x, y, node.width, node.height);
    threadCtx.strokeRect(x, y, node.width, node.height);

    // ç»˜åˆ¶åˆ†éš”çº¿ï¼ˆåˆ†ä¸ºä¸‰ä¸ªåŒºåŸŸï¼šå·¦æŒ‡é’ˆåŸŸ | æ•°æ®åŸŸ | å³æŒ‡é’ˆåŸŸï¼‰
    threadCtx.strokeStyle = strokeColor;
    threadCtx.lineWidth = 1;
    // å·¦åˆ†éš”çº¿
    threadCtx.beginPath();
    threadCtx.moveTo(x + node.width/3, y);
    threadCtx.lineTo(x + node.width/3, y + node.height);
    threadCtx.stroke();
    // å³åˆ†éš”çº¿
    threadCtx.beginPath();
    threadCtx.moveTo(x + 2*node.width/3, y);
    threadCtx.lineTo(x + 2*node.width/3, y + node.height);
    threadCtx.stroke();

    // ç»˜åˆ¶æ•°æ®å€¼ï¼ˆä¸­é—´åŒºåŸŸï¼‰
    threadCtx.fillStyle = node.current ? 'white' : '#1a1a1a';
    threadCtx.font = 'bold 16px Arial';
    threadCtx.textAlign = 'center';
    threadCtx.textBaseline = 'middle';
    threadCtx.fillText(node.val, node.x, node.y);

    // ç»˜åˆ¶å·¦æŒ‡é’ˆåŸŸæ ‡è¯†
    threadCtx.font = '10px Arial';
    threadCtx.textAlign = 'center';
    threadCtx.textBaseline = 'middle';
    const leftPtrX = x + node.width/6;
    const leftPtrY = y + node.height/2;

    if (node.leftTag) {
        // çº¿ç´¢æŒ‡é’ˆç”¨è™šçº¿ç®­å¤´è¡¨ç¤º
        threadCtx.fillStyle = '#3b82f6';
        threadCtx.fillText('T', leftPtrX, leftPtrY - 6);
        threadCtx.fillText('â†–', leftPtrX, leftPtrY + 6);
    } else if (node.left) {
        // æ­£å¸¸æŒ‡é’ˆç”¨å®çº¿ç®­å¤´è¡¨ç¤º
        threadCtx.fillStyle = '#000000';
        threadCtx.fillText('L', leftPtrX, leftPtrY - 6);
        threadCtx.fillText('â†™', leftPtrX, leftPtrY + 6);
    } else {
        // ç©ºæŒ‡é’ˆ
        threadCtx.fillStyle = '#666666';
        threadCtx.fillText('âˆ…', leftPtrX, leftPtrY);
    }

    // ç»˜åˆ¶å³æŒ‡é’ˆåŸŸæ ‡è¯†
    const rightPtrX = x + 5*node.width/6;
    const rightPtrY = y + node.height/2;

    if (node.rightTag) {
        // çº¿ç´¢æŒ‡é’ˆ
        threadCtx.fillStyle = '#dc2626';
        threadCtx.fillText('T', rightPtrX, rightPtrY - 6);
        threadCtx.fillText('â†—', rightPtrX, rightPtrY + 6);
    } else if (node.right) {
        // æ­£å¸¸æŒ‡é’ˆ
        threadCtx.fillStyle = '#000000';
        threadCtx.fillText('R', rightPtrX, rightPtrY - 6);
        threadCtx.fillText('â†˜', rightPtrX, rightPtrY + 6);
    } else {
        // ç©ºæŒ‡é’ˆ
        threadCtx.fillStyle = '#666666';
        threadCtx.fillText('âˆ…', rightPtrX, rightPtrY);
    }
}

// ç»˜åˆ¶æ™®é€šè¿æ¥çº¿
function drawNormalConnection(parent, child) {
    let startX, startY, endX, endY;

    // ç¡®å®šæ˜¯å·¦å­æ ‘è¿˜æ˜¯å³å­æ ‘è¿æ¥
    if (child.x < parent.x) {
        // å·¦å­æ ‘è¿æ¥ - ä»çˆ¶èŠ‚ç‚¹çš„å·¦æŒ‡é’ˆåŸŸå¼€å§‹
        const leftPtr = parent.getLeftPointerPos();
        startX = leftPtr.x;
        startY = parent.y + parent.height/2;
    } else {
        // å³å­æ ‘è¿æ¥ - ä»çˆ¶èŠ‚ç‚¹çš„å³æŒ‡é’ˆåŸŸå¼€å§‹
        const rightPtr = parent.getRightPointerPos();
        startX = rightPtr.x;
        startY = parent.y + parent.height/2;
    }

    // ç»ˆç‚¹ä¸ºå­èŠ‚ç‚¹çš„é¡¶éƒ¨ä¸­å¿ƒ
    endX = child.x;
    endY = child.y - child.height/2;

    threadCtx.beginPath();
    threadCtx.moveTo(startX, startY);
    threadCtx.lineTo(endX, endY);
    threadCtx.strokeStyle = '#374151';
    threadCtx.lineWidth = 2;
    threadCtx.stroke();

    // ç»˜åˆ¶ç®­å¤´
    const angle = Math.atan2(endY - startY, endX - startX);
    const headLength = 8;
    const headAngle = Math.PI / 6;

    threadCtx.fillStyle = '#374151';
    threadCtx.beginPath();
    threadCtx.moveTo(endX, endY);
    threadCtx.lineTo(
        endX - headLength * Math.cos(angle - headAngle),
        endY - headLength * Math.sin(angle - headAngle)
    );
    threadCtx.lineTo(
        endX - headLength * Math.cos(angle + headAngle),
        endY - headLength * Math.sin(angle + headAngle)
    );
    threadCtx.closePath();
    threadCtx.fill();
}

// æ”¶é›†æ‰€æœ‰çº¿ç´¢ä¿¡æ¯å¹¶è®¡ç®—åˆ†å±‚è·¯å¾„
function calculateThreadPaths(root) {
    const threads = [];

    // æ”¶é›†æ‰€æœ‰çº¿ç´¢
    function collectThreads(node) {
        if (node) {
            if (node.leftTag && node.left) {
                threads.push({
                    from: node,
                    to: node.left,
                    type: 'predecessor',
                    isLeft: true
                });
            }
            if (node.rightTag && node.right) {
                threads.push({
                    from: node,
                    to: node.right,
                    type: 'successor',
                    isLeft: false
                });
            }
            if (!node.leftTag) collectThreads(node.left);
            if (!node.rightTag) collectThreads(node.right);
        }
    }

    collectThreads(root);

    // ä¸ºæ¯ä¸ªçº¿ç´¢åˆ†é…ä¸åŒçš„è·¯å¾„é«˜åº¦
    threads.forEach((thread, index) => {
        const { from, to, type } = thread;

        // è®¡ç®—åŒç±»å‹çº¿ç´¢çš„ç´¢å¼•ï¼ˆç”¨äºè¿›ä¸€æ­¥åˆ†å±‚ï¼‰
        const sameTypeThreads = threads.filter((t, i) => i < index && t.type === type);
        const sameTypeIndex = sameTypeThreads.length;

        // æ ¹æ®ç±»å‹è®¾ç½®åŸºç¡€é«˜åº¦å’Œæ–¹å‘
        if (type === 'predecessor') {
            // å‰é©±çº¿ç´¢ï¼šå‘ä¸Šå¼¯æ›²
            thread.pathType = 'upper';
            thread.baseOffset = -60;  // å‘ä¸Šåç§»
            thread.levelOffset = sameTypeIndex * -25;  // å¤šä¸ªå‰é©±çº¿ç´¢é€å±‚å‘ä¸Š
            thread.direction = -1;
        } else {
            // åç»§çº¿ç´¢ï¼šå‘ä¸‹å¼¯æ›²
            thread.pathType = 'lower';
            thread.baseOffset = 60;   // å‘ä¸‹åç§»
            thread.levelOffset = sameTypeIndex * 25;   // å¤šä¸ªåç»§çº¿ç´¢é€å±‚å‘ä¸‹
            thread.direction = 1;
        }

        thread.level = sameTypeIndex;
    });

    return threads;
}

// ã€ä¼˜åŒ–å‡çº§ã€‘ç»˜åˆ¶æŸ”å’Œæ¸å˜çš„çº¿ç´¢æ›²çº¿ - æ— é”åˆ©ç®­å¤´
function drawSingleThread(thread) {
    if (!threadAnimationState.threadsVisible) return;

    const { from, to, type, pathType, baseOffset, levelOffset, level, direction } = thread;

    // èµ·ç‚¹åæ ‡
    let startX, startY;
    if (type === 'predecessor') {
        const leftPtr = from.getLeftPointerPos();
        startX = leftPtr.x;
        startY = from.y + from.height/2;
    } else {
        const rightPtr = from.getRightPointerPos();
        startX = rightPtr.x;
        startY = from.y + from.height/2;
    }

    // ç»ˆç‚¹åæ ‡ - ç²¾ç¡®æŒ‡å‘èŠ‚ç‚¹è¾¹ç¼˜
    const endX = to.x;
    const endY = to.y - to.height/2;

    // è®¡ç®—å¼¯æ›²è·¯å¾„çš„æ§åˆ¶é«˜åº¦
    const totalOffset = baseOffset + levelOffset;

    // æ°´å¹³åç§»ï¼Œåˆ›å»ºæ›´è‡ªç„¶çš„æ›²çº¿
    const horizontalSpread = Math.abs(endX - startX) * 0.4; // æ ¹æ®è·ç¦»è°ƒæ•´å¼¯æ›²ç¨‹åº¦
    const minSpread = 60 + level * 20;
    const actualSpread = Math.max(horizontalSpread, minSpread);

    // è®¡ç®—å››ä¸ªæ§åˆ¶ç‚¹ï¼Œç”¨äºåˆ›å»ºå¹³æ»‘çš„ä¸‰æ¬¡è´å¡å°”æ›²çº¿
    const cp1X = startX + (direction * actualSpread * 0.5);
    const cp1Y = startY + totalOffset * 0.4;

    const cp2X = endX + (direction * actualSpread * 0.3);
    const cp2Y = endY + totalOffset * 0.6;

    threadCtx.save();

    // ã€ä¼˜åŒ–æ ¸å¿ƒã€‘åˆ›å»ºæ¸å˜æ•ˆæœ
    const gradient = threadCtx.createLinearGradient(startX, startY, endX, endY);

    if (type === 'predecessor') {
        // å‰é©±çº¿ç´¢ï¼šè“è‰²ç³»æ¸å˜
        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.8)');   // æ·±è“å¼€å§‹
        gradient.addColorStop(0.3, 'rgba(96, 165, 250, 0.7)'); // ä¸­è“è¿‡æ¸¡
        gradient.addColorStop(0.7, 'rgba(147, 197, 253, 0.6)'); // æµ…è“è¿‡æ¸¡
        gradient.addColorStop(1, 'rgba(191, 219, 254, 0.5)');   // ææµ…è“ç»“æŸ
    } else {
        // åç»§çº¿ç´¢ï¼šçº¢è‰²ç³»æ¸å˜
        gradient.addColorStop(0, 'rgba(220, 38, 38, 0.8)');    // æ·±çº¢å¼€å§‹
        gradient.addColorStop(0.3, 'rgba(239, 68, 68, 0.7)');  // ä¸­çº¢è¿‡æ¸¡
        gradient.addColorStop(0.7, 'rgba(248, 113, 113, 0.6)'); // æµ…çº¢è¿‡æ¸¡
        gradient.addColorStop(1, 'rgba(254, 202, 202, 0.5)');   // ææµ…çº¢ç»“æŸ
    }

    // ä½¿ç”¨ä¸‰æ¬¡è´å¡å°”æ›²çº¿ç»˜åˆ¶è¶…å¹³æ»‘è·¯å¾„
    threadCtx.beginPath();
    threadCtx.moveTo(startX, startY);
    threadCtx.bezierCurveTo(cp1X, cp1Y, cp2X, cp2Y, endX, endY);

    // è®¾ç½®çº¿ç´¢æ ·å¼ - æ¸å˜é€æ˜æ•ˆæœ
    const baseAlpha = Math.max(0.5, 0.8 - level * 0.1);  // åŸºç¡€é€æ˜åº¦
    const lineWidth = Math.max(3, 5 - level * 0.4);     // çº¿æ¡å®½åº¦

    threadCtx.strokeStyle = gradient;
    threadCtx.lineWidth = lineWidth;
    threadCtx.setLineDash([]);  // å®çº¿ï¼Œä¸å†ä½¿ç”¨è™šçº¿
    threadCtx.lineCap = 'round';
    threadCtx.lineJoin = 'round';
    threadCtx.shadowColor = type === 'predecessor' ? 'rgba(59, 130, 246, 0.3)' : 'rgba(220, 38, 38, 0.3)';
    threadCtx.shadowBlur = 8;
    threadCtx.stroke();

    // ã€ä¼˜åŒ–å‡çº§ã€‘ç»˜åˆ¶æŸ”å’Œçš„æ¸å˜ç®­å¤´ - æ— é”è§’è®¾è®¡
    drawSoftGradientArrow(cp2X, cp2Y, endX, endY, gradient, lineWidth, type);

    // ç»˜åˆ¶ç±»å‹æ ‡ç­¾ - æ”¾åœ¨æ›²çº¿çš„ä¸­ç‚¹
    if (level < 2) {
        // è®¡ç®—è´å¡å°”æ›²çº¿ä¸­ç‚¹
        const t = 0.5; // å‚æ•°t=0.5å¯¹åº”æ›²çº¿ä¸­ç‚¹
        const labelX = Math.pow(1-t, 3) * startX +
                      3 * Math.pow(1-t, 2) * t * cp1X +
                      3 * (1-t) * Math.pow(t, 2) * cp2X +
                      Math.pow(t, 3) * endX;
        const labelY = Math.pow(1-t, 3) * startY +
                      3 * Math.pow(1-t, 2) * t * cp1Y +
                      3 * (1-t) * Math.pow(t, 2) * cp2Y +
                      Math.pow(t, 3) * endY;

        drawSoftThreadLabel(labelX, labelY, type, gradient, level);
    }

    // é«˜äº®å½“å‰æ´»åŠ¨çš„çº¿ç´¢
    if (from.current || to.current) {
        threadCtx.shadowBlur = 20;
        threadCtx.lineWidth = lineWidth + 2;
        threadCtx.stroke();
    }

    threadCtx.shadowBlur = 0;
    threadCtx.restore();
}

// ã€å…¨æ–°ä¼˜åŒ–ã€‘ç»˜åˆ¶æŸ”å’Œæ¸å˜ç®­å¤´ - åœ†æ¶¦æ— é”è§’è®¾è®¡
function drawSoftGradientArrow(fromX, fromY, toX, toY, gradient, baseWidth, type) {
    // è®¡ç®—ç®­å¤´æ–¹å‘
    const dx = toX - fromX;
    const dy = toY - fromY;
    const angle = Math.atan2(dy, dx);

    // ã€æŸ”å’Œè®¾è®¡ã€‘ç®­å¤´å‚æ•° - æ›´å°æ›´åœ†æ¶¦
    const headLength = Math.max(12, baseWidth * 2.5);  // å‡å°ç®­å¤´é•¿åº¦
    const headWidth = Math.max(4, baseWidth);          // å‡å°ç®­å¤´å®½åº¦

    threadCtx.save();

    // ã€æ¸å˜ç®­å¤´ã€‘ä½¿ç”¨ç›¸åŒçš„æ¸å˜å¡«å……
    threadCtx.fillStyle = gradient;
    threadCtx.strokeStyle = gradient;
    threadCtx.lineWidth = 1;

    // ã€åœ†æ¶¦ä¸‰è§’å½¢ã€‘ç»˜åˆ¶æ›´æ¸©å’Œçš„ç®­å¤´å½¢çŠ¶
    threadCtx.beginPath();
    threadCtx.moveTo(toX, toY);

    // è®¡ç®—ç®­å¤´çš„ä¸¤ä¸ªä¾§è¾¹ç‚¹ - ä½¿ç”¨æ›´å¤§çš„è§’åº¦åˆ›å»ºæ›´æ¸©å’Œçš„å½¢çŠ¶
    const arrowAngle = Math.PI / 4;  // 45åº¦è§’ï¼Œæ¯”åŸæ¥çš„36åº¦æ›´æ¸©å’Œ
    const leftAngle = angle + Math.PI - arrowAngle;
    const rightAngle = angle - Math.PI + arrowAngle;

    const leftX = toX + headLength * Math.cos(leftAngle);
    const leftY = toY + headLength * Math.sin(leftAngle);
    const rightX = toX + headLength * Math.cos(rightAngle);
    const rightY = toY + headLength * Math.sin(rightAngle);

    // ã€åœ†è§’å¤„ç†ã€‘ä½¿ç”¨åœ†è§’è¿æ¥åˆ›å»ºæ›´æŸ”å’Œçš„å¤–è§‚
    threadCtx.lineJoin = 'round';
    threadCtx.lineCap = 'round';

    threadCtx.lineTo(leftX, leftY);
    threadCtx.lineTo(rightX, rightY);
    threadCtx.closePath();

    // ã€æ¸å˜å¡«å……ã€‘æŸ”å’Œçš„é˜´å½±æ•ˆæœ
    threadCtx.shadowColor = type === 'predecessor' ? 'rgba(59, 130, 246, 0.4)' : 'rgba(220, 38, 38, 0.4)';
    threadCtx.shadowBlur = 6;
    threadCtx.fill();

    // ã€ç»†è…»æè¾¹ã€‘ç»™ç®­å¤´æ·»åŠ æç»†çš„æè¾¹å¢å¼ºç«‹ä½“æ„Ÿ
    threadCtx.shadowBlur = 0;
    threadCtx.lineWidth = 0.5;
    threadCtx.globalAlpha = 0.7;
    threadCtx.stroke();
    threadCtx.globalAlpha = 1;

    threadCtx.restore();
}

// ã€ä¼˜åŒ–å‡çº§ã€‘ç»˜åˆ¶æŸ”å’Œçš„çº¿ç´¢æ ‡ç­¾ - æ¸å˜èƒŒæ™¯
function drawSoftThreadLabel(x, y, type, gradient, level) {
    const labelText = type === 'predecessor' ? 'å‰é©±' : 'åç»§';

    threadCtx.save();
    threadCtx.font = 'bold 11px Arial';
    threadCtx.textAlign = 'center';
    threadCtx.textBaseline = 'middle';

    // æµ‹é‡æ–‡æœ¬å°ºå¯¸
    const textMetrics = threadCtx.measureText(labelText);
    const labelWidth = textMetrics.width + 14;
    const labelHeight = 20;

    // æ ¹æ®å±‚çº§å¾®è°ƒä½ç½®ï¼Œé¿å…é‡å 
    const adjustedY = y + level * 8;

    // ã€æ¸å˜èƒŒæ™¯ã€‘åˆ›å»ºä¸çº¿ç´¢åŒ¹é…çš„èƒŒæ™¯æ¸å˜
    const bgGradient = threadCtx.createLinearGradient(
        x - labelWidth/2, adjustedY - labelHeight/2,
        x + labelWidth/2, adjustedY + labelHeight/2
    );

    if (type === 'predecessor') {
        bgGradient.addColorStop(0, 'rgba(59, 130, 246, 0.9)');
        bgGradient.addColorStop(1, 'rgba(147, 197, 253, 0.7)');
    } else {
        bgGradient.addColorStop(0, 'rgba(220, 38, 38, 0.9)');
        bgGradient.addColorStop(1, 'rgba(248, 113, 113, 0.7)');
    }

    // ã€æŸ”å’Œé˜´å½±ã€‘ç»˜åˆ¶æ ‡ç­¾é˜´å½±
    threadCtx.fillStyle = 'rgba(0, 0, 0, 0.08)';
    threadCtx.fillRect(x - labelWidth/2 + 2, adjustedY - labelHeight/2 + 2, labelWidth, labelHeight);

    // ã€åœ†è§’çŸ©å½¢ã€‘ç»˜åˆ¶åœ†è§’æ ‡ç­¾èƒŒæ™¯
    const radius = 6;
    threadCtx.fillStyle = bgGradient;
    threadCtx.beginPath();
    threadCtx.roundRect(x - labelWidth/2, adjustedY - labelHeight/2, labelWidth, labelHeight, radius);
    threadCtx.fill();

    // ã€ä¼˜é›…è¾¹æ¡†ã€‘æ·»åŠ åŠé€æ˜è¾¹æ¡†
    threadCtx.strokeStyle = type === 'predecessor' ? 'rgba(59, 130, 246, 0.8)' : 'rgba(220, 38, 38, 0.8)';
    threadCtx.lineWidth = 1;
    threadCtx.stroke();

    // ã€é«˜å¯¹æ¯”æ–‡å­—ã€‘ç™½è‰²æ–‡å­—å¸¦è½»å¾®é˜´å½±ï¼Œç¡®ä¿æ¸…æ™°å¯è¯»
    threadCtx.fillStyle = 'rgba(255, 255, 255, 0.98)';
    threadCtx.shadowColor = 'rgba(0, 0, 0, 0.5)';
    threadCtx.shadowBlur = 2;
    threadCtx.shadowOffsetX = 0;
    threadCtx.shadowOffsetY = 1;
    threadCtx.fillText(labelText, x, adjustedY);

    threadCtx.restore();
}

// ç»˜åˆ¶æ‰€æœ‰çº¿ç´¢
function drawAllThreadConnections(root) {
    const threads = calculateThreadPaths(root);
    threads.forEach(thread => drawSingleThread(thread));
}

// ç»˜åˆ¶æ•´ä¸ªçº¿ç´¢äºŒå‰æ ‘ - çº¿ç´¢ç½®äºæœ€é¡¶å±‚
function drawThreadTree(root) {
    threadCtx.clearRect(0, 0, threadCanvas.width, threadCanvas.height);

    // ç¬¬ä¸€å±‚ï¼šç»˜åˆ¶æ™®é€šè¿æ¥çº¿
    function drawConnections(node) {
        if (node.left && !node.leftTag) {
            drawNormalConnection(node, node.left);
            drawConnections(node.left);
        }
        if (node.right && !node.rightTag) {
            drawNormalConnection(node, node.right);
            drawConnections(node.right);
        }
    }

    drawConnections(root);

    // ç¬¬äºŒå±‚ï¼šç»˜åˆ¶èŠ‚ç‚¹ï¼ˆä¸­é—´å±‚ï¼‰
    function drawNodes(node) {
        if (node) {
            drawThreadNode(node);
            if (!node.leftTag) drawNodes(node.left);
            if (!node.rightTag) drawNodes(node.right);
        }
    }

    drawNodes(root);

    // ç¬¬ä¸‰å±‚ï¼ˆæœ€é¡¶å±‚ï¼‰ï¼šç»˜åˆ¶çº¿ç´¢è¿æ¥ï¼Œç¡®ä¿åœ¨æœ€ä¸Šæ–¹æ˜¾ç¤º
    drawAllThreadConnections(root);
}

// é‡ç½®æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€
function resetThreadNodeStates(root) {
    if (root) {
        root.visited = false;
        root.current = false;
        root.threaded = false;
        root.leftTag = false;
        root.rightTag = false;
        resetThreadNodeStates(root.left);
        resetThreadNodeStates(root.right);
    }
}

// ç¡çœ å‡½æ•°
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
function updateThreadDisplay(action, info) {
    document.getElementById('threadCurrentAction').textContent = action;
    document.getElementById('threadStepInfo').textContent = info;
}

// æ›´æ–°éå†åºåˆ—æ˜¾ç¤º
function updateThreadSequence() {
    document.getElementById('threadSequence').textContent = threadAnimationState.sequence.join(' â†’ ');
}

// ä¸­åºçº¿ç´¢åŒ–è¿‡ç¨‹
async function inorderThreading(node) {
    if (!node || !threadAnimationState.isAnimating) return;

    // 1. é€’å½’å¤„ç†å·¦å­æ ‘
    if (node.left) {
        await inorderThreading(node.left);
    }

    if (!threadAnimationState.isAnimating) return;

    // 2. å¤„ç†å½“å‰èŠ‚ç‚¹
    node.current = true;
    updateThreadDisplay(`æ­£åœ¨å¤„ç†èŠ‚ç‚¹: ${node.val}`, 'æ£€æŸ¥æ˜¯å¦éœ€è¦å»ºç«‹çº¿ç´¢');
    drawThreadTree(threadTree);
    await sleep(800);

    // 3. å»ºç«‹å‰é©±çº¿ç´¢
    if (!node.left) {
        node.leftTag = true;
        node.left = threadAnimationState.pre;
        updateThreadDisplay(`ä¸ºèŠ‚ç‚¹ ${node.val} å»ºç«‹å‰é©±çº¿ç´¢`, threadAnimationState.pre ? `å‰é©±: ${threadAnimationState.pre.val}` : 'æ— å‰é©±');
        drawThreadTree(threadTree);
        await sleep(600);
    }

    // 4. å»ºç«‹åç»§çº¿ç´¢
    if (threadAnimationState.pre && !threadAnimationState.pre.right) {
        threadAnimationState.pre.rightTag = true;
        threadAnimationState.pre.right = node;
        updateThreadDisplay(`ä¸ºå‰é©±èŠ‚ç‚¹å»ºç«‹åç»§çº¿ç´¢`, `${threadAnimationState.pre.val} â†’ ${node.val}`);
        drawThreadTree(threadTree);
        await sleep(600);
    }

    // 5. æ›´æ–°å‰é©±èŠ‚ç‚¹
    threadAnimationState.pre = node;
    node.current = false;
    node.threaded = true;
    drawThreadTree(threadTree);
    await sleep(400);

    // 6. é€’å½’å¤„ç†å³å­æ ‘
    if (node.right && !node.rightTag) {
        await inorderThreading(node.right);
    }
}

// å¼€å§‹çº¿ç´¢åŒ–
async function startThreading() {
    if (threadAnimationState.isAnimating) return;

    resetThreadDemo();
    threadAnimationState.isAnimating = true;
    threadAnimationState.currentOperation = 'threading';
    threadAnimationState.pre = null;

    document.getElementById('threadStatus').textContent = 'æ­£åœ¨æ‰§è¡Œçº¿ç´¢åŒ–...';

    try {
        await inorderThreading(threadTree);

        if (threadAnimationState.isAnimating) {
            document.getElementById('threadStatus').textContent = 'çº¿ç´¢åŒ–å®Œæˆï¼';
            updateThreadDisplay('çº¿ç´¢åŒ–å®Œæˆ', 'æ‰€æœ‰ç©ºæŒ‡é’ˆåŸŸå·²å»ºç«‹çº¿ç´¢');
        }
    } catch (error) {
        console.error('çº¿ç´¢åŒ–è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
    }

    threadAnimationState.isAnimating = false;
}

// æ‰¾åˆ°ä¸­åºéå†çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹
function findFirstNode(root) {
    let p = root;
    while (p && !p.leftTag) {
        p = p.left;
    }
    return p;
}

// æ‰¾åˆ°èŠ‚ç‚¹çš„ä¸­åºåç»§
function findSuccessor(node) {
    if (node.rightTag) {
        return node.right;  // å³æŒ‡é’ˆæ˜¯çº¿ç´¢ï¼Œç›´æ¥è¿”å›åç»§
    } else {
        // å³æŒ‡é’ˆæŒ‡å‘å­æ ‘ï¼Œæ‰¾åˆ°å³å­æ ‘çš„æœ€å·¦èŠ‚ç‚¹
        let p = node.right;
        while (p && !p.leftTag) {
            p = p.left;
        }
        return p;
    }
}

// çº¿ç´¢éå†
async function startThreadTraversal() {
    if (threadAnimationState.isAnimating) return;

    threadAnimationState.isAnimating = true;
    threadAnimationState.currentOperation = 'traversal';
    threadAnimationState.sequence = [];

    document.getElementById('threadStatus').textContent = 'æ­£åœ¨æ‰§è¡Œçº¿ç´¢éå†...';

    try {
        let p = findFirstNode(threadTree);

        while (p && threadAnimationState.isAnimating) {
            // è®¿é—®å½“å‰èŠ‚ç‚¹
            p.current = true;
            updateThreadDisplay(`è®¿é—®èŠ‚ç‚¹: ${p.val}`, 'çº¿ç´¢éå†ä¸­...');
            drawThreadTree(threadTree);
            await sleep(800);

            // è®°å½•è®¿é—®ç»“æœ
            threadAnimationState.sequence.push(p.val);
            updateThreadSequence();
            p.visited = true;
            p.current = false;
            drawThreadTree(threadTree);
            await sleep(400);

            // æ‰¾åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹
            p = findSuccessor(p);
        }

        if (threadAnimationState.isAnimating) {
            document.getElementById('threadStatus').textContent = 'çº¿ç´¢éå†å®Œæˆï¼';
            updateThreadDisplay('çº¿ç´¢éå†å®Œæˆ', `éå†åºåˆ—: ${threadAnimationState.sequence.join(' â†’ ')}`);
        }
    } catch (error) {
        console.error('çº¿ç´¢éå†è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
    }

    threadAnimationState.isAnimating = false;
}

// åˆ‡æ¢çº¿ç´¢æ˜¾ç¤º/éšè—
function toggleThreadsVisibility() {
    threadAnimationState.threadsVisible = !threadAnimationState.threadsVisible;
    const button = document.querySelector('.toggle-threads-btn');
    if (threadAnimationState.threadsVisible) {
        button.textContent = 'ğŸ‘ï¸ éšè—çº¿ç´¢';
        updateThreadDisplay('æ˜¾ç¤ºçº¿ç´¢', 'æ¸å˜é€æ˜æ›²çº¿ç½®äºé¡¶å±‚ï¼Œå‰é©±å‘ä¸Šè“ï¼Œåç»§å‘ä¸‹çº¢');
    } else {
        button.textContent = 'ğŸ‘€ æ˜¾ç¤ºçº¿ç´¢';
        updateThreadDisplay('éšè—çº¿ç´¢', 'åªæ˜¾ç¤ºæ­£å¸¸çš„æ ‘ç»“æ„è¿æ¥');
    }
    drawThreadTree(threadTree);
}

// é‡ç½®æ¼”ç¤º
function resetThreadDemo() {
    threadAnimationState.isAnimating = false;
    threadAnimationState.sequence = [];
    threadAnimationState.pre = null;

    // é‡æ–°åˆ›å»ºæ ‘
    threadTree = createSampleThreadTree();
    resetThreadNodeStates(threadTree);
    drawThreadTree(threadTree);

    document.getElementById('threadSequence').textContent = '';
    document.getElementById('threadStatus').textContent = 'ç‚¹å‡»æŒ‰é’®å¼€å§‹æ¼”ç¤º';
    updateThreadDisplay('ç­‰å¾…å¼€å§‹...', 'é€‰æ‹©æ“ä½œç±»å‹');

    // é‡ç½®æŒ‰é’®æ–‡æœ¬
    document.querySelector('.toggle-threads-btn').textContent = 'ğŸ‘ï¸ æ˜¾ç¤º/éšè—çº¿ç´¢';
}

// ä»£ç ç›¸å…³åŠŸèƒ½
function showCode(language) {
    // éšè—æ‰€æœ‰ä»£ç å—
    const codeContents = document.querySelectorAll('.code-content');
    codeContents.forEach(content => content.classList.remove('active'));

    // ç§»é™¤æ‰€æœ‰tabçš„activeçŠ¶æ€
    const tabs = document.querySelectorAll('.tab-btn');
    tabs.forEach(tab => tab.classList.remove('active'));

    // æ˜¾ç¤ºé€‰ä¸­çš„ä»£ç å—
    document.getElementById(`${language}-code`).classList.add('active');

    // æ·»åŠ activeçŠ¶æ€åˆ°ç‚¹å‡»çš„tab
    event.target.classList.add('active');
}

// ä¿®å¤åçš„ä»£ç å¤åˆ¶åŠŸèƒ½
function copyCode(language, buttonElement) {
    // ç¡®ä¿æ­£ç¡®è·å–æŒ‰é’®å…ƒç´ 
    let button = buttonElement;
    if (!button) {
        button = event ? event.target : null;
    }

    if (!button) {
        console.error('æ— æ³•è·å–æŒ‰é’®å…ƒç´ ');
        return;
    }

    const codeElement = document.getElementById(`${language}-source`);

    if (!codeElement) {
        console.error(`æ‰¾ä¸åˆ°ä»£ç å…ƒç´ : ${language}-source`);
        showCopyError(button);
        return;
    }

    const text = codeElement.textContent || codeElement.innerText;
    const cleanText = text.trim();

    if (!cleanText) {
        console.error('ä»£ç å†…å®¹ä¸ºç©º');
        showCopyError(button);
        return;
    }

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(cleanText).then(() => {
            showCopySuccess(button);
        }).catch(err => {
            console.error('ç°ä»£APIå¤åˆ¶å¤±è´¥:', err);
            fallbackCopyTextToClipboard(cleanText, button);
        });
    } else {
        fallbackCopyTextToClipboard(cleanText, button);
    }
}

function fallbackCopyTextToClipboard(text, button) {
    const textArea = document.createElement("textarea");
    textArea.value = text;

    textArea.style.position = "fixed";
    textArea.style.top = "-1000px";
    textArea.style.left = "-1000px";
    textArea.style.width = "1px";
    textArea.style.height = "1px";
    textArea.style.padding = "0";
    textArea.style.border = "none";
    textArea.style.outline = "none";
    textArea.style.boxShadow = "none";
    textArea.style.background = "transparent";

    document.body.appendChild(textArea);

    try {
        textArea.focus();
        textArea.select();
        textArea.setSelectionRange(0, text.length);

        const successful = document.execCommand('copy');

        if (successful) {
            showCopySuccess(button);
        } else {
            console.error('execCommandå¤åˆ¶å¤±è´¥');
            showCopyError(button);
        }
    } catch (err) {
        console.error('é™çº§å¤åˆ¶æ–¹æ³•å‡ºé”™:', err);
        showCopyError(button);
    } finally {
        document.body.removeChild(textArea);
    }
}

function showCopySuccess(button) {
    if (!button) return;

    const originalText = button.innerHTML;
    const originalClass = button.className;

    button.innerHTML = 'âœ… å·²å¤åˆ¶';
    button.className = originalClass + ' copy-success';
    button.disabled = true;

    const originalStyle = button.style.cssText;
    button.style.cssText = originalStyle + '; background: #22c55e !important; color: white !important;';

    setTimeout(() => {
        button.innerHTML = originalText;
        button.className = originalClass;
        button.disabled = false;
        button.style.cssText = originalStyle;
    }, 2000);
}

function showCopyError(button) {
    if (!button) return;

    const originalText = button.innerHTML;
    const originalClass = button.className;

    button.innerHTML = 'âŒ å¤åˆ¶å¤±è´¥';
    button.className = originalClass + ' copy-error';
    button.disabled = true;

    const originalStyle = button.style.cssText;
    button.style.cssText = originalStyle + '; background: #ef4444 !important; color: white !important;';

    setTimeout(() => {
        button.innerHTML = originalText;
        button.className = originalClass;
        button.disabled = false;
        button.style.cssText = originalStyle;
    }, 2000);
}

// æµ‹éªŒåŠŸèƒ½
function toggleAnswer(questionNumber) {
    const answer = document.getElementById(`answer${questionNumber}`);
    const button = event.target;

    if (answer.classList.contains('show')) {
        answer.classList.remove('show');
        button.textContent = 'ç‚¹å‡»æŸ¥çœ‹ç­”æ¡ˆ';
    } else {
        answer.classList.add('show');
        button.textContent = 'éšè—ç­”æ¡ˆ';
    }
}

// åˆå§‹åŒ–
drawThreadTree(threadTree);
</script>

{% endblock %}