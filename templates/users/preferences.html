{% extends 'knowledge_app/base.html' %}

{% block title %}偏好设置 - 计算机科学学习平台{% endblock %}

{% block extra_css %}
<style>.preferences-container {max-width:900px;margin:0 auto;padding:30px 25px;min-height:100vh;position:relative;z-index:1}.page-header {background:rgba(255, 255, 255, 0.1);backdrop-filter:blur(15px);border-radius:var(--border-radius-lg);padding:35px;margin-bottom:35px;color:var(--text-inverse);text-align:center;position:relative;z-index:2}.page-title {font-size:2.5rem;font-weight:700;margin-bottom:10px}.settings-grid {display:grid;grid-template-columns:1fr 1fr;gap:25px;margin-bottom:30px}.settings-card {background:var(--bg-card);border-radius:var(--border-radius-lg);padding:35px;box-shadow:var(--shadow-md);border:1px solid rgba(255, 255, 255, 0.2);transition:all 0.3s ease;margin-bottom:25px}.settings-card:hover {transform:translateY(-5px);box-shadow:var(--shadow-md)}.card-header {display:flex;align-items:center;gap:12px;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #f0f0f0}.card-icon {font-size:1.8rem}.card-title {font-size:1.4rem;font-weight:600;color:var(--text-primary);margin:0}.form-group {margin-bottom:25px}.form-label {display:block;margin-bottom:10px;color:var(--text-primary);font-weight:600;font-size:1rem}.form-control {width:100%;padding:12px 16px;border:2px solid #e1e5e9;border-radius:var(--border-radius);font-size:1rem;transition:all 0.3s ease;background:var(--bg-card);box-sizing:border-box}.form-control:focus {outline:none;border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(78, 205, 196, 0.1)}.form-check {display:flex;align-items:center;gap:12px;padding:15px;background:#f8f9fa;border-radius:var(--border-radius);transition:all 0.3s ease;cursor:pointer}.form-check:hover {background:#e9ecef}.form-check-input {width:20px;height:20px;accent-color:var(--accent-color)}.form-check-label {font-size:1rem;color:var(--text-primary);cursor:pointer;flex:1}.form-help {font-size:0.85rem;color:#666;margin-top:8px;line-height:1.4}.password-section {grid-column:1 / -1;background:linear-gradient(135deg, #fff5f5 0%, #fff 100%);border:2px solid #ffe6e6}.password-form {display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-top:20px}.password-strength {margin-top:10px}.strength-bar {height:4px;background:#f0f0f0;border-radius:2px;overflow:hidden;margin-bottom:5px}.strength-fill {height:100%;transition:all 0.3s ease;border-radius:2px}.strength-weak {background:#dc3545;width:25%}.strength-fair {background:#ffc107;width:50%}.strength-good {background:#28a745;width:75%}.strength-strong {background:var(--accent-color);width:100%}.strength-text {font-size:0.8rem;font-weight:600}.action-buttons {display:flex;gap:15px;justify-content:center;margin-top:40px;flex-wrap:wrap}.btn {padding:12px 30px;border-radius:var(--border-radius);text-decoration:none;font-weight:600;transition:all 0.3s ease;border:none;cursor:pointer;font-size:1rem;min-width:120px}.btn-primary {background:linear-gradient(135deg, var(--accent-color) 0%, #44a08d 100%);color:var(--text-inverse)}.btn-primary:hover {transform:translateY(-2px);box-shadow:0 8px 25px rgba(78, 205, 196, 0.3)}.btn-secondary {background:#f8f9fa;color:var(--text-primary);border:1px solid #ddd}.btn-secondary:hover {background:#e9ecef;transform:translateY(-2px)}.btn-danger {background:linear-gradient(135deg, #dc3545 0%, #c82333 100%);color:var(--text-inverse)}.btn-danger:hover {transform:translateY(-2px);box-shadow:0 8px 25px rgba(220, 53, 69, 0.3)}.danger-zone {grid-column:1 / -1;background:linear-gradient(135deg, #fff5f5 0%, #fff 100%);border:2px solid #ffe6e6;margin-top:30px}.danger-zone .card-title {color:#dc3545}.danger-actions {display:flex;gap:15px;margin-top:20px}@media (max-width:768px) {.preferences-container {padding:20px 15px}.settings-grid {grid-template-columns:1fr;gap:20px}.password-form {grid-template-columns:1fr}.settings-card {padding:25px}.action-buttons {flex-direction:column;align-items:center}.btn {width:100%;max-width:250px}}</style>
{% endblock %}

{% block content %}
<div class="preferences-container"><!-- 页面头部 --><div class="page-header"><h1 class="page-title">⚙️ 偏好设置</h1><p>个性化您的学习体验</p></div><!-- 设置表单 --><form method="post" id="preferences-form">
        {% csrf_token %}

        <div class="settings-grid"><!-- 用户偏好设置 --><div class="settings-card"><div class="card-header"><span class="card-icon">🌐</span><h3 class="card-title">界面偏好</h3></div><div class="form-group"><label for="{{ user_form.preferred_language.id_for_label }}" class="form-label">首选语言</label>
                    {{ user_form.preferred_language }}
                    <div class="form-help">选择您的首选界面语言</div></div><div class="form-group"><div class="form-check">
                        {{ user_form.email_notifications }}
                        <label for="{{ user_form.email_notifications.id_for_label }}" class="form-check-label">
                            接收邮件通知
                        </label></div><div class="form-help">包括学习提醒、成就通知等</div></div></div><!-- 学习设置 --><div class="settings-card"><div class="card-header"><span class="card-icon">📚</span><h3 class="card-title">学习设置</h3></div><div class="form-group"><label for="{{ profile_form.study_goal.id_for_label }}" class="form-label">学习目标</label>
                    {{ profile_form.study_goal }}
                    <div class="form-help">选择您的主要学习目标</div></div><div class="form-group"><label for="{{ profile_form.daily_study_goal.id_for_label }}" class="form-label">每日学习目标</label><div style="display: flex; align-items: center; gap: 10px;">
                        {{ profile_form.daily_study_goal }}
                        <span style="color: #666;">分钟</span></div><div class="form-help">设置每日学习时间目标（5-480分钟）</div></div></div><!-- 密码修改 --><div class="settings-card password-section"><div class="card-header"><span class="card-icon">🔒</span><h3 class="card-title">安全设置</h3></div><div class="password-form"><div class="form-group"><label class="form-label">当前密码</label><input type="password" name="current_password" class="form-control" id="current-password"></div><div class="form-group"><label class="form-label">新密码</label><input type="password" name="new_password1" class="form-control" id="new-password"><div class="password-strength"><div class="strength-bar"><div class="strength-fill" id="strength-fill"></div></div><div class="strength-text" id="strength-text">请输入新密码</div></div></div><div class="form-group"><label class="form-label">确认新密码</label><input type="password" name="new_password2" class="form-control" id="confirm-password"><div class="form-help" id="password-match"></div></div></div><div class="action-buttons"><button type="button" class="btn btn-danger" onclick="changePassword()">
                        🔑 修改密码
                    </button></div></div><!-- 危险区域 --><div class="settings-card danger-zone"><div class="card-header"><span class="card-icon">⚠️</span><h3 class="card-title">危险操作</h3></div><p style="color: #666; margin-bottom: 20px;">
                    以下操作不可逆，请谨慎操作
                </p><div class="danger-actions"><button type="button" class="btn btn-danger" onclick="clearLearningData()">
                        🗑️ 清除学习数据
                    </button><button type="button" class="btn btn-danger" onclick="deleteAccount()">
                        ❌ 删除账户
                    </button></div></div></div><!-- 主要操作按钮 --><div class="action-buttons"><button type="submit" class="btn btn-primary">
                💾 保存设置
            </button><a href="{% url 'users:profile' %}" class="btn btn-secondary">
                ↩️ 返回个人中心
            </a></div></form></div>
{% endblock %}

{% block extra_js %}
<script>document.addEventListener('DOMContentLoaded', function() { const newPasswordInput = document.getElementById('new-password'); const confirmPasswordInput = document.getElementById('confirm-password'); const strengthFill = document.getElementById('strength-fill'); const strengthText = document.getElementById('strength-text'); const passwordMatch = document.getElementById('password-match'); if (newPasswordInput) { newPasswordInput.addEventListener('input', function() { const password = this.value; const strength = calculatePasswordStrength(password); updatePasswordStrength(strength); }); } if (confirmPasswordInput) { confirmPasswordInput.addEventListener('input', function() { const newPassword = newPasswordInput.value; const confirmPassword = this.value; if (confirmPassword === '') { passwordMatch.textContent = ''; passwordMatch.style.color = ''; } else if (newPassword === confirmPassword) { passwordMatch.textContent = '✓ 密码匹配'; passwordMatch.style.color = '#28a745'; } else { passwordMatch.textContent = '✗ 密码不匹配'; passwordMatch.style.color = '#dc3545'; } }); } function calculatePasswordStrength(password) { let score = 0; if (password.length >= 8) score += 1; if (password.length >= 12) score += 1; if (/[a-z]/.test(password)) score += 1; if (/[A-Z]/.test(password)) score += 1; if (/[0-9]/.test(password)) score += 1; if (/[^A-Za-z0-9]/.test(password)) score += 1; return Math.min(score, 4); } function updatePasswordStrength(strength) { const classes = ['strength-weak', 'strength-fair', 'strength-good', 'strength-strong']; const texts = ['弱', '一般', '良好', '强']; strengthFill.className = 'strength-fill'; if (strength > 0) { strengthFill.classList.add(classes[strength - 1]); strengthText.textContent = `密码强度: ${texts[strength - 1]}`; } else { strengthText.textContent = '请输入新密码'; } } const cards = document.querySelectorAll('.settings-card'); cards.forEach((card, index) => { card.style.opacity = '0'; card.style.transform = 'translateY(20px)'; setTimeout(() => { card.style.transition = 'all 0.6s ease'; card.style.opacity = '1'; card.style.transform = 'translateY(0)'; }, index * 100); }); }); function changePassword() { const currentPassword = document.getElementById('current-password').value; const newPassword = document.getElementById('new-password').value; const confirmPassword = document.getElementById('confirm-password').value; if (!currentPassword || !newPassword || !confirmPassword) { alert('请填写完整的密码信息'); return; } if (newPassword !== confirmPassword) { alert('新密码和确认密码不匹配'); return; } if (newPassword.length < 8) { alert('新密码长度至少为8位'); return; } const formData = new FormData(); formData.append('current_password', currentPassword); formData.append('new_password1', newPassword); formData.append('new_password2', confirmPassword); formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value); fetch('{% url "users:change_password" %}', { method: 'POST', body: formData }) .then(response => { if (response.ok) { alert('密码修改成功，请重新登录'); window.location.href = '{% url "users:login" %}'; } else { alert('密码修改失败，请检查当前密码是否正确'); } }) .catch(error => { console.error('Error:', error); alert('密码修改失败，请稍后重试'); }); } function clearLearningData() { if (confirm('确定要清除所有学习数据吗？此操作不可恢复！')) { if (confirm('再次确认：这将删除您的所有学习记录、进度和成就！')) { alert('清除学习数据功能即将推出'); } } } function deleteAccount() { if (confirm('确定要删除账户吗？此操作不可恢复！')) { if (confirm('最后确认：删除账户将永久删除您的所有数据！')) { alert('删除账户功能即将推出'); } } }</script>
{% endblock %}
